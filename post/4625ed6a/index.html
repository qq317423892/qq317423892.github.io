<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#e7ddc8" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#181c27" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="/./images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/./images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/./images/favicon-16x16-next.png"><link rel="mask-icon" href="/./images/safari-pinned-tab-next.svg" color="#e7ddc8"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic%7CLong+Cang:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.xianlongok.site","root":"/","images":"/blog/images/","scheme":"Gemini","darkmode":true,"version":"8.17.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":null,"post_body":null,"coll_header":null,"sidebar":"fadeInDown"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="动态 SDF 字体 介绍 在 Unity 中， TextMeshPro 对文本使用有向距离场(Signed Distance Field, SDF) 算法，相比原本的 ttf 字体，使用了 SDF 的文本，在任意距离、缩放尺寸下，都能渲染出清晰的文本，而 ttf 则可能出现毛边，失真的情况，而且对一些文本效果：描边、阴影、外发光、内发光等，TextMeshPro 通过 Shader 实现，相比原生"><meta property="og:type" content="article"><meta property="og:title" content="动态 SDF 字体渲染方法"><meta property="og:url" content="https://www.xianlongok.site/post/4625ed6a/index.html"><meta property="og:site_name" content="十三"><meta property="og:description" content="动态 SDF 字体 介绍 在 Unity 中， TextMeshPro 对文本使用有向距离场(Signed Distance Field, SDF) 算法，相比原本的 ttf 字体，使用了 SDF 的文本，在任意距离、缩放尺寸下，都能渲染出清晰的文本，而 ttf 则可能出现毛边，失真的情况，而且对一些文本效果：描边、阴影、外发光、内发光等，TextMeshPro 通过 Shader 实现，相比原生"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/sdf_vs_ttf.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/bitmap_font.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_file_content.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_draw.gif"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_base_line.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_texture.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_gly1.svg"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_gly2.svg"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_layout_h.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_layout_v.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_ra.webp"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_aa.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_rasterisation.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/ttf_texture_1.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/sdf_dist.svg"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/sdf_exp.svg"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/sdf_effect.gif"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/smooth_func.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/8ssedt_2.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/8ssedt_1.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/8ssedt_3.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/8ssedt_4.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/aa_sdf.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/aa_sdf_1.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/aa_sdf_3.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/aa_sdf_2.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/g_s.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/g_roberts.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/g_prewitt.png"><meta property="og:image" content="https://www.xianlongok.site/images/sdf_text/g_sobel.png"><meta property="article:published_time" content="2023-07-22T09:40:21.000Z"><meta property="article:modified_time" content="2023-08-12T06:30:31.493Z"><meta property="article:author" content="小贤"><meta property="article:tag" content="-SDF, -文本渲染"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.xianlongok.site/images/sdf_text/sdf_vs_ttf.png"><link rel="canonical" href="https://www.xianlongok.site/post/4625ed6a/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.xianlongok.site/post/4625ed6a/","path":"post/4625ed6a/","title":"动态 SDF 字体渲染方法"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>动态 SDF 字体渲染方法 | 十三</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-2Y4JGXG8FG"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-2Y4JGXG8FG","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><link rel="dns-prefetch" href="https://www.xianlongok.work"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">十三</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">安心学技术</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-splotch fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fas fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-tools"><a href="/tools/" rel="section"><i class="fas fa-wrench fa-fw"></i>工具</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fas fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fas fa-book fa-fw"></i>留言板</a></li><li class="menu-item menu-item-novelai"><a href="/NovelAI/" rel="section"><i class="fas fa-tachometer fa-fw"></i>NovelAI</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8A%A8%E6%80%81-sdf-%E5%AD%97%E4%BD%93-%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">动态 SDF 字体 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E4%BD%93%E6%B8%B2%E6%9F%93%E6%96%B9%E5%BC%8F"><span class="nav-number">1.1.</span> <span class="nav-text">字体渲染方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bitmapfont"><span class="nav-number">1.1.1.</span> <span class="nav-text">BitmapFont</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#turetype-font"><span class="nav-number">1.1.2.</span> <span class="nav-text">TureType Font</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sdf-font"><span class="nav-number">1.1.3.</span> <span class="nav-text">SDF font</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sdf-%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95"><span class="nav-number">1.2.</span> <span class="nav-text">SDF 生成算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E5%80%BC%E5%8C%96%E7%AE%97%E6%B3%95"><span class="nav-number">1.2.1.</span> <span class="nav-text">二值化算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%81%B0%E5%BA%A6%E5%9B%BE"><span class="nav-number">1.2.2.</span> <span class="nav-text">灰度图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A2%AF%E5%BA%A6%E7%AE%97%E5%AD%90"><span class="nav-number">1.2.3.</span> <span class="nav-text">梯度算子</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#roberts-%E7%AE%97%E5%AD%90"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">Roberts 算子</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">3*3 模板</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.2.4.</span> <span class="nav-text">代码实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">1.3.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="小贤" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">小贤</p><div class="site-description" itemprop="description">Watch and learn, your magic is mine!</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">25</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">22</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">38</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/qq317423892" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qq317423892" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a> </span><span class="links-of-author-item"><a href="mailto:xianlongok@163.com" title="E-Mail → mailto:xianlongok@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a></span></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://scorpioq.github.io/" title="https:&#x2F;&#x2F;scorpioq.github.io&#x2F;" rel="noopener" target="_blank">ScorpioQ</a></li><li class="links-of-blogroll-item"><a href="https://www.cnblogs.com/lastkiss/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;lastkiss&#x2F;" rel="noopener" target="_blank">邪妖怪のBlog</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.xianlongok.site/post/4625ed6a/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="小贤"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="十三"><meta itemprop="description" content="Watch and learn, your magic is mine!"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="动态 SDF 字体渲染方法 | 十三"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">动态 SDF 字体渲染方法</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-07-22 17:40:21" itemprop="dateCreated datePublished" datetime="2023-07-22T17:40:21+08:00">2023-07-22</time> </span><span id="/post/4625ed6a/" class="post-meta-item leancloud_visitors" data-flag-title="动态 SDF 字体渲染方法" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/post/4625ed6a/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/post/4625ed6a/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>12k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>11 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="动态-sdf-字体-介绍">动态 SDF 字体 介绍</h1><p>在 Unity 中， TextMeshPro 对文本使用有向距离场(Signed Distance Field, SDF) 算法，相比原本的 ttf 字体，使用了 SDF 的文本，在任意距离、缩放尺寸下，都能渲染出清晰的文本，而 ttf 则可能出现毛边，失真的情况，而且对一些文本效果：描边、阴影、外发光、内发光等，TextMeshPro 通过 Shader 实现，相比原生 Text 组件通过增加顶点偏移方式，渲染效果更好，效率也更高，NeoX 引擎中也内置了 SDF 字体支持。</p><div data-align="center"><p><img data-src="/images/sdf_text/sdf_vs_ttf.png" width="50%" height="50%"></p></div><h2 id="字体渲染方式">字体渲染方式</h2><h3 id="bitmapfont">BitmapFont</h3><p>最简单的文本渲染方式是：点阵字体(Dot-matrix-fonts)也叫位图字体(Bitmap-fonts)，即将用到的字符，预先输出到一张贴图中，使用的时候再找到对应的字符的 UV，再绘制文本。</p><div data-align="center"><p><img data-src="/images/sdf_text/bitmap_font.png" width="50%" height="50%"></p></div><div class="note success"><p>这种方法的缺点也很明显：字符集、字体的样式、字号在输出完贴图后就固定了</p></div><h3 id="turetype-font">TureType Font</h3><p>另外一个就是使用 FreeType 加载矢量字体（TrueType）来渲染文本。</p><ul><li><strong>ttf</strong>：TrueType Font 是Apple公司和Microsoft公司共同推出的字体文件格式</li><li><strong>otf</strong>：OpenType Font 是 TTF 的升级版，而 OTF 是采用的是 PostScript 曲线，支持 OpenType 高级特性的更高级字体。</li><li><strong>ttc</strong>：TTC 就是几个 TTF 合成的字库，字库中的字体大部分字都一样，共享笔画数据，个别字符有差异。</li></ul><p>字体文件中存放的是每个字符绘制的样条曲线控制点，可以使用<a target="_blank" rel="noopener" href="https://opentype.js.org/glyph-inspector.html">Glyph Inspector(在线字形查看器)</a>来查看对应 ttf 文件中字符的信息：</p><div data-align="center"><p><img data-src="/images/sdf_text/ttf_file_content.png" width="80%" height="80%"></p></div><p>其中： <strong>contours</strong> 中每个 <strong>contour</strong> 都是首尾闭合的轮廓，这里 <strong>g</strong> 有两个轮廓组成（最外层的边缘，以及中间空心的 <strong>O</strong> 轮廓）。蓝色点表示边缘上的点，红色的点是样条曲线的控制点 <sup><a href="#ref-anchor-1">1</a><sup>。</sup></sup></p><ul><li>一红一蓝：绘制 2 次贝塞尔曲线</li><li>两蓝：绘制线段</li><li>两红：两个控制点的连线 与 曲线相交处（数学上可推导，该交点就是两个控制点连线的中点），会有个 隐藏曲线点，分成 两个 2次-贝塞尔曲线；（就是下面 有小数 0 .5 的 终点）</li></ul><p>下图是字符 <strong>B</strong> 通过控制点绘制的过程：</p><div data-align="center"><p><img data-src="/images/sdf_text/ttf_draw.gif" width="30%" height="30%"></p></div><p>下面是一段文本的渲染结果，蓝色的线表示每行的 x，y 轴线。</p><div data-align="center"><p><img data-src="/images/sdf_text/ttf_base_line.png" width="90%" height="90%"></p></div><p>渲染上面文本，对应字体会生成一张纹理，如下图所示：</p><div data-align="center"><p><img data-src="/images/sdf_text/ttf_texture.png" width="50%" height="50%"></p></div><div class="note success"><p>不同字号，斜体、粗体的字模光栅化后都会存储在字体贴图中，大致原理跟 Bitmap Font 类似，只是字符的贴图是通过加载矢量字体，动态增加到贴图中。</p></div><p>下图是 FreeType 加载矢量字体中一些参数，左图是横向排版，右图是竖向排版</p><div data-align="center"><p><img data-src="/images/sdf_text/ttf_gly1.svg" width="50%" height="50%"> <img data-src="/images/sdf_text/ttf_gly2.svg" width="40%" height="40%"></p></div><ul><li>XY 轴：图中粗线是 XY 轴，其中远点是渲染该字符的局部原点（横向排版是 X 轴就是基线 baseline，竖向排版时，Y 轴是 baseline）</li><li>width，height：是对应字符的长宽</li><li>bearingX，bearingY：是字符渲染时，相对原点的偏移量</li><li>advance：步进宽度，表示两个相邻字符之间的距离</li></ul><div data-align="center"><p><img data-src="/images/sdf_text/ttf_layout_h.png" width="50%" height="50%"></p></div><div data-align="center"><p><img data-src="/images/sdf_text/ttf_layout_v.png" width="20%" height="20%"></p></div><p>渲染时，需要根据文本字号，将 ttf 中的字符光栅化成对应的贴图：</p><div data-align="center"><p><img data-src="/images/sdf_text/ttf_ra.webp" width="80%" height="80%"></p></div><div class="note success"><p>左边是字体文件中的样条曲线，中间是不带抗锯齿光栅化结果，右边是带抗锯齿光栅化结果</p></div><p>光栅化的过程可以参考 <a target="_blank" rel="noopener" href="https://sites.cs.ucsb.edu/~lingqi/teaching/resources/GAMES101_Lecture_06.pdf">game101 光栅化与抗锯齿</a></p><div class="note success"><p>下图展示了光栅化的过程：上图是不带抗锯齿的版本，直接判断像素中心点是不是在三角形内 下图是抗锯齿版本，根据实际像素面积占比来计算颜色值(面积计算非常复杂，因此实际应用时会采用 MSAA，即将像素点拆分成四个小区域，分别判断这个四个小区域是不是在三角形内，来计算像素点的颜色占比)</p></div><div data-align="center"><p><img data-src="/images/sdf_text/ttf_aa.png" width="80%" height="80%"> <img data-src="/images/sdf_text/ttf_rasterisation.png" width="80%" height="80%"></p></div><h3 id="sdf-font">SDF font</h3><p>在贴图里面，不再存储纹理的像素数据，而是存储每一个点到边缘的距离：</p><div data-align="center"><p><img data-src="/images/sdf_text/ttf_texture_1.png" width="60%" height="60%"></p></div><p>这是字符 <strong>a</strong> 距离图，红色点表示边缘上的点，内部的像素点到边缘的最近距离为负值，外部的像素点到边缘最近的距离为正值。</p><div data-align="center"><p><img data-src="/images/sdf_text/sdf_dist.svg" width="100%" height="100%"></p></div><p>其中 字符 <strong>a</strong> 灰度图如下（灰度表示该像素到字符边缘的距离，下面的图是距离标准化后的结果）：</p><div data-align="center"><p><img data-src="/images/sdf_text/sdf_exp.svg" width="100%" height="100%"></p></div><p>渲染时，采样贴图，将小于 0.5 的部分设置透明，即可还原最终的文本，下图是 DistanceMark 变化时 [0-1] 的渲染情况</p><div data-align="center"><p><img data-src="/images/sdf_text/sdf_effect.gif" width="80%" height="80%"></p></div><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"Custom/SDF_Base"</span>
<span class="token punctuation">&#123;</span>
    Properties
    <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"black"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">_DistanceMark</span><span class="token punctuation">(</span><span class="token string">"Distance Mark"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
        <span class="token function">_SmoothDelta</span><span class="token punctuation">(</span><span class="token string">"Smooth Delta"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.02</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
    <span class="token punctuation">&#125;</span>


    fixed4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
    <span class="token punctuation">&#123;</span>
        fixed4 col<span class="token punctuation">;</span>
        fixed4 sdf <span class="token operator">=</span> <span class="token function">tex2D</span><span class="token punctuation">(</span>_MainTex<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> distance <span class="token operator">=</span> sdf<span class="token punctuation">.</span>a<span class="token punctuation">;</span>
        col<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span>_DistanceMark <span class="token operator">-</span> _SmoothDelta<span class="token punctuation">,</span> _DistanceMark <span class="token operator">+</span> _SmoothDelta<span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        col<span class="token punctuation">.</span>rgb <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span><span class="token function">fixed3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fixed3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> col<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> col<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="note success"><p>smooth_func:用法</p></div><div data-align="left"><p><img data-src="/images/sdf_text/smooth_func.png" width="60%" height="60%"></p></div><h2 id="sdf-生成算法">SDF 生成算法</h2><p>生成 SDF 贴图的算法有很多包含：8SSEDT(8-point Signed Sequential Euclidean Distance Transform)应该是综合速度与错误率性价比最高的。另外可选的方案还有Chamfer3x3 DT（错误率稍高，速度稍快）或者4SSEDT（速度很快，错误率偏高）。</p><h3 id="二值化算法">二值化算法</h3><p>图形区域值为 1，图形区域外颜色值为 0，对于区域内的像素点，最近距离就是找到一个值为 0 的像素点，并且距离最近，区域外的类似。</p><ul><li>暴力法：直接遍历整个图片（Width * Height），在像素附近（N<em>M）的区域内，找到该像素最近的边缘距离，复杂度（O(width </em>height * N * M)</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">find_range <span class="token operator">=</span> <span class="token number">5</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>pix_width<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>pix_height<span class="token punctuation">)</span><span class="token punctuation">:</span>
        left <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">-</span> find_range<span class="token punctuation">)</span>
        right <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>pix_width<span class="token punctuation">,</span> i <span class="token operator">+</span> find_range<span class="token punctuation">)</span>
        top <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">-</span> find_range<span class="token punctuation">)</span>
        bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>pix_height<span class="token punctuation">,</span> j <span class="token operator">+</span> find_range<span class="token punctuation">)</span>

        is_inside <span class="token operator">=</span> <span class="token punctuation">(</span>new_pic<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> dist_array<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        dist_array<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>max_int <span class="token keyword">if</span> is_inside <span class="token keyword">else</span> max_int

        <span class="token keyword">for</span> i1 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> j1 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> is_inside<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> dist_array<span class="token punctuation">[</span>i1<span class="token punctuation">,</span> j1<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                        dist <span class="token operator">=</span> <span class="token operator">-</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>i1 <span class="token operator">-</span> i<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>j1 <span class="token operator">-</span> j<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
                        dist_array<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>dist_array<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span> dist<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> dist_array<span class="token punctuation">[</span>i1<span class="token punctuation">,</span> j1<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                        dist <span class="token operator">=</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>i1 <span class="token operator">-</span> i<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>j1 <span class="token operator">-</span> j<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
                        dist_array<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>dist_array<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">,</span> dist<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>8SSEDT 算法 8SSEDT 的核心思想是：计算某一个像素的最近距离，可以通过它附近八个方向的邻近点来计算，<span class="math inline">\(x_i, y_j\)</span> 表示当前像素最近的目标点的偏移量</li></ul><div class="note success"><p>EDT：求解欧拉距离，两点距离 <span class="math inline">\(\sqrt{(x_1 - x_2)^2+(y_1-y_2)^2}\)</span> -1, 0）表示左边像素就是目标点 (1, 1) 表示右下角的像素点就是目标点</p></div><div data-align="center"><p><img data-src="/images/sdf_text/8ssedt_2.png" width="40%" height="40%"></p></div><p>如上图所示，<span class="math inline">\(x_2, y_2\)</span> 到最近点的偏移值为 <span class="math inline">\((0, 2)\)</span>，则可以得出当前点最近距离为斜边长，其他7个方向类似，求出最小距离。</p><p>事实上，对八个方向的遍历分为两个 PASS（为了确保对应方向上邻居的值已经计算完毕）</p><ul><li>PASS0：从左上角开始遍历，逐行遍历，每次计算左上方的四个方向</li><li>PASS1：从右下角开始遍历，逐行遍历，每次计算右下方的四个方向</li></ul><div data-align="center"><p><img data-src="/images/sdf_text/8ssedt_1.png" width="100%" height="100%"></p></div><div class="note success"><p>上图表示 8SSEDT，4SSEDT，以及SWDT 的扫描方式，图中的 mask 就一个 PASS，8SSEDT扫描方式会分为两个 PASS 进行(左上角 PASS0, 右下角 PASS1, 打点的方块是当前计算点，周围的黑色方块表示当前 PASS 需要计算的临近像素)，最右图是 SEDT 算法的扫描方式，在 8SSEDT 基础上多了mask 2 和 3（在PASS0 做完后增加 PASS2 对该行再扫描一次），但是为了要求得正确的欧几里得距离，这两步必须的，没有这两步会导致斜线方向上的距离计算出现误差，详细可以参考<a target="_blank" rel="noopener" href="https://pages.cs.wisc.edu/~dyer/cs766/readings/leymarie-cvgip92.pdf">论文链接</a>。</p></div><p>并且会使用两个通道 Mask，分别计算物体内到目标点距离，跟物体外到目标点的距离，每个 Mask 初始化时，会根据当前图片的灰度值，转成二值化图（灰度大于128 表示物体内，小于128 的丢弃），并初始化对应的 Mask，举个例子，下面是一个目标图，黑色表示物体内，白色表示物体外，初始化两个 Mask 如下图所示：</p><div data-align="center"><p><img data-src="/images/sdf_text/8ssedt_3.png" width="50%" height="50%"></p></div><p>Mask1 经过一次遍历后结果如下（两次遍历结合起来，就能求出所有像素当目标点的最短距离）</p><div data-align="center"><p><img data-src="/images/sdf_text/8ssedt_4.png" width="50%" height="50%"></p></div><p>最后将两次计算结果相减，即可得出最终结果 <span class="math inline">\(Mask_1 - Mask_0\)</span>。<a target="_blank" rel="noopener" href="http://www.codersnotes.com/notes/signed-distance-fields/8ssedt.zip">详细代码</a></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Point</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> dx<span class="token punctuation">,</span> dy<span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">DistSq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> dx<span class="token operator">*</span>dx <span class="token operator">+</span> dy<span class="token operator">*</span>dy<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Grid</span>
<span class="token punctuation">&#123;</span>
    Point grid<span class="token punctuation">[</span>HEIGHT<span class="token punctuation">]</span><span class="token punctuation">[</span>WIDTH<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token comment">/// 根据灰度继续二值化，并初始化两个 Mask</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> g <span class="token operator">&lt;</span> <span class="token number">128</span> <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// inside = Point(0, 0)</span>
    <span class="token comment">// empty = Point(99999999, 99999999)</span>
    <span class="token function">Put</span><span class="token punctuation">(</span> grid1<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> inside <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Put</span><span class="token punctuation">(</span> grid2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> empty <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">Put</span><span class="token punctuation">(</span> grid2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> inside <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Put</span><span class="token punctuation">(</span> grid1<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> empty <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Generate the SDF.</span>
<span class="token function">GenerateSDF</span><span class="token punctuation">(</span> grid1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">GenerateSDF</span><span class="token punctuation">(</span> grid2 <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 比较当前距离跟邻居距离</span>
<span class="token keyword">void</span> <span class="token function">Compare</span><span class="token punctuation">(</span> Grid <span class="token operator">&amp;</span>g<span class="token punctuation">,</span> Point <span class="token operator">&amp;</span>p<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> offsetx<span class="token punctuation">,</span> <span class="token keyword">int</span> offsety <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    Point other <span class="token operator">=</span> <span class="token function">Get</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> x<span class="token operator">+</span>offsetx<span class="token punctuation">,</span> y<span class="token operator">+</span>offsety <span class="token punctuation">)</span><span class="token punctuation">;</span>
    other<span class="token punctuation">.</span>dx <span class="token operator">+=</span> offsetx<span class="token punctuation">;</span>
    other<span class="token punctuation">.</span>dy <span class="token operator">+=</span> offsety<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">.</span><span class="token function">DistSq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> p<span class="token punctuation">.</span><span class="token function">DistSq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p <span class="token operator">=</span> other<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">GenerateSDF</span><span class="token punctuation">(</span> Grid <span class="token operator">&amp;</span>g <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// Pass 0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>y<span class="token operator">&lt;</span>HEIGHT<span class="token punctuation">;</span>y<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>x<span class="token operator">&lt;</span>WIDTH<span class="token punctuation">;</span>x<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            Point p <span class="token operator">=</span> <span class="token function">Get</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 左  上  左上  右上 方向</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Put</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> p <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token operator">=</span>WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>x<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span>x<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            Point p <span class="token operator">=</span> <span class="token function">Get</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Put</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> p <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Pass 1</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token operator">=</span>HEIGHT<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>y<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span>y<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token operator">=</span>WIDTH<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>x<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span>x<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            Point p <span class="token operator">=</span> <span class="token function">Get</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 右  下 左下  右下</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Put</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> p <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>x<span class="token operator">&lt;</span>WIDTH<span class="token punctuation">;</span>x<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            Point p <span class="token operator">=</span> <span class="token function">Get</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Compare</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> p<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Put</span><span class="token punctuation">(</span> g<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> p <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="灰度图">灰度图</h3><p>直接使用二值化图片生成 SDF 在图像边缘会有一些误差，详细参看<a target="_blank" rel="noopener" href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.504.7099&amp;rep=rep1&amp;type=pdf">论文链接</a>，如下图：</p><div data-align="center"><p><img data-src="/images/sdf_text/aa_sdf.png" width="100%" height="100%"></p></div><div class="note success"><p>使用二值化图，则图 c 中 B 点在计算距离时，A，C 像素灰度不够（小于0.5），会被丢弃，最终计算的距离方向是虚线箭头所示，但是真实的距离方向应该是实线箭头。</p></div><p>因此，对于边缘的像素(<span class="math inline">\(0 &lt;\)</span> 灰度 $&lt; 1 $)需要单独处理，按照论文里个方法，对边缘上的像素进行分类：</p><ul><li>边缘垂直或者平行穿过像素</li></ul><div data-align="center"><p><img data-src="/images/sdf_text/aa_sdf_1.png" width="40%" height="40%"></p></div><p><span class="math display">\[d_f = 0.5 - a\]</span></p><div class="note success"><p>其中： <span class="math inline">\(d_f\)</span>:距离 a：像素灰度值</p></div><ul><li>边缘斜着穿过像素 如下图（边缘的斜率可能不一样，但是都可以通过下面的图做旋转得到类似的结果）</li></ul><div data-align="center"><p><img data-src="/images/sdf_text/aa_sdf_3.png" width="80%" height="80%"></p></div><div class="note success"><p>灰色的地方表示目标像素灰度</p></div><p>首先定义几个常量： <span class="math inline">\(a_1\)</span>: 边缘穿过像素点左边的区域，并且经过像素最边缘的点 <span class="math inline">\(a_2\)</span>: 中间区域</p><div data-align="center"><p><img data-src="/images/sdf_text/aa_sdf_2.png" width="80%" height="80%"></p></div><p>由上图左(1) 跟 左(2) 可求出下面几个常量：</p><p><span class="math display">\[\begin{align} a_1 &amp;= tan \varphi = \frac{g_y}{g_x} \\ a_2 &amp;= 1 - 2a_1 \\ d_1 &amp;= sin \varphi = g_y \\ d_2 &amp;= \frac{1}{\sqrt{2}}sin (\frac{\pi}{4} - \varphi) = \frac{1}{\sqrt{2}}sin (\frac{\pi}{4} - arcsin(g_y)) \end{align} \]</span></p><div class="note success"><p>其中单位向量 <span class="math inline">\(\vec{g} = (g_x, g_y) = (cos \varphi, sin \varphi)\)</span></p></div><p>则斜着穿过像素的情况有如下几种</p><ul><li><span class="math inline">\(a &lt; a_1\)</span></li><li><span class="math inline">\(a_1 \leq a &lt; a_1+a_2\)</span></li><li><span class="math inline">\(a_1+a_2 \leq a &lt; 1\)</span></li></ul><p>直接引用论文中的结论：</p><p><span class="math display">\[d_f = \begin{cases} \frac{(g_x + g_y)}{2} - \sqrt{2g_xg_ya} &amp; 0 \leq a \leq a_1 \\ (0.5 - a)g_x &amp; a_1 \leq a \leq 1-a_1 \\ -\frac{(g_x + g_y)}{2} - \sqrt{2g_xg_y(1-a)} &amp; 1-a_1 \leq a \leq 1 \end{cases} \]</span></p><h3 id="梯度算子">梯度算子</h3><p>最终我们需要求出 <span class="math inline">\(\vec{g}\)</span> 就可以得出最终结果 <span class="math inline">\(d_f\)</span>，而 <span class="math inline">\(\vec{g}\)</span> 是像素边缘的梯度，论文里没有说怎么求，但是图像处理中，提供了多种梯度算子来计算边缘梯度。首先介绍下梯度：</p><p>一维连续数集上的函数的斜率公式：</p><p><span class="math display">\[f&#39;(x) = f(x + \Delta x) - f(x)\]</span></p><p>二维连续数集上函数偏导数：</p><p><span class="math display">\[ \begin{aligned} \frac{\partial f(x, y)}{\partial x} &amp;= f(x + \Delta x, y) - f(x, y) \\ \frac{\partial f(x, y)}{\partial y} &amp;= f(x, y + \Delta y) - f(x, y) \\ \end{aligned} \]</span></p><p>对于图像来说，是一个二维的离线型数集，因此推广二维连续型求函数偏导的方法，来求图像的偏导数，即在 <span class="math inline">\((x,y)\)</span> 处的最大变化率，也就是梯度。</p><p><span class="math display">\[\begin{aligned} g_x &amp;= \frac{\partial f(x, y)}{\partial x} = f(x + 1, y) - f(x,y) \\ g_y &amp;= \frac{\partial f(x, y)}{\partial x} = f(x, y + 1) - f(x,y) \\ \end{aligned} \]</span></p><blockquote><p>把图片取像素点值的操作当成函数 <span class="math inline">\(f(x,y)\)</span>，<span class="math inline">\(\Delta\)</span> 量为整数，且最小变化量为 1 个像素点</p></blockquote><p>因此</p><p><span class="math display">\[\nabla f \equiv grad(f) = [g_x, g_y]^T = \left[\frac{\partial f}{\partial x}, \frac{\partial f}{\partial y} \right]^T\]</span></p><p>最后得出的模板如下：</p><div data-align="center"><p><img data-src="/images/sdf_text/g_s.png" width="40%" height="40%"></p></div><div class="note success"><p>上面是考虑水平跟竖直方向上的梯度</p></div><h4 id="roberts-算子">Roberts 算子</h4><p>对角线方向的梯度：</p><p><span class="math display">\[\begin{aligned} g_x &amp;= \frac{\partial f(x, y)}{\partial x} = f(x + 1, y + 1) - f(x, y) \\ g_y &amp;= \frac{\partial f(x, y)}{\partial x} = f(x + 1, y) - f(x, y + 1) \\ \end{aligned} \]</span></p><div data-align="center"><p><img data-src="/images/sdf_text/g_roberts.png" width="40%" height="40%"></p></div><h4 id="模板">3*3 模板</h4><p>2<em>2 大小的模板在概念上很简单，但是他们对于用关于中心店对称的模板来计算边缘方向时，不是很有用，因此一般会使用 3 </em>3 模板</p><ul><li>Prewitt 算子 水平竖直方向以及对角线方向的 <span class="math inline">\(G_x\)</span>, <span class="math inline">\(G_y\)</span></li></ul><div data-align="center"><p><img data-src="/images/sdf_text/g_prewitt.png" width="30%" height="30%"></p></div><ul><li>Sobel 算子</li></ul><div data-align="center"><p><img data-src="/images/sdf_text/g_sobel.png" width="30%" height="30%"></p></div><ul><li>Isotropic 算子</li></ul><p><span class="math display">\[G_x = \left[ \begin{matrix} -1 \quad 0 \quad 1 \\ -\sqrt{2} \quad 0 \quad \sqrt{2} \\ -1 \quad 0 \quad 1 \end{matrix} \\ \right] * A \qquad G_y = \left[ \begin{matrix} -1 \quad -\sqrt{2} \quad -1\\ 0 \quad 0 \quad 0\\ 1 \quad \sqrt{2} \quad 1 \end{matrix} \right] * A\]</span></p><p>如果图片为 A <span class="math display">\[A=\left[ \begin{matrix} P_1 \quad P_2 \quad P_3\\ P_4 \quad P_5 \quad P_6\\ P_7 \quad P_8 \quad P_9 \end{matrix} \right]\]</span></p><p><span class="math display">\[G=\sqrt{G_x^2 + G_y^2}\]</span></p><p><span class="math display">\[ G_x = P_3-P_1+\sqrt{2}(P_6-P_4) + P_9 - P_7 \]</span> <span class="math display">\[ G_y = P_7-P_1+\sqrt{2}(P_8-P_2) + P_9 - P_3 \]</span> <span class="math display">\[ \quad\\ g_x = \frac{G_x}{G}\\ \quad\\ g_y = \frac{G_y}{G} \]</span></p><h3 id="代码实现">代码实现</h3><p>下面给出完整的 python 代码的实现</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> math
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

<span class="token keyword">def</span> <span class="token function">color_2_gray</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">:</span>
    r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    gray <span class="token operator">=</span> <span class="token number">0.2989</span> <span class="token operator">*</span> r <span class="token operator">+</span> <span class="token number">0.5870</span> <span class="token operator">*</span> g <span class="token operator">+</span> <span class="token number">0.1140</span> <span class="token operator">*</span> b
    <span class="token keyword">return</span> gray <span class="token operator">/</span> <span class="token number">255.0</span>

<span class="token comment">## 线性插值方法这里将一张 1024 * 1024 的大图，插值成 32 * 32，灰度图</span>
<span class="token comment">## 然后再计算 SDF 距离</span>
<span class="token keyword">def</span> <span class="token function">bilinear_interpolation</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> out_width<span class="token punctuation">,</span> out_height<span class="token punctuation">,</span> corner_align <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    width<span class="token punctuation">,</span> height <span class="token operator">=</span> image<span class="token punctuation">.</span>width<span class="token punctuation">,</span> image<span class="token punctuation">.</span>height
    output_image <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>out_height<span class="token punctuation">,</span> out_width<span class="token punctuation">)</span><span class="token punctuation">)</span>

    scale_x_corner <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>out_width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    scale_y_corner <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>out_height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

    scale_x <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span> <span class="token operator">/</span> out_width
    scale_y <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token operator">/</span> out_height

    <span class="token keyword">for</span> out_x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_width<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> out_y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_height<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> corner_align<span class="token punctuation">:</span>
                x <span class="token operator">=</span> out_x <span class="token operator">*</span> scale_x_corner
                y <span class="token operator">=</span> out_y <span class="token operator">*</span> scale_y_corner
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                x <span class="token operator">=</span> <span class="token punctuation">(</span>out_x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale_x <span class="token operator">-</span> <span class="token number">0.5</span>
                y <span class="token operator">=</span> <span class="token punctuation">(</span>out_y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> scale_y <span class="token operator">-</span> <span class="token number">0.5</span>
                x <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
                y <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

            x0<span class="token punctuation">,</span> y0 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
            x1<span class="token punctuation">,</span> y1 <span class="token operator">=</span> x0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y0 <span class="token operator">+</span> <span class="token number">1</span>

            <span class="token keyword">if</span> x0 <span class="token operator">==</span> width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
                x0 <span class="token operator">=</span> width <span class="token operator">-</span> <span class="token number">2</span>
                x1 <span class="token operator">=</span> width <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token keyword">if</span> y0 <span class="token operator">==</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
                y0 <span class="token operator">=</span> height <span class="token operator">-</span> <span class="token number">2</span>
                y1 <span class="token operator">=</span> height <span class="token operator">-</span> <span class="token number">1</span>

            xd <span class="token operator">=</span> x <span class="token operator">-</span> x0
            yd <span class="token operator">=</span> y <span class="token operator">-</span> y0
            p00 <span class="token operator">=</span> color_2_gray<span class="token punctuation">(</span>image<span class="token punctuation">.</span>getpixel<span class="token punctuation">(</span><span class="token punctuation">(</span>x0<span class="token punctuation">,</span> y0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            p01 <span class="token operator">=</span> color_2_gray<span class="token punctuation">(</span>image<span class="token punctuation">.</span>getpixel<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            p10 <span class="token operator">=</span> color_2_gray<span class="token punctuation">(</span>image<span class="token punctuation">.</span>getpixel<span class="token punctuation">(</span><span class="token punctuation">(</span>x0<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            p11 <span class="token operator">=</span> color_2_gray<span class="token punctuation">(</span>image<span class="token punctuation">.</span>getpixel<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            x0y <span class="token operator">=</span> p01 <span class="token operator">*</span> xd <span class="token operator">+</span> p00 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> xd<span class="token punctuation">)</span>
            x1y <span class="token operator">=</span> p11 <span class="token operator">*</span> xd <span class="token operator">+</span> p10 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> xd<span class="token punctuation">)</span>

            value <span class="token operator">=</span> x1y <span class="token operator">*</span> yd <span class="token operator">+</span> x0y <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> yd<span class="token punctuation">)</span>
            output_image<span class="token punctuation">[</span>out_y<span class="token punctuation">,</span> out_x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> value

    <span class="token keyword">return</span> output_image

<span class="token keyword">class</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>alpha <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>gx <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>gy <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>dy <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>df <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>di <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">class</span> <span class="token class-name">OctSSEDT</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>


    <span class="token comment">## img 是一张 1024 * 1024 的字体图</span>
    <span class="token keyword">def</span> <span class="token function">calc3_3AAEDT</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">,</span> pix_per_pix<span class="token punctuation">)</span><span class="token punctuation">:</span>
        width <span class="token operator">=</span> img<span class="token punctuation">.</span>width
        height <span class="token operator">=</span> img<span class="token punctuation">.</span>height

        out_width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>width <span class="token operator">/</span> pix_per_pix<span class="token punctuation">)</span>
        out_height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>height <span class="token operator">/</span> pix_per_pix<span class="token punctuation">)</span>
        out_img <span class="token operator">=</span> bilinear_interpolation<span class="token punctuation">(</span>img<span class="token punctuation">,</span> out_width<span class="token punctuation">,</span> out_height<span class="token punctuation">)</span>
        
        value_min <span class="token operator">=</span> out_img<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_width<span class="token punctuation">)</span><span class="token punctuation">:</span>
            out_img<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> value_min
            out_img<span class="token punctuation">[</span>i<span class="token punctuation">,</span> out_width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> value_min

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_height<span class="token punctuation">)</span><span class="token punctuation">:</span>
            out_img<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> value_min
            out_img<span class="token punctuation">[</span>out_height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> value_min

        value_max <span class="token operator">=</span> out_img<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        value_min <span class="token operator">=</span> out_img<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_height<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_width<span class="token punctuation">)</span><span class="token punctuation">:</span>
                color <span class="token operator">=</span> out_img<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span>
                color <span class="token operator">=</span> <span class="token punctuation">(</span>color <span class="token operator">-</span> value_min<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>value_max <span class="token operator">-</span> value_min<span class="token punctuation">)</span>
                <span class="token keyword">if</span> color <span class="token operator">&lt;</span> <span class="token number">1e-5</span><span class="token punctuation">:</span>
                    color <span class="token operator">=</span> <span class="token number">0</span>

                <span class="token keyword">if</span> color <span class="token operator">></span> <span class="token number">0.99999</span><span class="token punctuation">:</span>
                    color <span class="token operator">=</span> <span class="token number">1</span>

                out_img<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> color

        out_dist <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        in_dist <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

        self<span class="token punctuation">.</span>img <span class="token operator">=</span> out_img
        self<span class="token punctuation">.</span>generate_sdf<span class="token punctuation">(</span>in_dist<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>generate_sdf<span class="token punctuation">(</span>out_dist<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        scale <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_height<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_width<span class="token punctuation">)</span><span class="token punctuation">:</span>
                p0 <span class="token operator">=</span> in_dist<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">]</span>
                p1 <span class="token operator">=</span> out_dist<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">]</span>

                d0 <span class="token operator">=</span> p0<span class="token punctuation">.</span>distance
                d1 <span class="token operator">=</span> p1<span class="token punctuation">.</span>distance
                df0 <span class="token operator">=</span> p0<span class="token punctuation">.</span>df
                df1 <span class="token operator">=</span> p1<span class="token punctuation">.</span>df

                <span class="token comment"># out_img[i, j] = math.sqrt(p1.di) - math.sqrt(p0.di)</span>

                <span class="token keyword">if</span> d0 <span class="token operator">&lt;</span> d1<span class="token punctuation">:</span>
                    d1 <span class="token operator">=</span>  math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>p1<span class="token punctuation">.</span>di<span class="token punctuation">)</span> <span class="token operator">+</span> p1<span class="token punctuation">.</span>df
                    d <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">127.5</span><span class="token punctuation">,</span> d1 <span class="token operator">*</span> scale<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    out_img<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">127.5</span> <span class="token operator">-</span> d <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255</span>

                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    d0 <span class="token operator">=</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>p0<span class="token punctuation">.</span>di<span class="token punctuation">)</span> <span class="token operator">+</span> p0<span class="token punctuation">.</span>df
                    d <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">127.5</span><span class="token punctuation">,</span> d0 <span class="token operator">*</span> scale<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    out_img<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">127.5</span> <span class="token operator">+</span> d <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255</span>

        <span class="token keyword">return</span> out_img

    <span class="token comment">## 应用 Isotropic 算子</span>
    <span class="token keyword">def</span> <span class="token function">calc_edge_gradient</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index_x<span class="token punctuation">,</span> index_y<span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>img
        width<span class="token punctuation">,</span> height <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        gx <span class="token operator">=</span> <span class="token number">0</span>
        gy <span class="token operator">=</span> <span class="token number">0</span>

        sqrt2 <span class="token operator">=</span> <span class="token number">1.41421356</span>
        gxy_offset <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
        gx_matrix <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token operator">-</span>sqrt2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sqrt2<span class="token punctuation">,</span>
            <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
        gy_matrix <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span>sqrt2<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">1</span><span class="token punctuation">,</span> sqrt2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            offset <span class="token operator">=</span> gxy_offset<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            x <span class="token operator">=</span> index_x <span class="token operator">+</span> offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            y <span class="token operator">=</span> index_y <span class="token operator">+</span> offset<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> x <span class="token operator">>=</span> width <span class="token keyword">or</span> y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> y <span class="token operator">>=</span> height<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            img_value <span class="token operator">=</span> img<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span>
            gx_m <span class="token operator">=</span> gx_matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            gy_m <span class="token operator">=</span> gy_matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            gx <span class="token operator">+=</span> gx_m <span class="token operator">*</span> img_value
            gy <span class="token operator">+=</span> gy_m <span class="token operator">*</span> img_value

        g <span class="token operator">=</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>gx <span class="token operator">*</span> gx <span class="token operator">+</span> gy <span class="token operator">*</span> gy<span class="token punctuation">)</span>
        <span class="token keyword">if</span> g <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            gx <span class="token operator">/=</span> g
            gy <span class="token operator">/=</span> g
            point<span class="token punctuation">.</span>gx <span class="token operator">=</span> gx
            point<span class="token punctuation">.</span>gy <span class="token operator">=</span> gy

    <span class="token comment">## 计算边缘像素的距离（论文中的方法）</span>
    <span class="token keyword">def</span> <span class="token function">calcEdgeDistance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gx<span class="token punctuation">,</span> gy<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>img
        width<span class="token punctuation">,</span> height <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        df <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> gx <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> gy <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">0.5</span> <span class="token operator">-</span> a
        
        g <span class="token operator">=</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>gx <span class="token operator">*</span> gx <span class="token operator">+</span> gy <span class="token operator">*</span> gy<span class="token punctuation">)</span>
        gx <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>gx <span class="token operator">/</span> g<span class="token punctuation">)</span>
        gy <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>gy <span class="token operator">/</span> g<span class="token punctuation">)</span>

        <span class="token keyword">if</span> gx <span class="token operator">&lt;</span> gy<span class="token punctuation">:</span>
            t <span class="token operator">=</span> gx
            gx <span class="token operator">=</span> gy
            gy <span class="token operator">=</span> t

        a1 <span class="token operator">=</span> gy <span class="token operator">/</span> gx
        <span class="token keyword">if</span> a <span class="token operator">>=</span> <span class="token number">0</span> <span class="token keyword">and</span> a <span class="token operator">&lt;=</span> a1<span class="token punctuation">:</span>
            df <span class="token operator">=</span> <span class="token punctuation">(</span>gx <span class="token operator">+</span> gy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> gx <span class="token operator">*</span> gy <span class="token operator">*</span> a<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> a <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">-</span> a1<span class="token punctuation">:</span>
            df <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">-</span> a<span class="token punctuation">)</span> <span class="token operator">*</span> gx
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            df <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>gx <span class="token operator">+</span> gy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> gx <span class="token operator">*</span> gy <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> df

    <span class="token keyword">def</span> <span class="token function">compare_dist</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dist<span class="token punctuation">,</span> point<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> offset_x<span class="token punctuation">,</span> offset_y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>img
        width<span class="token punctuation">,</span> height <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        width<span class="token punctuation">,</span> height <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        maxDistance <span class="token operator">=</span> width <span class="token operator">*</span> width <span class="token operator">+</span> height <span class="token operator">*</span> height
        <span class="token keyword">if</span> x <span class="token operator">+</span> offset_x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> x <span class="token operator">+</span> offset_x <span class="token operator">>=</span> width 
            <span class="token keyword">or</span> y <span class="token operator">+</span> offset_y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> y <span class="token operator">+</span> offset_y <span class="token operator">>=</span> height<span class="token punctuation">:</span>
            <span class="token keyword">return</span>

        other <span class="token operator">=</span> dist<span class="token punctuation">[</span><span class="token punctuation">(</span>x <span class="token operator">+</span> offset_x<span class="token punctuation">,</span> y <span class="token operator">+</span> offset_y<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> other<span class="token punctuation">.</span>distance <span class="token operator">==</span> maxDistance<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        
        dx <span class="token operator">=</span> other<span class="token punctuation">.</span>dx <span class="token operator">+</span> offset_x
        dy <span class="token operator">=</span> other<span class="token punctuation">.</span>dy <span class="token operator">+</span> offset_y
        alpha <span class="token operator">=</span> dist<span class="token punctuation">[</span>x <span class="token operator">+</span> dx<span class="token punctuation">,</span> y <span class="token operator">+</span> dy<span class="token punctuation">]</span><span class="token punctuation">.</span>alpha
        df <span class="token operator">=</span> self<span class="token punctuation">.</span>calcEdgeDistance<span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span>
        di <span class="token operator">=</span> dx <span class="token operator">*</span> dx <span class="token operator">+</span> dy <span class="token operator">*</span> dy
        distance <span class="token operator">=</span> di <span class="token operator">+</span> df
        <span class="token keyword">if</span> distance <span class="token operator">&lt;</span> point<span class="token punctuation">.</span>distance<span class="token punctuation">:</span>
            point<span class="token punctuation">.</span>distance <span class="token operator">=</span> distance
            point<span class="token punctuation">.</span>dx <span class="token operator">=</span> dx
            point<span class="token punctuation">.</span>dy <span class="token operator">=</span> dy
            point<span class="token punctuation">.</span>df <span class="token operator">=</span> df
            point<span class="token punctuation">.</span>di <span class="token operator">=</span> di

    <span class="token comment">## 8ssedt</span>
    <span class="token keyword">def</span> <span class="token function">generate_sdf</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dist<span class="token punctuation">,</span> mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> self<span class="token punctuation">.</span>img
        width<span class="token punctuation">,</span> height <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        maxDistance <span class="token operator">=</span> width <span class="token operator">*</span> width <span class="token operator">+</span> height <span class="token operator">*</span> height

        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">:</span>
                color <span class="token operator">=</span> img<span class="token punctuation">[</span>i<span class="token punctuation">,</span> j<span class="token punctuation">]</span>
                point <span class="token operator">=</span> Point<span class="token punctuation">(</span><span class="token punctuation">)</span>
                point<span class="token punctuation">.</span>alpha <span class="token operator">=</span> color <span class="token keyword">if</span> mask <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">1</span> <span class="token operator">-</span> color
                dist<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> point

                <span class="token keyword">if</span> point<span class="token punctuation">.</span>alpha <span class="token operator">></span> <span class="token number">0.001</span> <span class="token keyword">and</span> point<span class="token punctuation">.</span>alpha <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>calc_edge_gradient<span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> point<span class="token punctuation">)</span>
                    df <span class="token operator">=</span> self<span class="token punctuation">.</span>calcEdgeDistance<span class="token punctuation">(</span>point<span class="token punctuation">.</span>gx<span class="token punctuation">,</span> point<span class="token punctuation">.</span>gy<span class="token punctuation">,</span> point<span class="token punctuation">.</span>alpha<span class="token punctuation">)</span>
                    point<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token number">0</span>
                    point<span class="token punctuation">.</span>dy <span class="token operator">=</span> <span class="token number">0</span>
                    point<span class="token punctuation">.</span>df <span class="token operator">=</span> df
                    point<span class="token punctuation">.</span>di <span class="token operator">=</span> <span class="token number">0</span>
                    point<span class="token punctuation">.</span>distance <span class="token operator">=</span> df
                    <span class="token keyword">continue</span>

                <span class="token keyword">elif</span> point<span class="token punctuation">.</span>alpha <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    point<span class="token punctuation">.</span>df <span class="token operator">=</span> <span class="token number">0</span>
                    point<span class="token punctuation">.</span>di <span class="token operator">=</span> maxDistance
                    point<span class="token punctuation">.</span>distance <span class="token operator">=</span> maxDistance
                <span class="token keyword">elif</span> point<span class="token punctuation">.</span>alpha <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    point<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token number">0</span>
                    point<span class="token punctuation">.</span>dy <span class="token operator">=</span> <span class="token number">0</span>
                    point<span class="token punctuation">.</span>df <span class="token operator">=</span> <span class="token number">0</span>
                    point<span class="token punctuation">.</span>di <span class="token operator">=</span> <span class="token number">0</span>
                    point<span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token number">0</span>
                    <span class="token keyword">continue</span>

                self<span class="token punctuation">.</span>compare_dist<span class="token punctuation">(</span>dist<span class="token punctuation">,</span> point<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>compare_dist<span class="token punctuation">(</span>dist<span class="token punctuation">,</span> point<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>compare_dist<span class="token punctuation">(</span>dist<span class="token punctuation">,</span> point<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>compare_dist<span class="token punctuation">(</span>dist<span class="token punctuation">,</span> point<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                point <span class="token operator">=</span> dist<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">]</span>
                
                <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span>alpha <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">and</span> point<span class="token punctuation">.</span>alpha <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">or</span> point<span class="token punctuation">.</span>distance <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>

                self<span class="token punctuation">.</span>compare_dist<span class="token punctuation">(</span>dist<span class="token punctuation">,</span> point<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>compare_dist<span class="token punctuation">(</span>dist<span class="token punctuation">,</span> point<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>compare_dist<span class="token punctuation">(</span>dist<span class="token punctuation">,</span> point<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>compare_dist<span class="token punctuation">(</span>dist<span class="token punctuation">,</span> point<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考">参考</h2><div id="ref-anchor-1"></div><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/610796157">1.字体：从 TTF 到 位图</a></p><p><a target="_blank" rel="noopener" href="http://mot.ttthyy.com/424.html">2.关于TextMeshPro</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/258069156">3. 动态 SDF 字体实现要点</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/487044802">4.UE4 Signed Distance Fields：符号距离场（一）</a></p><p><a target="_blank" rel="noopener" href="https://forum.cocos.org/t/topic/133228">5.我所理解的SDF</a></p><p><a target="_blank" rel="noopener" href="http://www.klayge.org/docs/klayge%E4%B8%AD%E7%9A%84%E5%AD%97%E4%BD%93%E7%B3%BB%E7%BB%9F/">6.KlayGE游戏引擎</a></p></div><footer class="post-footer"><div class="license"><div class="license-title">动态 SDF 字体渲染方法</div><div class="license-link"><a href="https://www.xianlongok.site/post/4625ed6a/">https://www.xianlongok.site/post/4625ed6a/</a></div><div class="license-meta"><div class="license-meta-item"><div class="license-meta-title">本文作者</div><div class="license-meta-text">小贤</div></div><div class="license-meta-item"><div class="license-meta-title">发布于</div><div class="license-meta-text">2023-07-22</div></div><div class="license-meta-item"><div class="license-meta-title">更新于</div><div class="license-meta-text">2023-08-12</div></div><div class="license-meta-item"><div class="license-meta-title">许可协议</div><div class="license-meta-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank">CC BY-NC-SA 4.0</a></div></div></div><div class="license-statement">转载或引用本文时，请遵守上述许可协议，注明出处、不得用于商业用途！</div></div><div class="post-tags"><a href="/tags/SDF-%E6%96%87%E6%9C%AC%E6%B8%B2%E6%9F%93/" rel="tag"><i class="fa fa-tag"></i> -SDF, -文本渲染</a></div><div class="post-nav"><div class="post-nav-item"><a href="/post/3725508f/" rel="prev" title="实时阴影技术"><i class="fa fa-chevron-left"></i> 实时阴影技术</a></div><div class="post-nav-item"><a href="/post/54f20f49/" rel="next" title="Vercel + Waline 国内评论不可见问题修复">Vercel + Waline 国内评论不可见问题修复 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fas fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">小贤</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">267k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">4:03</span></span></div><div class="powered"><a href="https://dlzhang.com" rel="noopener" target="_blank">小贤</a>使用 <a href="https://hexo.io" rel="noopener" target="_blank">Hexo</a> <a href="https://theme-next.js.org" rel="noopener" target="_blank">NexT</a> 设计搭建</div></div></footer><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"dkLUcqHORjRdwQiwRPJMs00N-gzGzoHsz","app_key":"EhWnaex3YyY7bQysJ2SFnukE","server_url":null,"security":false}</script><script src="/js/third-party/statistics/lean-analytics.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://www.xianlongok.work","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"libUrl":"https://unpkg.com/@waline/client@v2/dist/waline.js","login":"disable","meta":["nick","mail","link"],"requiredMeta":["nick","mail"],"pageSize":5,"avatar":"mm","dark":"auto","emoji":true,"locale":{"placeholder":"请正确填写邮箱方便查收回复，评论通过审核才会显示。","admin":"站长","nick":"名称*","mail":"邮箱*","link":"网址"},"el":"#waline","comment":true,"path":"/post/4625ed6a/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>document.addEventListener("page:loaded",()=>{NexT.utils.loadComments(CONFIG.waline.el).then(()=>NexT.utils.getScript(CONFIG.waline.libUrl,{condition:window.Waline})).then(()=>Waline.init(Object.assign({},CONFIG.waline,{el:document.querySelector(CONFIG.waline.el)})))})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body></html>