<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#e7ddc8" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#181c27" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.2"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="null//null" crossorigin><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="/./images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/./images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/./images/favicon-16x16-next.png"><link rel="mask-icon" href="/./images/safari-pinned-tab-next.svg" color="#e7ddc8"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic%7CLong+Cang:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.xianlongok.site","root":"/","images":"/blog/images/","scheme":"Gemini","darkmode":true,"version":"8.11.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":null,"post_body":null,"coll_header":null,"sidebar":"fadeInDown"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="物理模拟流程 物理模拟循环主要有三个阶段构成：   * 碰撞检测（Collision Detection）  * 约束求解（Constraint Solving）  * 数值时间积分（Time Integration）    数值时间积分 欧拉公式 之前 PBD-Position Based Dynamics 中已经介绍过了，这里就不做过多介绍  韦尔莱（Verlet）积分 Verlet 积分法在"><meta property="og:type" content="article"><meta property="og:title" content="物理模拟过程简介"><meta property="og:url" content="https://www.xianlongok.site/post/4dab7192/index.html"><meta property="og:site_name" content="十三"><meta property="og:description" content="物理模拟流程 物理模拟循环主要有三个阶段构成：   * 碰撞检测（Collision Detection）  * 约束求解（Constraint Solving）  * 数值时间积分（Time Integration）    数值时间积分 欧拉公式 之前 PBD-Position Based Dynamics 中已经介绍过了，这里就不做过多介绍  韦尔莱（Verlet）积分 Verlet 积分法在"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/phy_engine.svg"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/collision_detection.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/bbox.jpg"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/bvh.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/bvh_line.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/sort_and_sweep.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/narrow_phase.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/sat.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/mink_add_0.svg"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/mink_add_1.gif"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/mink_add_2.gif"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/mink_add_3.svg"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/mink_diff.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/mink_diff_1.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/mink_diff_2.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/ground_c.gif"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/plant_c.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/position_show.gif"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/3d_c.svg"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/point_c_show.png"><meta property="og:image" content="https://www.xianlongok.site/images/phy_intro/point_show_f.gif"><meta property="article:published_time" content="2022-09-01T02:00:35.000Z"><meta property="article:modified_time" content="2022-09-02T02:29:17.523Z"><meta property="article:author" content="小贤"><meta property="article:tag" content="Unity, UE4"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.xianlongok.site/images/phy_intro/phy_engine.svg"><link rel="canonical" href="https://www.xianlongok.site/post/4dab7192/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.xianlongok.site/post/4dab7192/","path":"post/4dab7192/","title":"物理模拟过程简介"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>物理模拟过程简介 | 十三</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-228435313-1"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-228435313-1","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><link rel="dns-prefetch" href="https://waline-comment-nfec4vcyk-qq317423892.vercel.app/"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">十三</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">安心学技术</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-splotch fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fas fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-tools"><a href="/tools/" rel="section"><i class="fas fa-wrench fa-fw"></i>工具</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fas fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fas fa-book fa-fw"></i>留言板</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E6%A8%A1%E6%8B%9F%E6%B5%81%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">物理模拟流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E5%80%BC%E6%97%B6%E9%97%B4%E7%A7%AF%E5%88%86"><span class="nav-number">2.</span> <span class="nav-text">数值时间积分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AC%A7%E6%8B%89%E5%85%AC%E5%BC%8F"><span class="nav-number">2.1.</span> <span class="nav-text">欧拉公式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9F%A6%E5%B0%94%E8%8E%B1verlet%E7%A7%AF%E5%88%86"><span class="nav-number">2.2.</span> <span class="nav-text">韦尔莱（Verlet）积分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#verlet-%E4%B8%BB%E8%A6%81%E6%80%9D%E8%B7%AF"><span class="nav-number">2.2.1.</span> <span class="nav-text">Verlet 主要思路</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A2%B0%E6%92%9E%E6%A3%80%E6%9F%A5"><span class="nav-number">3.</span> <span class="nav-text">碰撞检查</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%85%E5%9B%B4%E4%BD%93"><span class="nav-number">3.1.</span> <span class="nav-text">包围体</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B2%97%E7%95%A5%E9%98%B6%E6%AE%B5broad-phase"><span class="nav-number">3.2.</span> <span class="nav-text">粗略阶段（Broad Phase）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%82%E6%AC%A1%E5%8C%85%E5%9B%B4%E6%8A%80%E6%9C%AFbvh-bounding-volume-hierarchical"><span class="nav-number">3.2.1.</span> <span class="nav-text">层次包围技术（BVH Bounding Volume Hierarchical）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A2%B0%E6%92%9E%E6%B1%82%E4%BA%A4"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">碰撞求交</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%84%E7%BA%BF%E6%B1%82%E4%BA%A4"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">射线求交</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%AB%E6%8F%8F%E5%89%AA%E9%99%A4%E6%B3%95sweep-and-prune"><span class="nav-number">3.2.2.</span> <span class="nav-text">扫描剪除法（Sweep And Prune）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B2%BE%E7%A1%AE%E9%98%B6%E6%AE%B5narrow-phase"><span class="nav-number">3.3.</span> <span class="nav-text">精确阶段（Narrow Phase）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%A6%BB%E8%BD%B4%E7%AE%97%E6%B3%95sat-separating-axis-test"><span class="nav-number">3.3.1.</span> <span class="nav-text">分离轴算法（SAT Separating Axis Test）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gilbert-johnson-keerthi-gjk%E7%AE%97%E6%B3%95"><span class="nav-number">3.3.2.</span> <span class="nav-text">Gilbert-Johnson-Keerthi (GJK)算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%B5%E5%8F%AF%E5%A4%AB%E6%96%AF%E5%9F%BA%E5%92%8C%E9%9B%86minkowski-sum"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">闵可夫斯基和集(Minkowski Sum)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%B5%E5%8F%AF%E5%A4%AB%E6%96%AF%E5%9F%BA%E5%B7%AE%E9%9B%86minkowski-difference"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">闵可夫斯基差集(Minkowski Difference)</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BA%A6%E6%9D%9F"><span class="nav-number">4.</span> <span class="nav-text">约束</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AD%89%E5%BC%8F%E7%BA%A6%E6%9D%9F"><span class="nav-number">4.1.</span> <span class="nav-text">等式约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E7%AD%89%E5%BC%8F%E7%BA%A6%E6%9D%9F"><span class="nav-number">4.2.</span> <span class="nav-text">不等式约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%8D%E7%BD%AE%E7%BA%A6%E6%9D%9F%E8%B7%9F%E9%80%9F%E5%BA%A6%E7%BA%A6%E6%9D%9F"><span class="nav-number">4.3.</span> <span class="nav-text">位置约束跟速度约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%9C%B0%E9%9D%A2%E7%BA%A6%E6%9D%9F"><span class="nav-number">4.4.</span> <span class="nav-text">实例：地面约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E8%88%AC%E5%BD%A2%E5%BC%8F"><span class="nav-number">4.5.</span> <span class="nav-text">一般形式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%B0%E9%9D%A2%E7%BA%A6%E6%9D%9F%E4%B8%80%E8%88%AC%E5%BD%A2%E5%BC%8F"><span class="nav-number">4.6.</span> <span class="nav-text">地面约束一般形式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9F%E5%BA%A6%E7%BA%A6%E6%9D%9F%E8%A7%A3%E6%9E%90"><span class="nav-number">4.6.1.</span> <span class="nav-text">速度约束解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E4%B8%80%E8%88%AC%E5%BD%A2%E5%BC%8F"><span class="nav-number">4.6.2.</span> <span class="nav-text">应用一般形式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E9%87%8D%E7%BA%A6%E6%9D%9F"><span class="nav-number">4.7.</span> <span class="nav-text">多重约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%82%B9%E7%BA%A6%E6%9D%9F"><span class="nav-number">4.8.</span> <span class="nav-text">点约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%8B%E8%BD%AC%E8%B7%9F%E8%BD%AC%E5%8A%A8%E6%83%AF%E9%87%8F"><span class="nav-number">4.9.</span> <span class="nav-text">旋转跟转动惯量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%8B%E8%BD%AC%E7%BA%A6%E6%9D%9F"><span class="nav-number">4.10.</span> <span class="nav-text">旋转约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%99%8B%E5%8D%87%E5%88%B0-3d-%E7%BA%A6%E6%9D%9F"><span class="nav-number">4.11.</span> <span class="nav-text">晋升到 3D 约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%82%B9%E7%BA%A6%E6%9D%9F-%E6%97%8B%E8%BD%AC"><span class="nav-number">4.12.</span> <span class="nav-text">点约束 + 旋转</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="小贤" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">小贤</p><div class="site-description" itemprop="description">Watch and learn, your magic is mine!</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">19</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">19</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/qq317423892" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qq317423892" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a> </span><span class="links-of-author-item"><a href="mailto:xianlongok@163.com" title="E-Mail → mailto:xianlongok@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a></span></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://scorpioq.github.io/" title="https:&#x2F;&#x2F;scorpioq.github.io&#x2F;" rel="noopener" target="_blank">ScorpioQ</a></li><li class="links-of-blogroll-item"><a href="https://www.xygblog.com/" title="https:&#x2F;&#x2F;www.xygblog.com&#x2F;" rel="noopener" target="_blank">邪妖怪のBlog</a></li></ul></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.xianlongok.site/post/4dab7192/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="小贤"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="十三"><meta itemprop="description" content="Watch and learn, your magic is mine!"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="物理模拟过程简介 | 十三"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">物理模拟过程简介</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-01 10:00:35" itemprop="dateCreated datePublished" datetime="2022-09-01T10:00:35+08:00">2022-09-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%89%A9%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">物理</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%89%A9%E7%90%86/%E7%BA%A6%E6%9D%9F/" itemprop="url" rel="index"><span itemprop="name">约束</span></a> </span></span><span id="/post/4dab7192/" class="post-meta-item leancloud_visitors" data-flag-title="物理模拟过程简介" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/post/4dab7192/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/post/4dab7192/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>12k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>11 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="物理模拟流程">物理模拟流程</h1><p>物理模拟循环主要有三个阶段构成：</p><ul><li>碰撞检测（Collision Detection）</li><li>约束求解（Constraint Solving）</li><li>数值时间积分（Time Integration）</li></ul><div data-align="center"><p><img data-src="/images/phy_intro/phy_engine.svg" width="60%" height="60%"></p></div><h1 id="数值时间积分">数值时间积分</h1><h2 id="欧拉公式">欧拉公式</h2><p>之前 <a href="/post/d6327b48/" title="PBD-Position Based Dynamics">PBD-Position Based Dynamics</a> 中已经介绍过了，这里就不做过多介绍</p><h2 id="韦尔莱verlet积分">韦尔莱（Verlet）积分</h2><p>Verlet 积分法在 wiki 百科中的定义：</p><div class="note success"><p>Verlet 积分法是经典力学（牛顿力学）中的一种最为普遍的积分方法，被广泛运用在分子运动模拟（Molecular Dynamics Simulation），行星运动以及织物变形模拟等领域。Verlet 算法要解决的问题是，给定粒子 <span class="math inline">\(t\)</span> 时刻的位置 <span class="math inline">\(x\)</span> 和速度 <span class="math inline">\(v\)</span>，得到 <span class="math inline">\(t+\Delta t\)</span> 时刻的位置 <span class="math inline">\(x(t+\Delta t)\)</span> 和速度 <span class="math inline">\(v(t+\Delta t)\)</span>。最简单的方法是前向计算（考虑当前和未来）的速度位移公式，也就是欧拉积分法，但精度不够，且不稳定。Verlet 积分是一种综合过去、现在和未来的计算方法（居中计算），精度为 <span class="math inline">\(O(4)\)</span>, 稳定度好，且计算复杂度不比欧拉积分高多少。</p></div><p>总结一下：</p><ul><li>verlet 积分与欧拉积分最大的差别就是：欧拉积分考虑当前和下一时刻，verlet 积分考虑上一时刻，当前，下一时刻</li><li>verlet 积分有着更好的精度，即4阶精度</li><li>verlet 积分和欧拉积分性能差不多</li></ul><h3 id="verlet-主要思路">Verlet 主要思路</h3><p>将 <span class="math inline">\(x(t+\Delta t)\)</span> 和 <span class="math inline">\(x(t-\Delta t)\)</span> 进行泰勒展开：</p><p><span class="math display">\[\begin{aligned} \boldsymbol{x} (t+\Delta t) &amp;= \boldsymbol{x}(t) + \frac{1}{1!} \frac{dx}{dt}\Delta t + \frac{1}{2!} \frac{d^2x}{dt^2}\Delta t^2 + \frac{1}{3!} \frac{d^3x}{dt^3}\Delta t^3 + O(\Delta t^4) \\ &amp;= \boldsymbol{x}(t) + \textcolor{SkyBlue}{\boldsymbol{v}{(t)}}\Delta t + \frac{1}{2!} \textcolor{SkyBlue}{\boldsymbol{a}} \Delta t^2 + \frac{1}{3!} \frac{d^3x}{dt^3}\Delta t^3 + O(\Delta t^4) \\ \boldsymbol{x} (t-\Delta t) &amp;= \boldsymbol{x}(t) - \textcolor{SkyBlue}{\boldsymbol{v}{(t)}}\Delta t + \frac{1}{2!} \textcolor{SkyBlue}{\boldsymbol{a}} \Delta t^2 - \frac{1}{3!} \frac{d^3x}{dt^3}\Delta t^3 + O(\Delta t^4) \end{aligned}\]</span></p><p>两式相加可得 <strong>位置韦尔莱公式</strong>：</p><p><span class="math display">\[ \boldsymbol{x} (t + \Delta t) = 2\boldsymbol{x}(t) - \boldsymbol{x} (t-\Delta t) + \textcolor{SkyBlue}{\boldsymbol{a}} \Delta t^2 + O(\Delta t^4) \]</span></p><div class="note success"><p>这个式子显明，只有在知道前一时刻和后一时刻的位置时，才有可能知道当前时刻的速度。也就是说，在当前时刻不能获得速度信息，必须要等到下一时刻的位置确定以后，才能返回来计算当前的速度，因此速度的更新要晚一个时刻。</p></div><p>两式相减，两边除以 <span class="math inline">\(2\Delta t\)</span>，可得 <strong>速度韦尔莱公式</strong>：</p><p><span class="math display">\[ \boldsymbol{v} (t) = \frac{\boldsymbol{x}(t + \Delta t) - \boldsymbol{x} (t-\Delta t)}{2\Delta t} + O(\Delta t^2) \]</span></p><p>当然，开始模拟时我们需要知道 <span class="math inline">\(\boldsymbol{x}(t-\Delta t)\)</span>，这个可以根据之前的泰勒展开得到（虽然这个获取方式精度只有 3 阶，但是长时间运行后，与总体误差相比还是可以忽略不计的）：</p><p><span class="math display">\[ \boldsymbol{x} (t-\Delta t) = \boldsymbol{x}(t) - \textcolor{SkyBlue}{\boldsymbol{v}{(t)}}\Delta t + \frac{1}{2!} \textcolor{SkyBlue}{\boldsymbol{a}} \Delta t^2 + O(\Delta t^3) \]</span></p><h1 id="碰撞检查">碰撞检查</h1><p>实际游戏运行过程中，物理模拟可能有很多个物体，如果采用简单粗暴的方法做碰撞检测，复杂度将会是 <span class="math inline">\(O(n^2)\)</span>，因此为了优化效率，一般会将碰撞检测分成两个阶段：</p><ul><li>粗略阶段（Broad Phase）：通过 AABB 检测两个物体是否碰撞</li><li>精确阶段（Narrow Phase）：粗略阶段计算碰撞后，精细阶段计算是否碰撞，碰撞点、碰撞方向以及碰撞深度</li></ul><div data-align="center"><p><img data-src="/images/phy_intro/collision_detection.png" width="30%" height="30%"></p></div><p>最后计算得到碰撞结果，进入求解器（Solver）来处理碰撞。</p><h2 id="包围体">包围体</h2><p>包围体：用简单的几何体来标识复杂外形的对象，如下图所示：</p><div data-align="center"><p><img data-src="/images/phy_intro/bbox.jpg" width="60%" height="60%"></p></div><ul><li>Sphere。用球体代表物体，只需要质心和半径就可以表示物体。求交操作简单，准确性较差。</li><li>AABB（axis-aligned bounding box）。AABB 的特点是包围体的各个面和边都垂直于世界坐标，这个特点带来的好处是求交操作简单。AABB 只需要两个对角点就可以表示物体。准确性一般。缺点是当实际物体发生旋转时，需要对 AABB 进行更新操作。</li><li>OBB（oriented bounding box）。与 AABB 相比，OBB 用最小包围盒代表物体，并且考虑物体的旋转。准确性比 AABB 好，但是求交操作更复杂。</li></ul><div class="note success"><p>除此之外，游戏中还会用到 <strong>胶囊体（Capsule）</strong> 来简化人物角色物理模拟。</p></div><h2 id="粗略阶段broad-phase">粗略阶段（Broad Phase）</h2><h3 id="层次包围技术bvh-bounding-volume-hierarchical">层次包围技术（BVH Bounding Volume Hierarchical）</h3><p>简单来说，BVH 就是将 BV 用树的方式组织在一起，每个父节点是所有子节点 BV 的合并，并尽量保持每个节点的BV最小，BVH 可以非常方便地进行碰撞求交、射线求交。如下图：</p><div data-align="center"><p><img data-src="/images/phy_intro/bvh.png" width="60%" height="60%"></p></div><div class="note success"><p><strong>a</strong> ：根节点<br><strong>b</strong> ：内部节点<br><strong>1 2 3</strong> ：叶子节点</p></div><p>碰撞检测过程：</p><h4 id="碰撞求交">碰撞求交</h4><p>例如检查 3 跟有没有重叠的，先从根节点 a 开始，根节点总是跟子节点重叠，然后用根节点的子节点检查，最后发现 b 重叠，继续最终找到 1 跟 3 重叠。</p><h4 id="射线求交">射线求交</h4><p>同样射线求交过程一样，蓝色是检测射线，也是同样的过程</p><div data-align="center"><p><img data-src="/images/phy_intro/bvh_line.png" width="50%" height="50%"></p></div><h3 id="扫描剪除法sweep-and-prune">扫描剪除法（Sweep And Prune）</h3><p>把所有物体的 AABB 投影到对应的坐标轴上，可以得到对应的 AABB 在对应轴的 AABB 的范围 [min, max]，一般情况下如果两个物体不重叠，范围不会重叠，一般来说 二维判断需要分别映射到 x，y 轴。</p><div data-align="center"><p><img data-src="/images/phy_intro/sort_and_sweep.png" width="50%" height="50%"></p></div><div class="note success"><p>一般来说，对于已经排序好的数组来说，某个物体发生运动，对该物体的范围进行更新，时间效率其实很高。</p></div><h2 id="精确阶段narrow-phase">精确阶段（Narrow Phase）</h2><p>精确阶段需要计算出：</p><ul><li>两个物体是否碰撞（碰撞体 <span class="math inline">\(A\)</span>、<span class="math inline">\(B\)</span>）</li><li>碰撞点</li><li>碰撞深度（最深穿透点 <span class="math inline">\(P_A\)</span>、<span class="math inline">\(P_B\)</span>)</li><li>碰撞法向量（<span class="math inline">\(\vec{n}\)</span>）</li></ul><div data-align="center"><p><img data-src="/images/phy_intro/narrow_phase.png" width="40%" height="40%"></p></div><h3 id="分离轴算法sat-separating-axis-test">分离轴算法（SAT Separating Axis Test）</h3><p>原理：两个凸多边形不相交，当且仅当必然存在一条直线，两个凸多边形在这条直线上的投影不相交。或者描述为:两个凸多边形相交，则在所有直线上的投影都是相交的。对于凸多面体也是一样的，只是投影在面上。</p><div data-align="center"><p><img data-src="/images/phy_intro/sat.png" width="80%" height="80%"></p></div><h3 id="gilbert-johnson-keerthi-gjk算法">Gilbert-Johnson-Keerthi (GJK)算法</h3><p>如果两个多边形相交，那么这两个多边形构成的闵可夫斯基差集(Minkowski Difference)，必然会包含原点。</p><h4 id="闵可夫斯基和集minkowski-sum">闵可夫斯基和集(Minkowski Sum)</h4><p>定义：两个图形 A, B 的闵可夫斯基和</p><p><span class="math display">\[ A \oplus B = { \vec{a} + \vec{b}; \vec{a} \in A, \vec{b} \in B} \]</span></p><div class="note success"><p>两个图形的闵可夫斯基和就是将其中一个图形中所有点到原点的向量，加上另外一个图形中所有的点到原点向量组成新点集图形</p></div><p>一个三角形跟一个点的闵可夫斯基和集：</p><div data-align="center"><p><img data-src="/images/phy_intro/mink_add_0.svg" width="40%" height="40%"></p></div><div class="note success"><p>如上图：三角形 <span class="math inline">\(B\)</span> 中的一个点向量加上点 <span class="math inline">\(A\)</span> 向量后得到新图形中的一个点</p></div><p>一个三角形跟另外一条线段的闵可夫斯基和集：</p><div data-align="center"><p><img data-src="/images/phy_intro/mink_add_1.gif" width="40%" height="40%"></p></div><p>一个三角形跟另外一个三角形的闵可夫斯基和集：</p><div data-align="center"><p><img data-src="/images/phy_intro/mink_add_2.gif" width="40%" height="40%"></p></div><p>可以看出闵可夫斯基和集计算方式就是遍历一个多边形变的点到原点的向量，分别加上另外一个多边形边点到原点的向量所围成的新的多边形：</p><div data-align="center"><p><img data-src="/images/phy_intro/mink_add_3.svg" width="40%" height="40%"></p></div><div class="note success"><p>图中 <span class="math inline">\(B\)</span> 图形的各个点到原点向量分别加上图形 <span class="math inline">\(A\)</span> 中的点到原点的向量后，分别得到的粉色、蓝色、绿色点，围城的形状还是 <span class="math inline">\(A\)</span> 的样子。而且如果两个多面体都是图多边形，然最后形成的也是凸多边形。</p></div><h4 id="闵可夫斯基差集minkowski-difference">闵可夫斯基差集(Minkowski Difference)</h4><p>闵可夫斯基差集定义：</p><p><span class="math display">\[ A \ominus B = { \vec{a} - \vec{b}; \vec{a} \in A, \vec{b} \in B} \]</span></p><p>如下图点集 <span class="math inline">\(B\)</span> 沿着原点做镜像，可以得到点集 <span class="math inline">\(-B\)</span>（黄色三角形）</p><div data-align="center"><p><img data-src="/images/phy_intro/mink_diff.png" width="40%" height="40%"></p></div><p>然后差集公式可以写成：</p><p><span class="math display">\[ A \ominus B = A \oplus (-B) \]</span></p><div data-align="center"><p><img data-src="/images/phy_intro/mink_diff_1.png" width="40%" height="40%"></p></div><p>结论：如果两个点集的闵可夫斯基差集过原点，则表示这两个点集重叠：</p><div data-align="center"><p><img data-src="/images/phy_intro/mink_diff_2.png" width="100%" height="100%"></p></div><div class="note success"><p>如果 <span class="math inline">\(A\)</span> <span class="math inline">\(B\)</span> 中有两个点重叠，那么这两个点向量做减法肯定得出零向量，即过原点。两个向量如果不为零向量，相加相减都不会得出零向量。</p></div><h1 id="约束">约束</h1><h2 id="等式约束">等式约束</h2><p>等式约束的定义如下:</p><p><span class="math display">\[ C=0 \]</span></p><p>如果我们要将某个物体坐标顶在某个原点则约束可以写为：</p><p><span class="math display">\[ \left[ \begin{matrix} x \\ y \end{matrix} \right] = 0 \]</span></p><h2 id="不等式约束">不等式约束</h2><p><span class="math display">\[ C &gt; 0 \]</span></p><div class="note success"><p>则当 不满足条件 <span class="math inline">\(C \leq 0\)</span> 的时，我们要是的约束 <span class="math inline">\(C = 0\)</span>，例如两个物体不能互相穿透，则他们之间的距离要大于 0，当他们距离小于 0 时，我们需要施加约束使得他们间的距离等于 0。</p></div><h2 id="位置约束跟速度约束">位置约束跟速度约束</h2><p>当约束函数 <span class="math inline">\(C=0\)</span> 中的 <span class="math inline">\(C\)</span> 是一个位置的函数时，我们称之为位置约束，对应的速度约束就是对位置进行微分，得到速度约束。</p><p><span class="math display">\[\begin{aligned} C &amp;= 0 \qquad \dot{C} = 0 \\ \left[ \begin{matrix} x \\ y \end{matrix} \right] &amp;= 0 \qquad \left[ \begin{matrix} V_x \\ V_y \end{matrix} \right] = 0 \end{aligned}\]</span></p><div class="note success"><p>位置约束：会让物体立即满足约束<br>速度约束：物体会在约束条件下，慢慢满足约束，达到软性约束效果</p></div><h2 id="实例地面约束">实例：地面约束</h2><p>我们要让物体不会掉到地面以下，只需要满足如下条件：</p><p><span class="math display">\[\begin{aligned} y &gt; 0 \qquad 若 \quad y \leq 0 \qquad 则 \qquad y &amp;= 0 \\ V_y &amp;= 0 \end{aligned}\]</span></p><p>当一个物体陷入地面时，约束函数 <span class="math inline">\(C\)</span> 得出的结果不满足约束，计算出的结果其实就是</p><p><span class="math display">\[ C=误差量= y \]</span></p><p>我们可以用这个误差量来修正速度 <span class="math inline">\(V_y\)</span>（当 <span class="math inline">\(V_y\)</span>不满足约束的时候，增加修正量），于是得出如下：</p><p><span class="math display">\[ V_y = 0 \rightarrow V_y + \frac{\beta}{\Delta t}y=0 \rightarrow V_y=-\frac{\beta}{\Delta t}y \]</span></p><div class="note success"><p>Baumgarte stabilization 邦加特修正<br><span class="math inline">\(\beta \in [0, 1]\)</span> ：<span class="math inline">\(\beta = 1\)</span> 时，下一次积分计算速度位置时，就会完全修正误差，介于 <span class="math inline">\((0,1)\)</span> 则会慢慢修正位置误差，<span class="math inline">\(\beta = 0\)</span> 表示不修正<br><span class="math inline">\(y\)</span> 误差项 （<span class="math inline">\(y = 0\)</span>表示没有误差，此时满足约束）<br><span class="math inline">\(\Delta t\)</span> 时间</p></div><p>代码实现 <a href="#ref-anchor-4"><sup>4</sup></a>：</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">float</span></span> dt <span class="token operator">=</span> Time<span class="token punctuation">.</span>deltaTime<span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">float</span></span> y <span class="token operator">=</span> Ball<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y<span class="token punctuation">;</span>

vy <span class="token operator">+=</span> Gravity <span class="token operator">*</span> dt<span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>y <span class="token operator">&lt;=</span> <span class="token number">0.0f</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    vy <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>Beta <span class="token operator">/</span> dt<span class="token punctuation">)</span> <span class="token operator">*</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

y <span class="token operator">+=</span> vy <span class="token operator">*</span> dt<span class="token punctuation">;</span>

<span class="token class-name">Vector3</span> pos <span class="token operator">=</span> Ball<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
pos<span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
Ball<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position <span class="token operator">=</span> pos<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>效果如下，当球掉落到地下后，会慢慢恢复上来：</p><div data-align="center"><p><img data-src="/images/phy_intro/ground_c.gif" width="40%" height="40%"></p></div><h2 id="一般形式">一般形式</h2><p>速度约束的一般形式可以写成（引入雅可比矩阵：Jacobian）：</p><p><span class="math display">\[ [J_{v_1} \quad J_{V_2}]\left[ \begin{matrix} V_x \\ V_y \end{matrix} \right] + b= 0 \]</span></p><p><span class="math display">\[ JV + b =0 \]</span></p><div class="note success"><p>只考虑线性速度情况，一般来说二维约束包含三个自由度：两个线速度 <span class="math inline">\(V_x\)</span>、<span class="math inline">\(V_y\)</span> 以及一个角速度 <span class="math inline">\(\omega\)</span>，三维的约束包含六个自由度：线性速度 <span class="math inline">\(V_x\)</span>、<span class="math inline">\(V_y\)</span>、<span class="math inline">\(V_z\)</span> 角速度 <span class="math inline">\(\omega_{x}\)</span>、<span class="math inline">\(\omega_{y}\)</span>、<span class="math inline">\(\omega_{z}\)</span></p></div><h2 id="地面约束一般形式">地面约束一般形式</h2><p>将之前的雅克比矩阵一般形式带入地面约束。</p><p><span class="math display">\[\begin{aligned} JV + b = 0 &amp;\qquad V_y + \frac{\beta}{\Delta t}y = 0 \\ J = [0 \quad 1] &amp;\qquad b = \frac{\beta}{\Delta t}y \end{aligned}\]</span></p><div class="note success"><p>J : 雅克比矩阵<br>b ：修正项</p></div><h3 id="速度约束解析">速度约束解析</h3><p>当前速度 <span class="math inline">\(V_1\)</span> 约束不满足的时候，我们需要计算修正速度 <span class="math inline">\(V_2\)</span>，于是有如下公式：</p><p><span class="math display">\[\begin{aligned} MV &amp;= \boldsymbol{L}\lambda \\ M(V_2 - V_1) &amp;= \boldsymbol{L}\lambda \end{aligned}\]</span></p><div class="note success"><p><span class="math inline">\(\boldsymbol{L}\)</span>：冲量方向<br><span class="math inline">\(\lambda\)</span>：冲量大小<br><span class="math inline">\(M=\left[\begin{matrix} m \quad 0 \\ 0 \quad m \end{matrix} \right]\)</span>：质量矩阵</p></div><p>现在要求出 <span class="math inline">\(\boldsymbol{L}\)</span> 跟 <span class="math inline">\(\lambda\)</span>。这里 <span class="math inline">\(\boldsymbol{L}=J^T\)</span>，后面解释来源。带入可以直接得出：</p><p><span class="math display">\[ V_2 = V_1 + M^{-1}J^T\lambda \]</span></p><p>因为 <span class="math inline">\(V_2\)</span> 是修正后的速度，会满足约束，因此有：</p><p><span class="math display">\[\begin{aligned} JV_2 + b &amp;= 0 \\ J(V_1 + M^{-1}J^T\lambda) + b &amp;= 0 \leftarrow (代入 V_2) \end{aligned}\]</span></p><p>整理得出公式：</p><p><span class="math display">\[\begin{aligned} (JM^{-1}J^T)\lambda = -(JV_1 + b) \\ \lambda = \frac{-(JV_1 + b)}{(JM^{-1}J^T)} \end{aligned}\]</span></p><p>一般来说会把分母项整理成一个形式，叫有效质量：</p><p><span class="math display">\[ M_{eff} = (JM^{-1}J^T)^{-1} \]</span></p><p>最后 <span class="math inline">\(\lambda\)</span> 会变成（拉格朗日乘数，也是修正 <span class="math inline">\(V\)</span> 的冲量大小）：</p><p><span class="math display">\[ \lambda = M_{eff}[-(JV_1 + b)] \]</span></p><p>现在解释下 <span class="math inline">\(\boldsymbol{L}\)</span>，假设我们这里 <span class="math inline">\(V\)</span> 是一个三维向量，则：</p><p><span class="math display">\[\begin{aligned} JV + b &amp;= 0 （雅克比参数展开）\\ ax + by + cz + d &amp;= 0 \rightarrow 平面方程 \end{aligned}\]</span></p><div class="note success"><p>关于 <span class="math inline">\(\boldsymbol{L}=J^T\)</span> 当一个点不在平面上时，带入这个等式，结果不等于 0，即不符合约束，如果要让这个点满足约束，最快的方向就是平面的法线向量 <span class="math inline">\(\boldsymbol{n}=(a, b, c)\)</span>，也就是分别对函数求不同维度（x，y，z）的一阶导，就是 J，因此修正的冲量方向跟法相量平行。<br><span class="math inline">\(M(V_2 - V_1) = \boldsymbol{L}\lambda\)</span> 公式中 <span class="math inline">\(M\)</span> 是 <span class="math inline">\(2 * 2\)</span> 维，速度是 <span class="math inline">\(2 * 1\)</span> 维，因此最后得出的 <span class="math inline">\(\boldsymbol{L}\)</span> 是 <span class="math inline">\(2 * 1\)</span> 维，而 <span class="math inline">\(J\)</span> 是 <span class="math inline">\(1 * 2\)</span>维，因此得出 <span class="math inline">\(\boldsymbol{L}=J^T\)</span></p></div><p>打个比方：当前的位置是黑点，<span class="math inline">\(C_1\)</span> 和 <span class="math inline">\(C_2\)</span> 是需要满足的两个平面约束，当前点不满足这两个约束，因此需要依次使用这两个约束对位置做修正：</p><div data-align="center"><p><img data-src="/images/phy_intro/plant_c.png" width="40%" height="40%"></p></div><h3 id="应用一般形式">应用一般形式</h3><p>将速度的一般形式应用到地面约束：</p><p><span class="math display">\[\begin{aligned} JV + b &amp; = 0 \\ V_y + \frac{\beta}{\Delta t}y &amp;= 0 \\ [0 \quad 1]\left [\begin{matrix} V_x \\ V_y \end{matrix} \right] + \frac{\beta}{\Delta t}y &amp;= 0 \end{aligned}\]</span></p><p>推算可得：</p><p><span class="math display">\[\begin{aligned} J &amp;= [0 \quad 1] \\ b &amp;= \frac{\beta}{\Delta t}y \\ \lambda &amp;= \frac{-(JV_1 + b)}{(JM^{-1}J^T)} = M(-V_{y1} - \frac{\beta}{\Delta t}y) \\ \Delta V &amp;= M^{-1}J^T\lambda=-V_{y1}-\frac{\beta}{\Delta t}y \end{aligned}\]</span></p><div class="note success"><p><span class="math inline">\(V_{y1}\)</span>：是 <span class="math inline">\(V_y\)</span> 一开始的速度</p></div><h2 id="多重约束">多重约束</h2><p>之前有提到如果有两个约束，需要用迭代的方式交替修正位置，从而解出满足两个约束的共同解，如果不用迭代的方式，那就需要用到多重约束，先看二维的情况：</p><p><span class="math display">\[\begin{split} J_1V + b_1 = 0 \\ J_2V + b_2 = 0 \\ \quad \\ JV + b = 0 \\ \quad \\ J = \left[\begin{matrix} J_1 \\ J_2 \end{matrix}\right] \quad b = \left[\begin{matrix} b1 \\ b2 \end{matrix}\right] \end{split}\]</span></p><div class="note success"><p><span class="math inline">\(J\)</span> 现在是一个 <span class="math inline">\(2 * 2\)</span> 矩阵</p></div><p>因此之前求解得到的 <span class="math inline">\(\lambda\)</span> 分母不再是标量，需要改写成：</p><p><span class="math display">\[\begin{aligned} \lambda &amp;= \frac{-(JV_1 + b)}{(JM^{-1}J^T)} \downarrow \\ \lambda &amp;= (JM^{-1}J^T)^{-1}[-(JV + b)] \\ V_2 &amp;= V_1 + M^{-1}J^T\lambda \end{aligned}\]</span></p><h2 id="点约束">点约束</h2><p>如果我们要将某个物体固定在某个点，则位置约束跟速度约束如下：</p><p><span class="math display">\[ C: \left[\begin{matrix} x-P_x \\ y - P_y \end{matrix}\right] = 0 \\ \quad \\ \dot{C}: \left[\begin{matrix} V_x \\ V_y \end{matrix}\right] = 0 \]</span></p><p>依次得出：</p><p><span class="math display">\[ JV + b = 0 \\ J = \left[\begin{matrix} 1 \quad 0 \\ 0 \quad 1 \end{matrix}\right] \\ \quad \\ b = \frac{\beta}{\Delta t}C=\frac{\beta}{\Delta t}\left[\begin{matrix} x - P_x \\ y - P_y \end{matrix}\right] \]</span></p><div class="note success"><p><span class="math inline">\(C\)</span>：之前提到过，一开始如果不满足约束，则约束得出的结果就是需要修正的量</p></div><p>根据上面得出的结论，最终算出：</p><p><span class="math display">\[\begin{aligned} \lambda &amp;= (JM^{-1}J^T)^{-1}[-(JV + b)] \\ \qquad \\ V_2 &amp;= V_1 + M^{-1}J^T\lambda \\ \Delta V &amp;= M^{-1}J^T\lambda = \frac{-\beta}{\Delta t}\left[\begin{matrix} x - P_x \\ y - P_y \end{matrix}\right] \end{aligned} \]</span></p><blockquote><p>当 <span class="math inline">\(\beta = 1\)</span> 时，下一次积分会立即修正，而当 <span class="math inline">\(\beta \in (0, 1)\)</span>，则会慢慢修正</p></blockquote><p>代码实现：</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// P 是移动物体</span>
<span class="token comment">// Ball 是跟随物体，会跟随 P 移动，即位置固定成 P 的位置</span>

<span class="token class-name"><span class="token keyword">float</span></span> dt <span class="token operator">=</span> Time<span class="token punctuation">.</span>deltaTime<span class="token punctuation">;</span>
<span class="token class-name">Vector3</span> c <span class="token operator">=</span> Ball<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position <span class="token operator">-</span> P<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position<span class="token punctuation">;</span>

v <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token operator">-</span>Beta <span class="token operator">/</span> dt<span class="token punctuation">)</span> <span class="token operator">*</span> c<span class="token punctuation">;</span>
<span class="token comment">// 阻尼消耗</span>
v <span class="token operator">*=</span> <span class="token number">0.9f</span><span class="token punctuation">;</span>
Ball<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>position <span class="token operator">+=</span> v<span class="token operator">*</span>dt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码效果如下：</p><div data-align="center"><p><img data-src="/images/phy_intro/position_show.gif" width="40%" height="40%"></p></div><h2 id="旋转跟转动惯量">旋转跟转动惯量</h2><p>之前考虑的都是二维的情况，现在加入旋转，自由度由两个变成三个:</p><p><span class="math display">\[ \left[\begin{matrix} x \\ y \end{matrix} \right] \rightarrow \left[\begin{matrix} x \\ y \\ a \\ \end{matrix}\right] \\ \qquad \\ V = \left[\begin{matrix} V_x \\ V_y \end{matrix} \right] \rightarrow \left[\begin{matrix} V_x \\ V_y \\ \omega \\ \end{matrix}\right] \\ \qquad \\ M = \left[\begin{matrix} m \quad 0 \\ 0 \quad m \end{matrix} \right] \rightarrow \left[\begin{matrix} m \quad 0 \quad 0 \\ 0 \quad m \quad 0 \\ 0 \quad 0 \quad \boldsymbol{I} \\ \end{matrix}\right] \\ \]</span></p><p>最终的求解形式不变</p><p><span class="math display">\[\begin{aligned} JV &amp;+ b = 0 \\ \lambda &amp;= (JM^{-1}J^T)^{-1}[-(JV + b)] \end{aligned} \]</span></p><div class="note success"><p><span class="math inline">\(\boldsymbol{I}\)</span> 是二维的转动惯量</p></div><h2 id="旋转约束">旋转约束</h2><p>现在看下旋转约束：</p><p><span class="math display">\[ C: a - \theta = 0 \\ \dot{C}: \omega = 0 \]</span></p><p>套用一般形式：</p><p><span class="math display">\[\begin{aligned} JV &amp;+ b = 0 \\ J &amp;= [0 \quad 0 \quad 1] \\ b &amp;= \frac{\beta}{\Delta t}C = \frac{\beta}{\Delta t}\left[\begin{matrix} 0 \\ 0 \\ a - \theta \end{matrix}\right] \end{aligned}\]</span></p><p>最后算出结果（<span class="math inline">\(\lambda\)</span> 跟 <span class="math inline">\(V_2\)</span> 的形式都没变化，只是最后的结果 <span class="math inline">\(\Delta V\)</span> 不一样）：</p><p><span class="math display">\[\begin{aligned} \lambda &amp;= (JM^{-1}J^T)^{-1}[-(JV + b)] \\ \qquad \\ V_2 &amp;= V_1 + M^{-1}J^T\lambda \\ \Delta V &amp;= M^{-1}J^T\lambda = \frac{-\beta}{\Delta t}\left[\begin{matrix} 0 \\ 0 \\ a - \theta \end{matrix}\right] \end{aligned} \]</span></p><h2 id="晋升到-3d-约束">晋升到 3D 约束</h2><p><span class="math display">\[\begin{split} JV + b = 0 \quad V = \left[\begin{matrix} V_x \\ V_y \\ V_z \\ \omega_x \\ \omega_y \\ \omega_z \end{matrix}\right] \quad M = \begin{bmatrix}\begin{matrix} m&amp;0&amp;0\\ 0&amp;m&amp;0\\ 0&amp;0&amp;m \end{matrix} &amp; \begin{matrix} 0&amp;0&amp;0\\ 0&amp;0&amp;0\\ 0&amp;0&amp;0 \end{matrix} \\ \begin{matrix} 0&amp;0&amp;0\\ 0&amp;0&amp;0\\ 0&amp;0&amp;0 \end{matrix} &amp; \boxed{\boldsymbol{I}} \end{bmatrix} \quad \\ M^{-1} = \begin{bmatrix}\begin{matrix} \frac{1}{m}&amp;0&amp;0\\ 0&amp;\frac{1}{m}&amp;0\\ 0&amp;0&amp;\frac{1}{m} \end{matrix} &amp; \begin{matrix} 0&amp;0&amp;0\\ 0&amp;0&amp;0\\ 0&amp;0&amp;0 \end{matrix} \\ \begin{matrix} 0&amp;0&amp;0\\ 0&amp;0&amp;0\\ 0&amp;0&amp;0 \end{matrix} &amp; \boxed{\boldsymbol{I^{-1}}} \end{bmatrix} \end{split} \]</span></p><div class="note success"><p><span class="math inline">\(V_x\)</span>、<span class="math inline">\(V_y\)</span>、<span class="math inline">\(V_z\)</span> 是线性速度的分量，<span class="math inline">\(\omega\)</span> 是一个三维向量 <span class="math inline">\(\omega_x\)</span>、<span class="math inline">\(\omega_y\)</span>、<span class="math inline">\(\omega_z\)</span> 是它的分量，方向是角速度的旋转轴向，长度是角速度的大小 \ 形状不同的物体转动惯量 <span class="math inline">\(I\)</span> 不一样，具体参考<a href="#ref-anchor-5"><sup>5</sup></a></p></div><h2 id="点约束-旋转">点约束 + 旋转</h2><p>最后一个例子：正方体一个角钉在空间中的某个点（将<span class="math inline">\(X\)</span> 沿着向量 <span class="math inline">\(\boldsymbol{R}\)</span> 移动就能打到 <span class="math inline">\(P\)</span> 点）</p><div data-align="center"><p><img data-src="/images/phy_intro/3d_c.svg" width="30%" height="30%"></p></div><p><span class="math display">\[ C:(X + \boldsymbol{R}) - P = 0 \\ \qquad \\ \dot{C} = \left[\begin{matrix} V_x \\ V_y \\ V_z \end{matrix}\right] + \left[\begin{matrix} \omega_x \\ \omega_y \\ \omega_z \end{matrix}\right] \times \left[\begin{matrix} R_x \\ R_y \\ R_z \end{matrix}\right] = \left[\begin{matrix} 0 \\ 0 \\ 0 \end{matrix}\right] \]</span></p><div class="note success"><p><span class="math inline">\(X\)</span>：立方体位置<br><span class="math inline">\(\boldsymbol{R}\)</span>：中心到角落的向量<br><span class="math inline">\(P\)</span>：空间定住的点<br>做微分后，<span class="math inline">\(P\)</span> 常数项，微分后为 <span class="math inline">\(0\)</span><br>刚体速度公 <span class="math inline">\(\dot{C}\)</span> 式查阅 <a href="#ref-anchor-7"><sup>7</sup></a></p></div><p>带入一般方程（将 <span class="math inline">\(\dot{C}\)</span> 写成雅克比矩阵形式）：</p><p><span class="math display">\[\begin{aligned} JV &amp;+ b = 0 \\ J &amp;= \left[\begin{array}{ccc:ccc} 1 &amp; 0 &amp; 0 &amp; 0 &amp; R_z &amp; -R_y \\ 0 &amp; 1 &amp; 0 &amp; -R_z &amp; 0 &amp; R_x \\ 0 &amp; 0 &amp; 1 &amp;R_y &amp; -R_x &amp; 0 \end{array}\right] \\ \qquad \\ &amp;= [E \quad S] \\ \qquad \\ E &amp;= \left[\begin{matrix} 1 &amp; 0 &amp; 0 \\ 0 &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{matrix}\right] \\ \qquad \\ S &amp;= \left[\begin{matrix} 0 &amp; R_z &amp; -R_y \\ -R_z &amp; 0 &amp; R_x \\ R_y &amp; -R_x &amp; 0 \end{matrix}\right] \end{aligned} \]</span></p><div class="note success"><p><span class="math inline">\(S\)</span> 是两个向量的叉积矩阵<br>对照 <span class="math inline">\(\dot{C}\)</span> 的形式，既可以知道 <span class="math inline">\(J\)</span> 是一个 <span class="math inline">\(3 * 6\)</span> 的矩阵，速度 <span class="math inline">\(V\)</span> 是一个 <span class="math inline">\(6 * 1\)</span> 的矩阵，<span class="math inline">\(JV\)</span></p></div><p>开始推导过程：</p><p><span class="math display">\[\begin{aligned} b &amp;= \frac{\beta}{\Delta t} C \\ C &amp;= (X + \boldsymbol{R}) - P \\ M &amp;= \left[\begin{matrix} mE &amp; 0\\ 0 &amp; 1 \end{matrix}\right] \\ \qquad \\ \lambda &amp;= (JM^{-1}J^T)^{-1}[-(JV + b)] \\ &amp;= \left([E \quad S] \left[\begin{matrix} \frac{1}{m}E &amp; 0 \\ 0 &amp; \boldsymbol{I}^{-1} \end{matrix}\right] \left[\begin{matrix} E \\ S^T \end{matrix}\right]\right)^{-1} [-(JV+b)] \\ &amp;= (\frac{1}{m}E+S\boldsymbol{I}^{-1}S^T)^{-1}[-(JV+b)] \\ \qquad \\ \Delta V &amp;= M^{-1}J^T\lambda=\left[\begin{matrix} \frac{1}{m}\lambda \\ \quad \\ \boldsymbol{I}^{-1}S^T\lambda \end{matrix}\right] \end{aligned}\]</span></p><p>代码实现以及注释：</p><div data-align="center"><p><img data-src="/images/phy_intro/point_c_show.png" width="100%" height="100%"></p></div><div class="note success"><p><span class="math inline">\(a\)</span>：是角速度</p></div><p>运行效果：</p><div data-align="center"><p><img data-src="/images/phy_intro/point_show_f.gif" width="40%" height="40%"></p></div><h1 id="参考资料">参考资料</h1><div id="ref-anchor-1"></div><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/62356261">1.UE4物理模块（三）---碰撞查询（下）SAP/MBP/BVH算法简介</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/423120746">2. 从零手写游戏引擎21：物理引擎基础</a></p><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=5zxaToMXidg">3.游戏物理约束Part 1 - 约束基础</a></p><div id="ref-anchor-4"></div><p><a target="_blank" rel="noopener" href="https://github.com/TheAllenChou/unity-physics-constraints">4.周明伦-游戏物理约束</a></p><div id="ref-anchor-5"></div><p><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh/%E8%BD%89%E5%8B%95%E6%85%A3%E9%87%8F%E5%88%97%E8%A1%A8">5.常用转动惯量列表</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/143003234">6.游戏物理引擎(四) 约束</a></p><div id="ref-anchor-7"></div><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-sg/%E8%A7%92%E9%80%9F%E5%BA%A6">7.刚体角速度</a></p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></div><footer class="post-footer"><div class="license"><div class="license-title">物理模拟过程简介</div><div class="license-link"><a href="https://www.xianlongok.site/post/4dab7192/">https://www.xianlongok.site/post/4dab7192/</a></div><div class="license-meta"><div class="license-meta-item"><div class="license-meta-title">本文作者</div><div class="license-meta-text">小贤</div></div><div class="license-meta-item"><div class="license-meta-title">发布于</div><div class="license-meta-text">2022-09-01</div></div><div class="license-meta-item"><div class="license-meta-title">更新于</div><div class="license-meta-text">2022-09-02</div></div><div class="license-meta-item"><div class="license-meta-title">许可协议</div><div class="license-meta-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank">CC BY-NC-SA 4.0</a></div></div></div><div class="license-statement">转载或引用本文时，请遵守上述许可协议，注明出处、不得用于商业用途！</div></div><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a href="/post/d6327b48/" rel="next" title="PBD - Position Based Dynamics">PBD - Position Based Dynamics <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fas fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">小贤</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">197k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">2:59</span></span></div><div class="powered"><a href="https://dlzhang.com" rel="noopener" target="_blank">小贤</a>使用 <a href="https://hexo.io" rel="noopener" target="_blank">Hexo</a> <a href="https://theme-next.js.org" rel="noopener" target="_blank">NexT</a> 设计搭建</div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"dkLUcqHORjRdwQiwRPJMs00N-gzGzoHsz","app_key":"EhWnaex3YyY7bQysJ2SFnukE","server_url":null,"security":false}</script><script src="/js/third-party/statistics/lean-analytics.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script><script src="/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline-comment-nfec4vcyk-qq317423892.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"libUrl":"https://unpkg.com/@waline/client@v2/dist/waline.js","login":"disable","meta":["nick","mail","link"],"requiredMeta":["nick","mail"],"pageSize":5,"dark":"auto","emoji":false,"locale":{"placeholder":"请正确填写邮箱方便查收回复，评论通过审核才会显示。","admin":"站长","nick":"名称*","mail":"邮箱*","link":"网址"},"el":"#waline","comment":true,"path":"/post/4dab7192/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>document.addEventListener("page:loaded",()=>{NexT.utils.loadComments(CONFIG.waline.el).then(()=>NexT.utils.getScript(CONFIG.waline.libUrl,{condition:window.Waline})).then(()=>Waline.init(Object.assign({},CONFIG.waline,{el:document.querySelector(CONFIG.waline.el)})))})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body></html>