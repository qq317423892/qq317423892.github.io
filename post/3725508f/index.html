<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#e7ddc8" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#181c27" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="/./images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/./images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/./images/favicon-16x16-next.png"><link rel="mask-icon" href="/./images/safari-pinned-tab-next.svg" color="#e7ddc8"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic%7CLong+Cang:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.xianlongok.site","root":"/","images":"/blog/images/","scheme":"Gemini","darkmode":true,"version":"8.17.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":null,"post_body":null,"coll_header":null,"sidebar":"fadeInDown"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="硬阴影 对于点光源来说，它只会产生硬阴影。    shadow maping 基本原理 点光源的 Shadow Map 算法，分为两个PASS   * PASS 0：从光源位置看向场景，并且计算出光源到能看到的最近的物体的深度图，并将深度存起来作为Shadow Map    &#x2F;&#x2F; shadowVertex.glsl &#x2F;&#x2F; ... void main(void) {   vNormal &#x3D; aNor"><meta property="og:type" content="article"><meta property="og:title" content="实时阴影技术"><meta property="og:url" content="https://www.xianlongok.site/post/3725508f/index.html"><meta property="og:site_name" content="十三"><meta property="og:description" content="硬阴影 对于点光源来说，它只会产生硬阴影。    shadow maping 基本原理 点光源的 Shadow Map 算法，分为两个PASS   * PASS 0：从光源位置看向场景，并且计算出光源到能看到的最近的物体的深度图，并将深度存起来作为Shadow Map    &#x2F;&#x2F; shadowVertex.glsl &#x2F;&#x2F; ... void main(void) {   vNormal &#x3D; aNor"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/start.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sm_ps0.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/depth.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sm_ps1.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/hard_shadow_map_self.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sm_sf.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sm_sf_1.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sm_sf_2.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/hard_shadow_map_bias.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sm_sf_3.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/second_dp.jpg"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sm_size.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/csm.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/csm_2.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/pcf_sample.webp"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sample_func.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/pcf_size.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/pcf_256.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/big_light.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/soft_shadow_pcss.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/penumbra_cmp.svg"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/pcss_w.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/pcss_cmp.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/pdf_g.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/cdf.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/qbxu_g.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/calc_blocker.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/mipmap.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sat_1.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sat_2.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/vssm_exp.jpg"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/vssm_err1.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/vssm_err2.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/vssm_err2_exp.jpg"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/vssm_err3.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/msv.jpg"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/msv_exp.jpg"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sdf_sm_1.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sdf_sm_2.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sdf_sm_3.png"><meta property="og:image" content="https://www.xianlongok.site/images/shadow_map/sdf_sm_4.png"><meta property="article:published_time" content="2023-08-12T06:25:05.000Z"><meta property="article:modified_time" content="2023-08-12T06:54:26.842Z"><meta property="article:author" content="小贤"><meta property="article:tag" content="Shadow map"><meta property="article:tag" content="PCF"><meta property="article:tag" content="PCSS"><meta property="article:tag" content="SDF"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.xianlongok.site/images/shadow_map/start.png"><link rel="canonical" href="https://www.xianlongok.site/post/3725508f/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.xianlongok.site/post/3725508f/","path":"post/3725508f/","title":"实时阴影技术"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>实时阴影技术 | 十三</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-2Y4JGXG8FG"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-2Y4JGXG8FG","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><link rel="dns-prefetch" href="https://www.xianlongok.work"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">十三</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">安心学技术</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-splotch fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fas fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-tools"><a href="/tools/" rel="section"><i class="fas fa-wrench fa-fw"></i>工具</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fas fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fas fa-book fa-fw"></i>留言板</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E9%98%B4%E5%BD%B1"><span class="nav-number">1.</span> <span class="nav-text">硬阴影</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#shadow-maping-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.</span> <span class="nav-text">shadow maping 基本原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9"><span class="nav-number">1.2.</span> <span class="nav-text">缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E9%81%AE%E6%8C%A1shadow-ance"><span class="nav-number">1.2.1.</span> <span class="nav-text">自遮挡（Shadow Ance）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%E5%81%8F%E7%A7%BB%E5%80%BC"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">增加一个偏移值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%A8%E6%80%81-bias"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">动态 Bias</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%B7%B1%E5%BA%A6%E6%B3%95"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">第二深度法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%AF%E9%BD%BF"><span class="nav-number">1.2.2.</span> <span class="nav-text">锯齿</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BA%A7%E8%81%94%E9%98%B4%E5%BD%B1%E8%B4%B4%E5%9B%BE-csmcascade-shadow-map"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">级联阴影贴图 CSM（Cascade Shadow Map）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pcf-percentage-closer-filtering"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">PCF (Percentage closer filtering)</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AF%E9%98%B4%E5%BD%B1"><span class="nav-number">2.</span> <span class="nav-text">软阴影</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pcss-percentage-closer-soft-shadows"><span class="nav-number">2.1.</span> <span class="nav-text">PCSS (Percentage closer soft shadows)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#penumbra-size%E5%8D%8A%E5%BD%B1%E7%9A%84%E5%A4%A7%E5%B0%8F"><span class="nav-number">2.1.1.</span> <span class="nav-text">Penumbra Size（半影的大小）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9-1"><span class="nav-number">2.1.2.</span> <span class="nav-text">缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vssm-%E6%96%B9%E5%B7%AE%E8%BD%AF%E9%98%B4%E5%BD%B1%E6%98%A0%E5%B0%84%E7%AE%97%E6%B3%95-variance-soft-shadow-mapping"><span class="nav-number">2.2.</span> <span class="nav-text">VSSM 方差软阴影映射算法 (Variance soft shadow mapping)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E9%80%9F-pcf-%E8%AE%A1%E7%AE%97%E6%96%B9%E6%A1%88"><span class="nav-number">2.2.1.</span> <span class="nav-text">加速 PCF 计算方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E9%80%9F-block-search-%E8%AE%A1%E7%AE%97%E6%96%B9%E6%A1%88"><span class="nav-number">2.2.2.</span> <span class="nav-text">加速 Block Search 计算方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%BA%E5%9F%9F%E5%9D%87%E5%80%BC"><span class="nav-number">2.2.3.</span> <span class="nav-text">区域均值</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mipmap"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">Mipmap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#satsummed-area-table%E4%BA%8C%E7%BB%B4%E9%9D%A2%E7%A7%AF%E5%89%8D%E7%BC%80%E5%92%8C"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">SAT（Summed-Area Table）二维面积前缀和</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vssm-%E6%95%88%E6%9E%9C"><span class="nav-number">2.2.4.</span> <span class="nav-text">VSSM 效果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vssm-%E7%BC%BA%E7%82%B9"><span class="nav-number">2.2.5.</span> <span class="nav-text">VSSM 缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#msmmoment-shadow-mapping"><span class="nav-number">2.3.</span> <span class="nav-text">MSM（Moment Shadow Mapping）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#distance-field-soft-shadows%E8%B7%9D%E7%A6%BB%E5%9C%BA%E8%BD%AF%E9%98%B4%E5%BD%B1"><span class="nav-number">2.4.</span> <span class="nav-text">Distance Field Soft Shadows（距离场软阴影）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%82%B9"><span class="nav-number">2.4.1.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9-2"><span class="nav-number">2.4.2.</span> <span class="nav-text">缺点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">3.</span> <span class="nav-text">参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="小贤" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">小贤</p><div class="site-description" itemprop="description">Watch and learn, your magic is mine!</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">25</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">21</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">38</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/qq317423892" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qq317423892" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a> </span><span class="links-of-author-item"><a href="mailto:xianlongok@163.com" title="E-Mail → mailto:xianlongok@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a></span></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://scorpioq.github.io/" title="https:&#x2F;&#x2F;scorpioq.github.io&#x2F;" rel="noopener" target="_blank">ScorpioQ</a></li><li class="links-of-blogroll-item"><a href="https://www.cnblogs.com/lastkiss/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;lastkiss&#x2F;" rel="noopener" target="_blank">邪妖怪のBlog</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.xianlongok.site/post/3725508f/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="小贤"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="十三"><meta itemprop="description" content="Watch and learn, your magic is mine!"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="实时阴影技术 | 十三"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">实时阴影技术</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-08-12 14:25:05" itemprop="dateCreated datePublished" datetime="2023-08-12T14:25:05+08:00">2023-08-12</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%9B%BE%E5%BD%A2%E6%B8%B2%E6%9F%93/" itemprop="url" rel="index"><span itemprop="name">图形渲染</span></a> </span></span><span id="/post/3725508f/" class="post-meta-item leancloud_visitors" data-flag-title="实时阴影技术" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/post/3725508f/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/post/3725508f/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>11k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>10 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="硬阴影">硬阴影</h2><p>对于点光源来说，它只会产生硬阴影。</p><div data-align="center"><p><img data-src="/images/shadow_map/start.png" width="70%" height="70%"></p></div><h3 id="shadow-maping-基本原理">shadow maping 基本原理</h3><p>点光源的 <strong>Shadow Map</strong> 算法，分为两个 <strong>PASS</strong></p><ul><li><strong>PASS 0</strong>：从光源位置看向场景，并且计算出光源到能看到的最近的物体的深度图，并将深度存起来作为 <strong>Shadow Map</strong></li></ul><div data-align="center"><p><img data-src="/images/shadow_map/sm_ps0.png" width="40%" height="40%"></p></div><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// shadowVertex.glsl</span>
<span class="token comment">// ...</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  vNormal <span class="token operator">=</span> aNormalPosition<span class="token punctuation">;</span>
  vTextureCoord <span class="token operator">=</span> aTextureCoord<span class="token punctuation">;</span>
  gl_Position <span class="token operator">=</span> uLightMVP <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// shadowFragment.glsl</span>
<span class="token comment">// ...</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment">// 将 z 拆分到 4 个通道存储</span>
  gl_FragColor <span class="token operator">=</span> <span class="token function">pack</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如下图， Shadow Map 记录了 Light Camera 所看到的最近的深度图，颜色越深，离相机越近</p><div data-align="center"><p><img data-src="/images/shadow_map/depth.png" width="40%" height="40%"></p></div><ul><li><strong>PASS 1</strong>：然后第二个 <strong>PASS</strong> 从相机出发，使用第一个 <strong>PASS</strong> 得到的 <strong>Shadow map</strong>，去判断渲染的像素点，是否在阴影中（计算当前点到光源距离，跟 <strong>Shadow map</strong> 中采样的深度作比较），最终计算得出 Visibility（<strong>0 or 1</strong>）</li></ul><div data-align="center"><p><img data-src="/images/shadow_map/sm_ps1.png" width="40%" height="40%"></p></div><div class="note success"><p><strong>太阳</strong> 表示灯光位置，<strong>绿色线</strong> 表示场景中的物体 右图中，第一个点计算得出的数值跟阴影图中数据一致 右图中，第二个点计算出来的距离比阴影贴图中的大，因此改点在阴影里</p></div><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// phongVertex.glsl</span>
<span class="token comment">// ...</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  vNormal <span class="token operator">=</span> <span class="token punctuation">(</span>uModelMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aNormalPosition<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
  vTextureCoord <span class="token operator">=</span> aTextureCoord<span class="token punctuation">;</span>
  vFragPos <span class="token operator">=</span> <span class="token punctuation">(</span>uModelMatrix <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
  vPositionFromLight <span class="token operator">=</span> uLightMVP <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl_Position <span class="token operator">=</span> uProjectionMatrix <span class="token operator">*</span> uViewMatrix <span class="token operator">*</span> uModelMatrix
    <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// phongFragment.glsl </span>
<span class="token comment">// ...</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// 归一化坐标</span>
    <span class="token keyword">vec3</span> projCoords <span class="token operator">=</span> vPositionFromLight<span class="token punctuation">.</span>xyz <span class="token operator">/</span> vPositionFromLight<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> shadowCoord <span class="token operator">=</span> projCoords <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    <span class="token comment">// Shadow  1.0 表示没有阴影 0 表示阴影</span>
    <span class="token keyword">float</span> visibility <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    
    <span class="token comment">//将rgba四通道（32位）的值unpack成float类型的数值</span>
    <span class="token keyword">float</span> depthInShadowmap <span class="token operator">=</span> <span class="token function">unpack</span><span class="token punctuation">(</span><span class="token function">texture2D</span><span class="token punctuation">(</span>shadowMap<span class="token punctuation">,</span>shadowCoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">.</span>rgba<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span>depthInShadowmap <span class="token operator">&lt;</span> shadowCoord<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        visibility <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// blinnPhong光照着色</span>
    <span class="token keyword">vec3</span> color <span class="token operator">=</span> <span class="token function">blinnPhong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>color <span class="token operator">*</span> visibility<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="缺点">缺点</h3><p>传统的 <strong>Shadow Map</strong> 技术存在一些缺陷：</p><h4 id="自遮挡shadow-ance">自遮挡（Shadow Ance）</h4><p>传统的 <strong>Shadow Map</strong> 存在由数值精度造成的自遮挡问题，即在下图中看到的地面上的不正确的纹路：</p><div data-align="center"><p><img data-src="/images/shadow_map/hard_shadow_map_self.png" width="90%" height="90%"></p></div><p>这是因为 shadow map 的分辨率太低。因为 shadow map 贴图的分辨率过低，阴影贴图的一个纹素会对应多个像素，而这些像素在shadow map空间中的深度是不同的，因此就会出现自己遮挡自己的情况，当光照与投影面垂直时，几乎不存在自遮挡现象，当光照向与平面接近平行时，平面会产生严重的自遮挡现象。</p><div data-align="center"><p><img data-src="/images/shadow_map/sm_sf.png" width="40%" height="40%"></p></div><div data-align="center"><p><img data-src="/images/shadow_map/sm_sf_1.png" width="65%" height="65%"></p></div><div class="note success"><p>每个蓝色线隔开的地方，计算出来的深度一样，用黄色线条表示，但实际上，靠右侧的实际深度要大一些，因此，计算是否可见时，就容易出现自遮挡。（橙色箭头所示，实际深度还要加上灰色线段部分，如上图）</p></div><h5 id="增加一个偏移值">增加一个偏移值</h5><p>最简单的方法就是，直接给采样阴影深度增加一个偏移值：相当于是把阴影深度往远处加，从而不容易产生自遮挡）。</p><div data-align="center"><p><img data-src="/images/shadow_map/sm_sf_2.png" width="65%" height="65%"></p></div><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// phongFragment.glsl</span>
<span class="token comment">//...</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// Shadow</span>
    <span class="token keyword">float</span> visibility <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token comment">// BIAS 调很大，为了显示漏光 bug</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span> BIAS <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>

    <span class="token comment">//// 增加了 BIAS</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>depthInShadowmap <span class="token operator">+</span> BIAS <span class="token operator">&lt;</span> shadowCoord<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        visibility <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，自遮挡问题解决了，但是因为增加了 Bias，可能导致影子悬空。（<strong>Peter Panning 现象</strong>在物体缝隙间漏光，特别是遮挡物厚度小于 Bias 时）</p><div class="note success"><p>Peter Pan 是童话故事里的彼得潘，他是个会飞的男孩，而 panning 有平移、悬浮之意</p></div><div data-align="center"><p><img data-src="/images/shadow_map/hard_shadow_map_bias.png" width="80%" height="80%"></p></div><blockquote><p>有另外一种跟 Bias 不太一样的方法（实际上原理相同）</p><ol type="1"><li>不使用 Bias</li><li>第一个 Pass 设置成仅渲染背面（正面剔除），对于有厚度的物体，相当于是增加了遮挡物渲染后的深度大小</li></ol><div data-align="center"><p><img data-src="/images/shadow_map/sm_sf_3.png" width="65%" height="65%"></p></div><p>本来深度值应该是正方块上表面的距离，使用正面剔除后，深度值是正方块的下表面的距离了</p></blockquote><ul><li>解决办法：避免使用单薄的几何体</li></ul><h5 id="动态-bias">动态 Bias</h5><p>通过之前的介绍，使用过大的 Bias 增加深度的方法会导致影悬空问题，而过小的 Bias 又解决不了自遮挡问题，自遮挡问题产生又跟光线的角度有关系，因此可以采取根据平面倾角来自适应 Bias</p><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">float</span> MIN_BIAS <span class="token operator">=</span> <span class="token number">0.005</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> BIAS <span class="token operator">=</span> <span class="token number">0.05</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> bias <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>BIAS <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> lightDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MIN_BIAS<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="第二深度法">第二深度法</h5><p>第二种解决办法是在计算光照方向的深度时，同时计算得到最小深度以及第二小的深度，然后用这两个的中间值作为最终深度存放到 <strong>Shadow Map</strong> 中</p><div data-align="center"><p><img data-src="/images/shadow_map/second_dp.jpg" width="60%" height="60%"></p></div><div class="note success"><p>如上图所示，需要两个 <strong>PASS</strong> 来生成阴影贴图，第一个 <strong>PASS</strong> 设置背面剔除，第二个 <strong>PASS</strong> 设置为前向面剔除，这样就能分别获得两个深度，最后得出平均深度</p></div><p>但是这种方法要求遮挡物（投射阴影的物体）必须是闭合曲面（watertight），必须有正反面，然后会多增加一个 <strong>PASS</strong> 带来更大的开销，因此没有得到广泛应用。</p><h4 id="锯齿">锯齿</h4><p>第二个缺点就是生成的 <strong>Shadow Map</strong> 分辨率是有限的，如果阴影面积过大，就会产生锯齿（Aliasing）</p><div data-align="center"><p><img data-src="/images/shadow_map/sm_size.png" width="100%" height="100%"></p></div><h5 id="级联阴影贴图-csmcascade-shadow-map">级联阴影贴图 CSM（Cascade Shadow Map）</h5><p>当 Shadow Mapping 应用在大型场景中时，一张正常分辨率大小（如1024×1024）的贴图用来记录整个大型场景的阴影深度信息是非常不精确的，尤其是在靠近主摄像机的地方所看到的阴影将是严重失真的（一块块栅格）。</p><p><strong>CSM</strong> 的思想是使用多层 <strong>Shadow Map</strong> 将视锥按照距离划分成多个阴影区，相机附近提供更高分辨率的深度纹理，而在远处提供更低分辨率的纹理，来帮助解决走样问题。</p><div data-align="center"><p><img data-src="/images/shadow_map/csm.png" width="40%" height="40%"></p></div><div data-align="center"><p><img data-src="/images/shadow_map/csm_2.png" width="80%" height="80%"></p></div><h5 id="pcf-percentage-closer-filtering">PCF (Percentage closer filtering)</h5><p>之前使用的 Shadow Maping 技术中，进行深度比较时，只对阴影贴图采样一次作比较，PCF 算法为了解决锯齿问题，采样时会在 **对应点周围一定范围的像素 (例如下图 5*5)<strong> 进行多重采样，然后把采样区域内所有像素深度比较后的结果求平均得出最后的值，因此得出的 Visibility 不在是非 </strong>0<strong> 即 </strong>1**，而是带有渐变的取值。</p><div data-align="center"><p><img data-src="/images/shadow_map/pcf_sample.webp" width="70%" height="70%"></p></div><div class="note success"><p>上面这得出的最终 <span class="math inline">\(Visibility = 13 / 25 = 0.52\)</span></p></div><p>采样窗口越大，抗锯齿效果就约好，但是当采样范围变大时，采样的次数成平方次膨胀，开销就会很大，达不到实时渲染的要求，因此我们可以在采样范围内，随机抽取一定个数（<strong>NUM_SAMPLES</strong>）的采样点进行采样，下面是一些常用的分布采样函数。</p><ul><li><p><strong>均匀圆盘分布采样</strong>（Uniform-Disk Sample）：圆范围内随机取一系列坐标作为采样点；看上去比较杂乱无章，采样效果的 noise 比较严重。</p></li><li><p><strong>泊松圆盘分布采样</strong>（Poisson-Disk Sample）：圆范围内随机取一系列坐标作为采样点，但是这些坐标还需要满足一定约束，即坐标与坐标之间至少有一定距离间隔。</p></li></ul><div data-align="center"><p><img data-src="/images/shadow_map/sample_func.png" width="60%" height="60%"></p></div><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NUM_SAMPLES</span> <span class="token expression"><span class="token number">20</span></span></span>
<span class="token keyword">vec2</span> poissonDisk<span class="token punctuation">[</span>NUM_SAMPLES<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 泊松圆盘分布</span>
<span class="token keyword">void</span> <span class="token function">poissonDiskSamples</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> randomSeed <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">float</span> ANGLE_STEP <span class="token operator">=</span> PI2 <span class="token operator">*</span> <span class="token keyword">float</span><span class="token punctuation">(</span> NUM_RINGS <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span> NUM_SAMPLES <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> INV_NUM_SAMPLES <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span> NUM_SAMPLES <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">float</span> angle <span class="token operator">=</span> <span class="token function">rand_2to1</span><span class="token punctuation">(</span> randomSeed <span class="token punctuation">)</span> <span class="token operator">*</span> PI2<span class="token punctuation">;</span>
  <span class="token keyword">float</span> radius <span class="token operator">=</span> INV_NUM_SAMPLES<span class="token punctuation">;</span>
  <span class="token keyword">float</span> radiusStep <span class="token operator">=</span> radius<span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUM_SAMPLES<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    poissonDisk<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token function">cos</span><span class="token punctuation">(</span> angle <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sin</span><span class="token punctuation">(</span> angle <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span> radius<span class="token punctuation">,</span> <span class="token number">0.75</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    radius <span class="token operator">+=</span> radiusStep<span class="token punctuation">;</span>
    angle <span class="token operator">+=</span> ANGLE_STEP<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// 均匀圆盘分布</span>
<span class="token keyword">void</span> <span class="token function">uniformDiskSamples</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> randomSeed <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">float</span> randNum <span class="token operator">=</span> <span class="token function">rand_2to1</span><span class="token punctuation">(</span>randomSeed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> sampleX <span class="token operator">=</span> <span class="token function">rand_1to1</span><span class="token punctuation">(</span> randNum <span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token keyword">float</span> sampleY <span class="token operator">=</span> <span class="token function">rand_1to1</span><span class="token punctuation">(</span> sampleX <span class="token punctuation">)</span> <span class="token punctuation">;</span>

  <span class="token keyword">float</span> angle <span class="token operator">=</span> sampleX <span class="token operator">*</span> PI2<span class="token punctuation">;</span>
  <span class="token keyword">float</span> radius <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>sampleY<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUM_SAMPLES<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    poissonDisk<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> radius <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token punctuation">,</span> radius <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>

    sampleX <span class="token operator">=</span> <span class="token function">rand_1to1</span><span class="token punctuation">(</span> sampleY <span class="token punctuation">)</span> <span class="token punctuation">;</span>
    sampleY <span class="token operator">=</span> <span class="token function">rand_1to1</span><span class="token punctuation">(</span> sampleX <span class="token punctuation">)</span> <span class="token punctuation">;</span>

    angle <span class="token operator">=</span> sampleX <span class="token operator">*</span> PI2<span class="token punctuation">;</span>
    radius <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>sampleY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="note success"><p>其中， <strong>rand_2to1</strong>, <strong>rand_1to1</strong> <a href="#ref-anchor-1"><sup>1</sup></a> 是利用 <span class="math inline">\(sin\)</span> 函数特效实现的伪随机函数</p></div><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// 伪随机函数</span>
<span class="token keyword">highp</span> <span class="token keyword">float</span> <span class="token function">rand_1to1</span><span class="token punctuation">(</span><span class="token keyword">highp</span> <span class="token keyword">float</span> x <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
  <span class="token comment">// -1 -1</span>
  <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10000.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">highp</span> <span class="token keyword">float</span> <span class="token function">rand_2to1</span><span class="token punctuation">(</span><span class="token keyword">vec2</span> uv <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
  <span class="token comment">// 0 - 1</span>
  <span class="token keyword">const</span> <span class="token keyword">highp</span> <span class="token keyword">float</span> a <span class="token operator">=</span> <span class="token number">12.9898</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">78.233</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">43758.5453</span><span class="token punctuation">;</span>
  <span class="token keyword">highp</span> <span class="token keyword">float</span> dt <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span> uv<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> a<span class="token punctuation">,</span>b <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> sn <span class="token operator">=</span> <span class="token function">mod</span><span class="token punctuation">(</span> dt<span class="token punctuation">,</span> PI <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span> <span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PCF 算法过程：</p><ul><li>计算 Visibility 时，原本对 <strong>Shadow Map</strong> 的一次坐标采样，换成对周围一定范围内若干个坐标进行采样</li><li>各个采样后的结果跟之前实际深度 <span class="math inline">\(z^{&#39;}\)</span> 做比较，最后去平均值作为 Visibility</li></ul><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">float</span> <span class="token function">PCF</span><span class="token punctuation">(</span><span class="token keyword">sampler2D</span> shadowMap<span class="token punctuation">,</span> <span class="token keyword">vec4</span> coords<span class="token punctuation">,</span> <span class="token keyword">float</span> filterSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token keyword">float</span> bias <span class="token operator">=</span> <span class="token number">0.005</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> sum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化泊松分布</span>
  <span class="token function">poissonDiskSamples</span><span class="token punctuation">(</span>coords<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 采样</span>
 
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> NUM_SAMPLES<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> depthInShadowmap <span class="token operator">=</span> <span class="token function">unpack</span><span class="token punctuation">(</span><span class="token function">texture2D</span><span class="token punctuation">(</span>shadowMap<span class="token punctuation">,</span> 
        coords<span class="token punctuation">.</span>xy <span class="token operator">+</span> poissonDisk<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> filterSize<span class="token punctuation">)</span><span class="token punctuation">.</span>rgba<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sum <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>depthInShadowmap <span class="token operator">+</span> bias<span class="token punctuation">)</span> <span class="token operator">&lt;</span> coords<span class="token punctuation">.</span>z <span class="token operator">?</span> <span class="token number">0.0</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 返还平均采样结果</span>
  <span class="token keyword">return</span> sum<span class="token operator">/</span><span class="token keyword">float</span><span class="token punctuation">(</span>NUM_SAMPLES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">float</span> visibility <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
  <span class="token keyword">vec3</span> shadowCoordNDC <span class="token operator">=</span> 
    <span class="token punctuation">(</span>vPositionFromLight<span class="token punctuation">.</span>xyz <span class="token operator">/</span> vPositionFromLight<span class="token punctuation">.</span>w <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>

  <span class="token comment">// fiterSize 参数会影响实际采样区域的范围</span>
  visibility <span class="token operator">=</span> <span class="token function">PCF</span><span class="token punctuation">(</span>uShadowMap<span class="token punctuation">,</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>shadowCoordNDC<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">vec3</span> phongColor <span class="token operator">=</span> <span class="token function">blinnPhong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>phongColor <span class="token operator">*</span> visibility<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>效果如下图所示，当 fiterSize 很小时，抗锯齿效果不明显（fiterSize = 0.0001），而当 fiterSize 逐渐增大时，阴影的边缘渐变效果越来越明显（ <strong>Shadow Map</strong> 的大小为 2048 * 2048）</p><div data-align="center"><p><img data-src="/images/shadow_map/pcf_size.png" width="100%" height="100%"></p></div><p>当 <strong>Shadow Map</strong> 尺寸为 256 * 256 时，效果如下图：</p><div data-align="center"><p><img data-src="/images/shadow_map/pcf_256.png" width="100%" height="100%"></p></div><div class="note success"><p>PCF 通过增加采样区域范围，来做抗锯齿，当过滤范围变大时，逐渐有了软阴影的效果，因此，我们可以使用 PCF 的原理，来实现软阴影。</p></div><h2 id="软阴影">软阴影</h2><p>较大的光源面在被物体遮挡时，阴影接收物上会有一部分区域被遮蔽了一部分光线，从而产生半影（Penumbra）。</p><div data-align="center"><p><img data-src="/images/shadow_map/big_light.png" width="50%" height="50%"></p></div><h3 id="pcss-percentage-closer-soft-shadows">PCSS (Percentage closer soft shadows)</h3><p>之前介绍的 PCF 里，我们通过改变采样窗口，可以调整阴影整体的软硬程度，因此可以用这个方法来实现软阴影，不过我们注意到，投影面到遮挡物距离，会影响阴影的软化程度</p><div data-align="center"><p><img data-src="/images/shadow_map/soft_shadow_pcss.png" width="90%" height="90%"></p></div><div class="note success"><p>钢笔尖的阴影距离钢笔近，产生的阴影很硬，轮廓很分明，笔身距离钢笔远，产生的阴影就很软，阴影边缘不清晰</p></div><p>因此，当我们对 PCF 进行一些改进，自动根据边缘半影的大小来计算过滤半径，就能很好的实现软阴影的效果，这就是 PCSS 的核心原理。</p><h4 id="penumbra-size半影的大小">Penumbra Size（半影的大小）</h4><p>根据半影的产生原因我们可以得出下面这个图</p><div data-align="center"><p><img data-src="/images/shadow_map/penumbra_cmp.svg" width="80%" height="80%"></p></div><p>半影的大小取决于光源的大小（<span class="math inline">\(W_{Light}\)</span>）以及距离遮挡物（Blocker）的距离（<span class="math inline">\(d_{Receiver}\)</span>）</p><div data-align="center"><p><img data-src="/images/shadow_map/pcss_w.png" width="40%" height="40%"></p></div><p><span class="math display">\[ w_{Penumbra} = \frac{(d_{Receiver} - d_{Blocker})* w_{light}}{d_{Blocker}} \]</span></p><div class="note success"><p><span class="math inline">\(w_{Penumbra}\)</span> : 半影的长度 <span class="math inline">\(d_{Receiver}\)</span> : 阴影接收区域到光源距离 <span class="math inline">\(d_{Blocker}\)</span> : 遮挡物到到光源距离 <span class="math inline">\(w_{light}\)</span> : 光源的大小 <span class="math inline">\(w_{Penumbra}\)</span> 半影的长度可以看成是软阴影的范围</p></div><p>因此 PCSS 算法分为下面几个过程：</p><ul><li>Blocker Search：计算得出 <span class="math inline">\(d_{Blocker}\)</span></li><li>计算得出半影大小</li><li>根据半影大小做 PCF</li></ul><div class="note success"><ol type="1"><li>一般来说，Blocker Search 的时候不会只找单个像素点来获取 <span class="math inline">\(d_{Blocker}\)</span>，会在像素周围一定范围内找遮挡，然后将所有是遮挡区域的深度求和再取平均值</li><li>对应大面积的灯光，理论上是不会产生硬阴影，因此一般会使用灯光的中心点作为点光源，生成 <strong>Shadow Map</strong></li></ol></div><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NUM_SAMPLES</span> <span class="token expression"><span class="token number">20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLOCKER_SEARCH_NUM_SAMPLES</span> <span class="token expression">NUM_SAMPLES</span></span>

<span class="token comment">// 在附近 40 * 40 的范围内抽取 100 个像素点计算遮挡物平均深度</span>
<span class="token keyword">float</span> <span class="token function">findBlocker</span><span class="token punctuation">(</span> <span class="token keyword">sampler2D</span> shadowMap<span class="token punctuation">,</span>  <span class="token keyword">vec2</span> uv<span class="token punctuation">,</span> <span class="token keyword">float</span> zReceiver <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 初始化泊松分布</span>
  <span class="token function">poissonDiskSamples</span><span class="token punctuation">(</span>coords<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">int</span> radius <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">vec2</span> texelSize <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">2048.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token number">2048.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> cnt <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> depthSum <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> is_block <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> EPS <span class="token operator">=</span> <span class="token number">0.002</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ns <span class="token operator">&lt;</span> BLOCKER_SEARCH_NUM_SAMPLES<span class="token punctuation">;</span> <span class="token operator">++</span>ns<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
      <span class="token keyword">vec2</span> sampleCoord <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">vec2</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span> <span class="token operator">*</span> poissonDisk<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> texelSize <span class="token operator">+</span> uv<span class="token punctuation">;</span>
      <span class="token keyword">float</span> depthOnShadowMap <span class="token operator">=</span> <span class="token function">unpack</span><span class="token punctuation">(</span><span class="token function">texture2D</span><span class="token punctuation">(</span>shadowMap<span class="token punctuation">,</span> sampleCoord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      is_block <span class="token operator">=</span> <span class="token function">step</span><span class="token punctuation">(</span>depthOnShadowMap<span class="token punctuation">,</span> zReceiver <span class="token operator">-</span> EPS<span class="token punctuation">)</span>
      cnt <span class="token operator">+=</span> is_block<span class="token punctuation">;</span>
      depthSum <span class="token operator">+=</span> is_block <span class="token operator">*</span> depthOnShadowMap<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>cnt <span class="token operator">&lt;</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> zReceiver<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> depthSum <span class="token operator">/</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">float</span> <span class="token function">PCF</span><span class="token punctuation">(</span><span class="token keyword">sampler2D</span> shadowMap<span class="token punctuation">,</span> <span class="token keyword">vec4</span> shadowCoord<span class="token punctuation">,</span> <span class="token keyword">float</span> radius<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token keyword">vec2</span> texelSize <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">2048.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token number">2048.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> visibility <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> cnt <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>ns <span class="token operator">&lt;</span> PCF_NUM_SAMPLES<span class="token punctuation">;</span><span class="token operator">++</span>ns<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec2</span> sampleCoord <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">vec2</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span> <span class="token operator">*</span> poissonDisk<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> texelSize 
        <span class="token operator">+</span> shadowCoord<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>

    <span class="token keyword">float</span> cloestDepth <span class="token operator">=</span> <span class="token function">unpack</span><span class="token punctuation">(</span><span class="token function">texture2D</span><span class="token punctuation">(</span>shadowMap<span class="token punctuation">,</span> sampleCoord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    visibility <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>shadowCoord<span class="token punctuation">.</span>z <span class="token operator">-</span> <span class="token number">0.001</span><span class="token punctuation">)</span> <span class="token operator">></span> cloestDepth <span class="token operator">?</span> <span class="token number">0.0</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cnt <span class="token operator">+=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> visibility<span class="token operator">/</span>cnt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">float</span> <span class="token function">PCSS</span><span class="token punctuation">(</span><span class="token keyword">sampler2D</span> shadowMap<span class="token punctuation">,</span> <span class="token keyword">vec4</span> shadowCoord<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

  <span class="token comment">// STEP 1: avgblocker depth</span>
  <span class="token keyword">float</span> avgBlockerDepth <span class="token operator">=</span> <span class="token function">findBlocker</span><span class="token punctuation">(</span>shadowMap<span class="token punctuation">,</span> shadowCoord<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> shadowCoord<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// STEP 2: penumbra size</span>
  <span class="token keyword">const</span> <span class="token keyword">float</span> lightWidth <span class="token operator">=</span> <span class="token number">50.0</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> penumbraSize <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>shadowCoord<span class="token punctuation">.</span>z <span class="token operator">-</span> avgBlockerDepth<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> 
    avgBlockerDepth <span class="token operator">*</span> lightWidth<span class="token punctuation">;</span>

  <span class="token comment">// STEP 3: filtering</span>
  <span class="token keyword">return</span> <span class="token function">PCF</span><span class="token punctuation">(</span>shadowMap<span class="token punctuation">,</span> shadowCoord<span class="token punctuation">,</span> penumbraSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//return 1.0;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果如下图所示：</p><div data-align="center"><p><img data-src="/images/shadow_map/pcss_cmp.png" width="100%" height="100%"></p></div><h4 id="缺点-1">缺点</h4><p>从实现步骤上，PCSS 有两个地方非常耗时，需要多次采样图片。</p><ul><li>Blocker Search：计算得出 <span class="math inline">\(d_{Blocker}\)</span></li><li>根据半影大小做 PCF</li></ul><h3 id="vssm-方差软阴影映射算法-variance-soft-shadow-mapping">VSSM 方差软阴影映射算法 (Variance soft shadow mapping)</h3><h4 id="加速-pcf-计算方案">加速 PCF 计算方案</h4><p>从上面的介绍可以得知，PCSS 有两个耗时的地方，我们首先来看 PCF 这个耗时点。PCF 的本质是在特定区域内，对每一个像素都采样深度贴图，将采样的到的值跟当前实际深度对比，小于则返回 0 大于返回 1（例如 10 * 10 的区域内，有 40 个小于的，则最终返回 40 / 100），这个等价于找到当前区域内，给定一个深度 <span class="math inline">\(D_{scene}\)</span>，当前点在 <strong>Shadow Map</strong> 上的深度为 <span class="math inline">\(D_{SM}\)</span>，求 <span class="math inline">\(D_{SM} &gt; D_{scene}\)</span> 的概率 <span class="math inline">\(P(D_{SM} &gt; D_{scene})\)</span></p><div data-align="center"><p><img data-src="/images/shadow_map/pdf_g.png" width="50%" height="50%"></p></div><div class="note success"><p>上图是把当前区域所有的像素值在 <strong>Shadow Map</strong> 上的深度做的直方图，横坐标表示当前深度值，绿色的区域表示当前深度的像素个数，个数越多，柱状图越高，深色区域表示深度大于等于 <strong>12</strong> 的像素个数</p></div><p>VSSM 的思想是，将某个区域的深度值近似的看成是正态分布，那对于一个正态分布我们只需要知道两个变量均值（期望）<span class="math inline">\(E\)</span>，方差 <span class="math inline">\(Var\)</span>，平均值很好求，方差可以用下面的公式求得：</p><p><span class="math display">\[ Var(X) = E(X^2)-E^2(X) \]</span></p><div class="note success"><ol type="1"><li><span class="math inline">\(E(X)\)</span>: 深度图某个区域内像素的平均值</li><li><span class="math inline">\(E^2(x)\)</span>：另外一张深度图，记录的是深度值的平方，求给定区域像素的平均值</li><li>怎么快速计算指定区域内像素的均值，后面会讲</li></ol></div><p>当我们有了期望跟方差后，就能得出一个正态分布的函数图，那我们之前要求的百分比 <span class="math inline">\(P(D_{SM} &gt; D_{scene})\)</span>，就是下图中 <strong>1 - 阴影的面积</strong>：</p><div data-align="center"><p><img data-src="/images/shadow_map/cdf.png" width="50%" height="50%"></p></div><p>VSSM 为了求解上面的百分比，使用切比雪夫不等式来求解，切比雪夫不需要知道具体的分布函数的，不一定需要是正态分布。</p><p><span class="math display">\[ \begin{align*} P(x &gt; t) &amp;\leq \frac{\sigma ^2}{\sigma ^2 + (t - \mu)^2} \\ P(x &gt; t) &amp;\approx \frac{\sigma ^2}{\sigma ^2 + (t - \mu)^2} \end{align*} \]</span></p><div data-align="center"><p><img data-src="/images/shadow_map/qbxu_g.png" width="50%" height="50%"></p></div><div class="note success"><p><span class="math inline">\(x\)</span> ：分布函数里的变量 <span class="math inline">\(x\)</span> <span class="math inline">\(t\)</span> ：某个指定的值 <span class="math inline">\(\sigma\)</span> : 标准差 <span class="math inline">\(\mu\)</span> : 均值</p></div><p>限制：</p><ul><li><span class="math inline">\(t\)</span> 必须在均值右边，不然不准（实时渲染里，还是这么使用）</li></ul><h4 id="加速-block-search-计算方案">加速 Block Search 计算方案</h4><p>现在回到第一步 Blocker Search 的计算上，我们有如下区域深度信息，当前像素光照位置的的真实深度是 <strong>7</strong> 则所有深度小于 <strong>7</strong> 的像素就是要找的 Blocker，即下图中的蓝色区域。</p><div data-align="center"><p><img data-src="/images/shadow_map/calc_blocker.png" width="30%" height="30%"></p></div><p>对于这个区域会有下面这个等式成立：<strong><span class="math inline">\(Z_{occ}\)</span></strong> 就是我们要求的 Blocker 的平均深度</p><p><span class="math display">\[ \frac{N_{1}}{N}Z_{unocc} + \frac{N_{2}}{N}Z_{occ} = Z_{avg} \]</span></p><div class="note success"><p>t : 当前深度 <span class="math inline">\(Z_{occ}\)</span>：所有深度小于 <span class="math inline">\(t\)</span> 的深度平均值 <span class="math inline">\(Z_{unocc}\)</span>: 所有深度大于等于 <span class="math inline">\(t\)</span> 的深度的平均值 <span class="math inline">\(N\)</span> : 当前区域像素点个数 <span class="math inline">\(N_1\)</span>：深度大于等于 <span class="math inline">\(t\)</span> 的像素个数 <span class="math inline">\(N_2\)</span>：深度小于 <span class="math inline">\(t\)</span> 的像素个数 <span class="math inline">\(Z_{avg}\)</span>：当前区域所有像素的深度的平均值</p></div><p>沿用之前 PCF 中的假设</p><p><span class="math display">\[\begin{align*} \frac{N_{1}}{N} &amp;= P(x&gt;t) \\ \frac{N_{2}}{N} &amp;= 1 - P(x&gt;t) \end{align*} \]</span></p><p>剩下 <span class="math inline">\(Z_{unocc}\)</span> 不知道值，这个时候，VSSM 做了个大胆的假设，假设投影接收区域是个平面，直接使用估计值，令 <span class="math inline">\(Z_{unocc} = t\)</span>，就能立刻计算出 <span class="math inline">\(Z_{occ}\)</span></p><h4 id="区域均值">区域均值</h4><p>综上所述，不管 PCF，还是 Blocker Search 加速方法，都需要计算某个区域内的像素的均值，均值的求解方法：</p><h5 id="mipmap">Mipmap</h5><p>最简单的方法就是使用 Mipmap 来快速获取贴图上某个区域的均值，但是 Mipmap 获取的值也是通过插值获取的近似值（三线性插值）</p><div data-align="center"><p><img data-src="/images/shadow_map/mipmap.png" width="40%" height="40%"></p></div><h5 id="satsummed-area-table二维面积前缀和">SAT（Summed-Area Table）二维面积前缀和</h5><p>先介绍一维的 SAT，如下图 SAT 存储的是当前位置之前所有的数的总和</p><div data-align="center"><p><img data-src="/images/shadow_map/sat_1.png" width="40%" height="40%"></p></div><div class="note success"><p>当我们要求括号区域的值的平均值时，只需要找到区间前一个位置的和跟区间最后一个位置的和，做减法即可快速得到当前区间内的像素的和。</p></div><p>扩展到二维：</p><ul><li>首先跟一维 SAT 一样，逐行计算每行的 SAT</li><li>然后再逐列遍历，计算每行的 SAT</li></ul><p>然后我们要计算某个区域的平均值时，如下图蓝色框框是我们要计算的区域</p><div data-align="center"><p><img data-src="/images/shadow_map/sat_2.png" width="100%" height="100%"></p></div><p><span class="math display">\[ S = S1 - S2 - S3 + S4 \]</span></p><h4 id="vssm-效果">VSSM 效果</h4><div data-align="center"><p><img data-src="/images/shadow_map/vssm_exp.jpg" width="90%" height="90%"></p></div><h4 id="vssm-缺点">VSSM 缺点</h4><ul><li>假设区域内像素分布为正态分布，如果采样区域不符合正态分布，阴影效果就不正确</li></ul><div data-align="center"><p><img data-src="/images/shadow_map/vssm_err1.png" width="80%" height="80%"></p></div><p>右图的阴影分布呈现比较规则的分布，深度值会几种在三个面片附近，如下图所示，会有三个波峰</p><div data-align="center"><p><img data-src="/images/shadow_map/vssm_err2.png" width="40%" height="40%"></p></div><p>当估计值偏高时，如下图，则计算得出的 Visibility 的值偏大（1 为可见，0 为全黑），就会导致漏光，车底盘出现了漏光现象（Light Leaking）。</p><div data-align="center"><p><img data-src="/images/shadow_map/vssm_err2_exp.jpg" width="80%" height="80%"></p></div><p>当估计值偏小时，得出的阴影会更黑，人眼不容易观察出来。</p><ul><li>之前计算 Blocker Search 的时候， VSSM 大胆假设了投影接收物体是一个平面 <span class="math inline">\(Z_{unocc} = t\)</span>，但实际上有些情况，投影接收物体不一定是个平面</li></ul><div data-align="center"><p><img data-src="/images/shadow_map/vssm_err3.png" width="80%" height="80%"></p></div><div class="note success"><p>左图中的几个面片是倾斜的，是的阴影接收面是一个斜面。</p></div><ul><li>切比雪夫不等式应用上问题：大于均值区域不等式才成立</li></ul><h3 id="msmmoment-shadow-mapping">MSM（Moment Shadow Mapping）</h3><p>MSM 主要是解决在 PCF 阶段，描述分布不准导致漏光的问题，VSSM用深度的均值 <span class="math inline">\(\mu\)</span> 和方差 <span class="math inline">\(\sigma\)</span> 来逼近可见性的累积分布函数，本质上是利用深度值分布的一阶原始矩和二阶中心距，MSM 采用更高阶的矩来进行估计（前四阶矩），不考虑精度的情况下，分别用 <strong>Shadow Map</strong> 的四个通道存储 <span class="math inline">\(z\)</span>，<span class="math inline">\(z^2\)</span>，<span class="math inline">\(z^3\)</span>，<span class="math inline">\(z^4\)</span></p><div data-align="center"><p><img data-src="/images/shadow_map/msv.jpg" width="40%" height="40%"></p></div><div class="note success"><p>可以类比成泰勒展开，保留的次方越高，拟合效果越接近。</p></div><p>下面是 VSM（PCF 的优化版本， VSSM 是 PCSS 的优化版本）对比效果</p><div data-align="center"><p><img data-src="/images/shadow_map/msv_exp.jpg" width="80%" height="80%"></p></div><h3 id="distance-field-soft-shadows距离场软阴影">Distance Field Soft Shadows（距离场软阴影）</h3><p>之前在介绍文本的时候，介绍过 SDF 的文本，距离场也可以用在实时阴影中，假设我们已经知道场景中任何一个点到最近物体的距离场后，可以利用距离场近似计算软阴影，软阴影的产生其实是光源一部分光线被遮挡了，如下图，则半影的大小跟图中的 <span class="math inline">\(\theta\)</span> 角度（当前渲染点到光源中心方向上与最近的遮挡物所形成的最小安全角）成正比。</p><div data-align="center"><p><img data-src="/images/shadow_map/sdf_sm_1.png" width="60%" height="60%"></p></div><div class="note success"><p>SDF 将阴影求解转换求解安全角度</p></div><p>当我们有了整个场景的 SDF 数据后，我们首先从渲染点 <span class="math inline">\(P0\)</span> 出发，找到该点最近遮挡物的距离（红色圆圈），然后继续沿着该方向找到下一个点 <span class="math inline">\(P1\)</span>，继续找到 <span class="math inline">\(P1\)</span> 点到最近遮挡物的距离，以此类推，从而找出该方向上最小的距离。</p><div data-align="center"><p><img data-src="/images/shadow_map/sdf_sm_2.png" width="60%" height="60%"></p></div><p>然后将所有圆跟起点 <span class="math inline">\(P0\)</span> 做切线得出下面这个图：</p><div data-align="center"><p><img data-src="/images/shadow_map/sdf_sm_3.png" width="40%" height="40%"></p></div><div class="note success"><p>SDF 只能告诉我们当前点最近的遮挡物距离，但是不知道遮挡物的方向，因此这里对圆做切线，将切线处当成遮挡物位置(切线处角度最大)</p></div><p>因此 <span class="math inline">\(\theta\)</span> 求解公式如下：</p><p><span class="math display">\[ \theta = arcsin(\frac{SDF(p)}{|p-o|}) \]</span></p><p>但是在实际中，会用下面这个式子来做近似</p><p><span class="math display">\[ min \left \{ \frac{k \cdot SDF(p)}{|p-o|}, 1.0 \right \} \]</span></p><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// ro: o 点</span>
<span class="token comment">// rd: o 点到光源中心点方向向量</span>
<span class="token keyword">float</span> <span class="token function">softshadow</span><span class="token punctuation">(</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> ro<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> rd<span class="token punctuation">,</span> <span class="token keyword">float</span> mint<span class="token punctuation">,</span> <span class="token keyword">float</span> maxt<span class="token punctuation">,</span> <span class="token keyword">float</span> k <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> res <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">float</span> t <span class="token operator">=</span> mint<span class="token punctuation">;</span> t <span class="token operator">&lt;</span> maxt<span class="token punctuation">;</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">float</span> h <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>ro <span class="token operator">+</span> rd <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> h <span class="token operator">&lt;</span> <span class="token number">0.001</span> <span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

        res <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span> res<span class="token punctuation">,</span> k <span class="token operator">*</span> h <span class="token operator">/</span> t <span class="token punctuation">)</span><span class="token punctuation">;</span>
        t <span class="token operator">+=</span> h<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div data-align="center"><p><img data-src="/images/shadow_map/sdf_sm_4.png" width="100%" height="100%"></p></div><h4 id="优点">优点</h4><ul><li>计算速度快（假设 SDF 已经离线生成的情况下，比传统的 <strong>Shadow Mapping</strong> 技术快很多</li><li>阴影质量很高，完美解决 Shadow Ance（自遮挡），Peter Panning（阴影浮空）等问题</li></ul><h4 id="缺点-2">缺点</h4><ul><li>SDF 需要预计算，因此场景中的物体需要是静态的</li><li>SDF 需要大量的存储空间（一般采用三维数组来存储空间中各个网格的 SDF 值）</li></ul><h2 id="参考">参考</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/395803049">1.高质量实时渲染（一）——实时阴影（1）</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/398299023">2.高质量实时渲染（二）——实时阴影（2）</a></p><p><a target="_blank" rel="noopener" href="https://yangwc.com/2021/04/14/PCSS/">3.高质量实时渲染：实时软阴影</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/KillerAery/p/15201310.html">4.实时阴影技术（Real-time Shadows）</a></p><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1YK4y1T7yY/?p=3&amp;spm_id_from=333.1007.top_right_bar_window_history.content.click&amp;vd_source=c9d8f557f21fb7d8f8181ea0b0415da4">5.GAMES202-高质量实时渲染 —— Lecture3 Real-time Shadows</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39300235/article/details/107765941">6.联级阴影贴图CSM(Cascaded shadow map)原理与实现</a></p><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/dxtecharts/cascaded-shadow-maps">7.联阴影映射</a></p><div id="ref-anchor-1"></div><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_23030843/article/details/104353754">8.利用 Shader 生成伪随机数</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/384446688">9.图形学基础 - 阴影 - ShadowMap及其延伸</a></p><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv15724613/">10.Variance Soft Shadow Mapping (实时软阴影)</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/50128840">11.入门Distance Field Soft Shadows</a></p></div><footer class="post-footer"><div class="license"><div class="license-title">实时阴影技术</div><div class="license-link"><a href="https://www.xianlongok.site/post/3725508f/">https://www.xianlongok.site/post/3725508f/</a></div><div class="license-meta"><div class="license-meta-item"><div class="license-meta-title">本文作者</div><div class="license-meta-text">小贤</div></div><div class="license-meta-item"><div class="license-meta-title">发布于</div><div class="license-meta-text">2023-08-12</div></div><div class="license-meta-item"><div class="license-meta-title">更新于</div><div class="license-meta-text">2023-08-12</div></div><div class="license-meta-item"><div class="license-meta-title">许可协议</div><div class="license-meta-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank">CC BY-NC-SA 4.0</a></div></div></div><div class="license-statement">转载或引用本文时，请遵守上述许可协议，注明出处、不得用于商业用途！</div></div><div class="post-tags"><a href="/tags/Shadow-map/" rel="tag"><i class="fa fa-tag"></i> Shadow map</a> <a href="/tags/PCF/" rel="tag"><i class="fa fa-tag"></i> PCF</a> <a href="/tags/PCSS/" rel="tag"><i class="fa fa-tag"></i> PCSS</a> <a href="/tags/SDF/" rel="tag"><i class="fa fa-tag"></i> SDF</a></div><div class="post-nav"><div class="post-nav-item"><a href="/post/30ae96f7/" rel="prev" title="FSR 技术原理"><i class="fa fa-chevron-left"></i> FSR 技术原理</a></div><div class="post-nav-item"><a href="/post/4625ed6a/" rel="next" title="动态 SDF 字体渲染方法">动态 SDF 字体渲染方法 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fas fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">小贤</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">267k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">4:03</span></span></div><div class="powered"><a href="https://dlzhang.com" rel="noopener" target="_blank">小贤</a>使用 <a href="https://hexo.io" rel="noopener" target="_blank">Hexo</a> <a href="https://theme-next.js.org" rel="noopener" target="_blank">NexT</a> 设计搭建<div><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">湘ICP备2023031638号</a></div></div></div></footer><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"dkLUcqHORjRdwQiwRPJMs00N-gzGzoHsz","app_key":"EhWnaex3YyY7bQysJ2SFnukE","server_url":null,"security":false}</script><script src="/js/third-party/statistics/lean-analytics.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://www.xianlongok.work","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"libUrl":"https://unpkg.com/@waline/client@v2/dist/waline.js","login":"disable","meta":["nick","mail","link"],"requiredMeta":["nick","mail"],"pageSize":5,"avatar":"mm","dark":"auto","emoji":true,"locale":{"placeholder":"请正确填写邮箱方便查收回复，评论通过审核才会显示。","admin":"站长","nick":"名称*","mail":"邮箱*","link":"网址"},"el":"#waline","comment":true,"path":"/post/3725508f/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>document.addEventListener("page:loaded",()=>{NexT.utils.loadComments(CONFIG.waline.el).then(()=>NexT.utils.getScript(CONFIG.waline.libUrl,{condition:window.Waline})).then(()=>Waline.init(Object.assign({},CONFIG.waline,{el:document.querySelector(CONFIG.waline.el)})))})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body></html>