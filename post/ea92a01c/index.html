<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#e7ddc8" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#181c27" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="/./images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/./images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/./images/favicon-16x16-next.png"><link rel="mask-icon" href="/./images/safari-pinned-tab-next.svg" color="#e7ddc8"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic%7CLong+Cang:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.xianlongok.site","root":"/","images":"/blog/images/","scheme":"Gemini","darkmode":true,"version":"8.17.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":null,"post_body":null,"coll_header":null,"sidebar":"fadeInDown"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="UE5 Mass 框架介绍 UE5 中 Mass分为几个库，都是以插件的形式放在引擎源码中，默认是关闭的，目前还是试验性插件。    官方给出了示范工程：城市示例 1，大致模块组织如下：    其中 MassEntity 是这个 Mass框架的基础，这里先从 MassEntity 库开始。  MassEntity 在介绍 MassEntity 之前，先引入几个概念：   * Archetype：原"><meta property="og:type" content="article"><meta property="og:title" content="ue5 Mass 框架简介"><meta property="og:url" content="https://www.xianlongok.site/post/ea92a01c/index.html"><meta property="og:site_name" content="十三"><meta property="og:description" content="UE5 Mass 框架介绍 UE5 中 Mass分为几个库，都是以插件的形式放在引擎源码中，默认是关闭的，目前还是试验性插件。    官方给出了示范工程：城市示例 1，大致模块组织如下：    其中 MassEntity 是这个 Mass框架的基础，这里先从 MassEntity 库开始。  MassEntity 在介绍 MassEntity 之前，先引入几个概念：   * Archetype：原"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/mass_plugin.png"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/mass_plugin.svg"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/archetype_graph.png"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/archetype_entity.svg"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/struct_tracker_bit.png"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/archetype_bit_array.png"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/archetype_frag_bit.svg"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/fragment_config.png"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/frag_config.svg"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/cpu_z.png"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/chunk_data.svg"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/ue5_mass.svg"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/auto_register.png"><meta property="og:image" content="https://www.xianlongok.site/images/ue5_mass/mass_for_chunk1.svg"><meta property="article:published_time" content="2023-04-28T06:41:45.000Z"><meta property="article:modified_time" content="2023-04-28T07:37:28.705Z"><meta property="article:author" content="小贤"><meta property="article:tag" content="C++"><meta property="article:tag" content="UE5"><meta property="article:tag" content="Mass"><meta property="article:tag" content="ECS"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.xianlongok.site/images/ue5_mass/mass_plugin.png"><link rel="canonical" href="https://www.xianlongok.site/post/ea92a01c/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.xianlongok.site/post/ea92a01c/","path":"post/ea92a01c/","title":"ue5 Mass 框架简介"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>ue5 Mass 框架简介 | 十三</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-2Y4JGXG8FG"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-2Y4JGXG8FG","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><link rel="dns-prefetch" href="https://www.xianlongok.work"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">十三</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">安心学技术</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-splotch fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fas fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-tools"><a href="/tools/" rel="section"><i class="fas fa-wrench fa-fw"></i>工具</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fas fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fas fa-book fa-fw"></i>留言板</a></li><li class="menu-item menu-item-novelai"><a href="/NovelAI/" rel="section"><i class="fas fa-tachometer fa-fw"></i>NovelAI</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ue5-mass-%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">UE5 Mass 框架介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#massentity"><span class="nav-number">2.</span> <span class="nav-text">MassEntity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fragment"><span class="nav-number">2.1.</span> <span class="nav-text">Fragment</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shared-fragments"><span class="nav-number">2.1.1.</span> <span class="nav-text">Shared Fragments</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#chunkfragment"><span class="nav-number">2.1.2.</span> <span class="nav-text">ChunkFragment</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tag"><span class="nav-number">2.2.</span> <span class="nav-text">Tag</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#archetype"><span class="nav-number">2.3.</span> <span class="nav-text">Archetype</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-archetype"><span class="nav-number">2.3.1.</span> <span class="nav-text">创建 Archetype</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E5%9E%8B%E6%8F%8F%E8%BF%B0%E5%99%A8"><span class="nav-number">2.3.2.</span> <span class="nav-text">原型描述器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fragmentconfigs"><span class="nav-number">2.3.3.</span> <span class="nav-text">FragmentConfigs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fmassarchetypechunk"><span class="nav-number">2.3.4.</span> <span class="nav-text">FMassArchetypeChunk</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B"><span class="nav-number">2.4.</span> <span class="nav-text">创建实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.5.</span> <span class="nav-text">查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%9D%83%E9%99%90"><span class="nav-number">2.5.1.</span> <span class="nav-text">查询权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tags-%E6%93%8D%E4%BD%9C"><span class="nav-number">2.5.2.</span> <span class="nav-text">Tags 操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-entity"><span class="nav-number">2.5.3.</span> <span class="nav-text">修改 Entity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tag-%E4%BF%AE%E6%94%B9"><span class="nav-number">2.5.4.</span> <span class="nav-text">Tag 修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#foreachentitychunk-%E5%81%9A%E4%BA%86%E5%95%A5"><span class="nav-number">2.5.5.</span> <span class="nav-text">ForEachEntityChunk 做了啥</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">3.</span> <span class="nav-text">参考</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number"></span> <span class="nav-text">推荐文章（由hexo文章推荐插件驱动）</span></a></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="小贤" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">小贤</p><div class="site-description" itemprop="description">Watch and learn, your magic is mine!</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">25</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">22</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">38</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/qq317423892" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qq317423892" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a> </span><span class="links-of-author-item"><a href="mailto:xianlongok@163.com" title="E-Mail → mailto:xianlongok@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a></span></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://scorpioq.github.io/" title="https:&#x2F;&#x2F;scorpioq.github.io&#x2F;" rel="noopener" target="_blank">ScorpioQ</a></li><li class="links-of-blogroll-item"><a href="https://www.cnblogs.com/lastkiss/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;lastkiss&#x2F;" rel="noopener" target="_blank">邪妖怪のBlog</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.xianlongok.site/post/ea92a01c/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="小贤"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="十三"><meta itemprop="description" content="Watch and learn, your magic is mine!"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="ue5 Mass 框架简介 | 十三"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">ue5 Mass 框架简介</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-04-28 14:41:45" itemprop="dateCreated datePublished" datetime="2023-04-28T14:41:45+08:00">2023-04-28</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/UE5/" itemprop="url" rel="index"><span itemprop="name">UE5</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/UE5/Mass/" itemprop="url" rel="index"><span itemprop="name">Mass</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/UE5/Mass/ECS/" itemprop="url" rel="index"><span itemprop="name">ECS</span></a> </span></span><span id="/post/ea92a01c/" class="post-meta-item leancloud_visitors" data-flag-title="ue5 Mass 框架简介" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/post/ea92a01c/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/post/ea92a01c/" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>22k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>20 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="ue5-mass-框架介绍">UE5 Mass 框架介绍</h2><p><strong>UE5</strong> 中 <strong>Mass</strong> 分为几个库，都是以插件的形式放在引擎源码中，默认是关闭的，目前还是试验性插件。</p><div data-align="center"><p><img data-src="/images/ue5_mass/mass_plugin.png" width="80%" height="80%"></p></div><p>官方给出了示范工程：城市示例 <a href="#ref-anchor-1"><sup>1</sup></a>，大致模块组织如下：</p><div data-align="center"><p><img data-src="/images/ue5_mass/mass_plugin.svg" width="80%" height="80%"></p></div><p>其中 <strong>MassEntity</strong> 是这个 <strong>Mass</strong> 框架的基础，这里先从 <strong>MassEntity</strong> 库开始。</p><h2 id="massentity">MassEntity</h2><p>在介绍 MassEntity 之前，先引入几个概念：</p><ul><li><strong>Archetype</strong>：原型，可以类比面向对象编程里的类定义，包含 <strong>Fragment</strong>，<strong>Tag</strong> 等</li><li><strong>Entity</strong>：使用原型创建的实例对象，可以类比类实例化后的对象</li><li><strong>Fragment</strong>：每个原型的数据片段的定义</li><li><strong>Tag</strong>：原型的标签，不包含数据</li><li><strong>Handle</strong>：句柄，<strong>MassEntity</strong> 中有两种句柄：<strong>ArchetypeHandle</strong> 跟 <strong>EntityHandle</strong></li><li><strong>Trait</strong>：特性，由若干个 <strong>Fragment</strong> 组成</li><li><strong>Processor</strong>：处理器，用来对 Entity 数据进行处理的类</li></ul><p><strong>MassEntity</strong> 插件中的 <strong>MassEntityTestSuite</strong> 模块中给出了一个种田游戏的案例，一般按照面向对象，我们会定义如下类型：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Plant</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/// 当前水量</span>
    <span class="token keyword">float</span> CurrentWater <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
    <span class="token comment">// 每秒耗水量</span>
    <span class="token keyword">float</span> DeltaWaterPerSecond <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.01f</span><span class="token punctuation">;</span>

    <span class="token comment">// 成熟时间</span>
    uint32 NumSecodsLeft <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">Flower</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Plant</span></span> <span class="token punctuation">&#123;</span>
    uint32 NumBonusTicks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    uint16 FlowerType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">Corp</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Plant</span></span> <span class="token punctuation">&#123;</span>
    unit16 CorpType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="fragment">Fragment</h3><p><strong>Fragmenet</strong> 是 <strong>Entity</strong> 的数据部分，继承基类 <strong>FMassFragment</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">FMassFragment</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">FMassFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>测试示例中的 <strong>Fragment</strong> 定义：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 基类拆分后的 Fragment</span>
<span class="token function">USTRUCT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">struct</span> <span class="token class-name">FFarmWaterFragment</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FMassFragment</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">float</span> CurrentWater <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> DeltaWaterPerSecond <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.01f</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function">USTRUCT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">struct</span> <span class="token class-name">FHarvestTimerFragment</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FMassFragment</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    uint32 NumSecondsLeft <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// Flower 的 Fragment</span>
<span class="token function">USTRUCT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">struct</span> <span class="token class-name">FFarmFlowerFragment</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FMassFragment</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    uint32 NumBonusTicks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    uint16 FlowerType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// Corp 的 Fragment</span>
<span class="token function">USTRUCT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">struct</span> <span class="token class-name">FFarmCropFragment</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FMassFragment</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    uint16 CropType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="shared-fragments">Shared Fragments</h4><p>同一个 <strong>Archetype</strong> 下的多个 <strong>Entity</strong> 公用的数据可以使用 <strong>SharedFragment</strong>，例如 <strong>LOD</strong>，可以理解为是类的静态（<strong>static</strong>）成员变量</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">USTRUCT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">struct</span> <span class="token class-name">FMassSharedFragment</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">FMassSharedFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">MASSMOVEMENT_API</span> FMassMovementParameters <span class="token operator">:</span> <span class="token keyword">public</span> FMassSharedFragment
<span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> MaxSpeed <span class="token operator">=</span> <span class="token number">200.f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> DefaultDesiredSpeed <span class="token operator">=</span> <span class="token number">140.f</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="chunkfragment">ChunkFragment</h4><p><strong>ChunkFragment</strong> 也是表示多个 <strong>Entity</strong> 公用的数据，但是是在同一个 <strong>Chunk</strong> 上的 <strong>Entity</strong> 共享的数据。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">USTRUCT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">struct</span> <span class="token class-name">FMassChunkFragment</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">FMassChunkFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">MASSLOD_API</span> FMassVisualizationChunkFragment <span class="token operator">:</span> <span class="token keyword">public</span> FMassChunkFragment
<span class="token punctuation">&#123;</span>
    EMassVisibility Visibility <span class="token operator">=</span> EMassVisibility<span class="token double-colon punctuation">::</span>Max<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="note info"><p>UE5.1.1 版本中，同一个 <strong>Archetype</strong> 的数据以 128K 大小的内存空间做为一个 <strong>chunk</strong> 来存储当前 <strong>Archetype</strong> 类型的 <strong>Entity</strong>。</p></div><h3 id="tag">Tag</h3><p><strong>Tag</strong> 不包含数据成员，主要使用来做查询过滤。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">USTRUCT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">struct</span> <span class="token class-name">FMassTag</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">FMassTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">FFarmJustBecameReadyToHarvestTag</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FMassTag</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function">USTRUCT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">struct</span> <span class="token class-name">FFarmReadyToHarvestTag</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">FMassTag</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="note danger"><p>Tag 不能有成员变量！！！！</p></div><h3 id="archetype">Archetype</h3><p><strong>Archetype</strong>（原型）就是定义 <strong>Entity</strong> 组成成分的类结构，包括上面的：<strong>Fragment</strong>、<strong>Tag</strong>、<strong>Trait</strong>，他们的关系如下图：</p><div data-align="center"><p><img data-src="/images/ue5_mass/archetype_graph.png" width="80%" height="80%"></p></div><h4 id="创建-archetype">创建 Archetype</h4><p>首先我们需要先创建 <strong>Archetype</strong>，通过使用 <strong>FMassEntityManager</strong> 提供的接口，我们可以根据我们现有的 <strong>Fragment</strong>、<strong>Tag</strong> 创建出我们需要的 <strong>Archetype</strong>。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/// 示例中自己创建了一个 FMassEntityManager</span>
<span class="token class-name">AMassEntityTestFarmPlot</span><span class="token double-colon punctuation">::</span><span class="token function">AMassEntityTestFarmPlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">SharedEntityManager</span><span class="token punctuation">(</span><span class="token function">MakeShareable</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">FMassEntityManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">AMassEntityTestFarmPlot</span><span class="token double-colon punctuation">::</span><span class="token function">BeginPlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/// 5.1.1 创建 Archetype 跟 Entity 都是用 EntityManager</span>
    FMassEntityManager<span class="token operator">&amp;</span> EntityManager <span class="token operator">=</span> SharedEntityManager<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 自己创建的 EntityManager 要先初始化</span>
    EntityManager<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过 Tag、Fragment、ChunkFragment、SharedFragment 列表创建一个原型 </span>

    <span class="token comment">// Crop 原型</span>
    FMassArchetypeHandle CropArchetype <span class="token operator">=</span> EntityManager<span class="token punctuation">.</span><span class="token function">CreateArchetype</span><span class="token punctuation">(</span>
        TArray<span class="token operator">&lt;</span><span class="token keyword">const</span> UScriptStruct<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">&#123;</span> 
            <span class="token class-name">FFarmWaterFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token class-name">FFarmCropFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token class-name">FHarvestTimerFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Flower 原型</span>
    FMassArchetypeHandle FlowerArchetype <span class="token operator">=</span> EntityManager<span class="token punctuation">.</span><span class="token function">CreateArchetype</span><span class="token punctuation">(</span>
        TArray<span class="token operator">&lt;</span><span class="token keyword">const</span> UScriptStruct<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">&#123;</span> 
            <span class="token class-name">FFarmWaterFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token class-name">FFarmFlowerFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token class-name">FHarvestTimerFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建原型后会返回原型的句柄，同样创建 <strong>Entity</strong> 也是返回句柄，在使用中，句柄跟 <strong>Archetype</strong> 跟 <strong>Entity</strong> 的对应关系如下，</p><div data-align="center"><p><img data-src="/images/ue5_mass/archetype_entity.svg" width="80%" height="80%"></p></div><p>原型类详细定义：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">FMassArchetypeData</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 原型描述类</span>
    FMassArchetypeCompositionDescriptor CompositionDescriptor<span class="token punctuation">;</span>
    <span class="token comment">// 记录原型每个 Fragment 在单个 chunk 上的地址偏移量</span>
    TArray<span class="token operator">&lt;</span>FMassArchetypeFragmentConfig<span class="token punctuation">,</span> TInlineAllocator<span class="token operator">&lt;</span><span class="token number">16</span><span class="token operator">>></span> FragmentConfigs<span class="token punctuation">;</span>
    <span class="token comment">// Fragment 序号 map</span>
    TMap<span class="token operator">&lt;</span><span class="token keyword">const</span> UScriptStruct<span class="token operator">*</span><span class="token punctuation">,</span> int32<span class="token operator">></span> FragmentIndexMap<span class="token punctuation">;</span>
    <span class="token comment">// chunks</span>
    TArray<span class="token operator">&lt;</span>FMassArchetypeChunk<span class="token operator">></span> Chunks<span class="token punctuation">;</span>
    <span class="token comment">// &#123; key: Entity.Index,  value: Entity 在当前 Chunk 上的位置 &#125;</span>
    TMap<span class="token operator">&lt;</span>int32<span class="token punctuation">,</span> int32<span class="token operator">></span> EntityMap<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="原型描述器">原型描述器</h4><p>首先注意到 <strong>FMassArchetypeCompositionDescriptor</strong>，它用来存储 <strong>MassArchetype</strong> 上 <strong>Fragment</strong>、<strong>Tags</strong>、<strong>ChunkFragment</strong>、<strong>SharedFragment</strong> 的信息，并且根据这些信息生成一个 <strong>Hash</strong> 值，这个 <strong>Hash</strong> 值可以用来标识 <strong>MassArchetype</strong> 唯一性。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">FMassArchetypeCompositionDescriptor</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/// 一个可以记录 Fragment 列表，并转成 bit 位的数据结构</span>
    FMassFragmentBitSet Fragments<span class="token punctuation">;</span>
    FMassTagBitSet Tags<span class="token punctuation">;</span>
    FMassChunkFragmentBitSet ChunkFragments<span class="token punctuation">;</span>
    FMassSharedFragmentBitSet SharedFragments<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// FMassFragmentBitSet</span>
<span class="token function">DECLARE_STRUCTTYPEBITSET_EXPORTED</span><span class="token punctuation">(</span>MASSENTITY_API<span class="token punctuation">,</span> FMassFragmentBitSet<span class="token punctuation">,</span> FMassFragment<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 宏展开后 </span>
<span class="token keyword">struct</span> <span class="token class-name">FMassFragmentBitSetStructTracker</span> 
<span class="token punctuation">&#123;</span> 
    MASSENTITY_API <span class="token keyword">static</span> FStructTracker StructTracker<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
<span class="token keyword">template</span> <span class="token keyword">struct</span> <span class="token class-name">MASSENTITY_API</span> TStructTypeBitSet<span class="token operator">&lt;</span>FMassFragment<span class="token punctuation">,</span>
    FMassFragmentBitSetStructTracker<span class="token punctuation">,</span> UScriptStruct<span class="token operator">></span><span class="token punctuation">;</span> 

<span class="token keyword">using</span> FMassFragmentBitSet <span class="token operator">=</span> TStructTypeBitSet<span class="token operator">&lt;</span>FMassFragment<span class="token punctuation">,</span> 
    FMassFragmentBitSetStructTracker<span class="token punctuation">,</span> UScriptStruct<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>TSructTypeBitSet</strong> 提供了接口，增加类型，并且生成对应的 <strong>bit</strong> 位，</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">TBaseStruct</span><span class="token punctuation">,</span> 
    <span class="token keyword">typename</span> <span class="token class-name">TStructTrackerWrapper</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">TUStructType</span> <span class="token operator">=</span> UScriptStruct<span class="token operator">></span>
<span class="token keyword">struct</span> <span class="token class-name">TStructTypeBitSet</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> TUStructType<span class="token operator">&amp;</span> InStructType<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 这里会访问 TStructTrackerWrapper::StructTracker</span>
        <span class="token comment">// 即 FMassFragmentBitSetStructTracker::StructTracker</span>
        <span class="token keyword">const</span> int32 StructTypeIndex <span class="token operator">=</span> 
            TStructTrackerWrapper<span class="token double-colon punctuation">::</span>StructTracker<span class="token punctuation">.</span><span class="token function">FindOrAddStructTypeIndex</span><span class="token punctuation">(</span>InStructType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取到 Fragment 的 Index 后 生成对应 bit 位</span>
        StructTypesBitArray<span class="token punctuation">.</span><span class="token function">AddAtIndex</span><span class="token punctuation">(</span>StructTypeIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因此所有增加了的 <strong>Fragment</strong> 类型会存放到 <strong>FMassFragmentBitSetStructTracker::StructTracker</strong> 这个静态变量上。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">FStructTracker</span>
<span class="token punctuation">&#123;</span>
    int32 <span class="token function">FindOrAddStructTypeIndex</span><span class="token punctuation">(</span><span class="token keyword">const</span> UStruct<span class="token operator">&amp;</span> InStructType<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> uint32 Hash <span class="token operator">=</span> <span class="token function">PointerHash</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>InStructType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        FSetElementId ElementId <span class="token operator">=</span> StructTypeToIndexSet<span class="token punctuation">.</span><span class="token function">FindIdByHash</span><span class="token punctuation">(</span>Hash<span class="token punctuation">,</span> Hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ElementId<span class="token punctuation">.</span><span class="token function">IsValidId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// .. or create new one</span>
            ElementId <span class="token operator">=</span> StructTypeToIndexSet<span class="token punctuation">.</span><span class="token function">AddByHash</span><span class="token punctuation">(</span>Hash<span class="token punctuation">,</span> Hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            StructTypesList<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>InStructType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">const</span> int32 Index <span class="token operator">=</span> ElementId<span class="token punctuation">.</span><span class="token function">AsInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Index<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    TSet<span class="token operator">&lt;</span>uint32<span class="token operator">></span> StructTypeToIndexSet<span class="token punctuation">;</span>
    TArray<span class="token operator">&lt;</span>TWeakObjectPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> UStruct<span class="token operator">></span><span class="token punctuation">,</span> TInlineAllocator<span class="token operator">&lt;</span><span class="token number">64</span><span class="token operator">>></span> StructTypesList<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面是内存结果：</p><div data-align="center"><p><img data-src="/images/ue5_mass/struct_tracker_bit.png" width="80%" height="80%"></p></div><p>生成的 <strong>Archetype</strong> 的 <strong>Fragment bit</strong> 位数据如下：</p><div data-align="center"><p><img data-src="/images/ue5_mass/archetype_bit_array.png" width="40%" height="40%"></p></div><p>下面是 <strong>CropArchetype</strong> 生成的 <strong>Fragment</strong> 的比特位</p><div data-align="center"><p><img data-src="/images/ue5_mass/archetype_frag_bit.svg" width="80%" height="80%"></p></div><div class="note info"><p>Fragment 排序规则：内存空间大小（字节大的排前面） &gt; Fragmnet 名字</p></div><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">FScriptStructSortOperator</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
    <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> A<span class="token punctuation">,</span> <span class="token keyword">const</span> T<span class="token operator">&amp;</span> B<span class="token punctuation">)</span> <span class="token keyword">const</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>A<span class="token punctuation">.</span><span class="token function">GetStructureSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> B<span class="token punctuation">.</span><span class="token function">GetStructureSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token punctuation">(</span>A<span class="token punctuation">.</span><span class="token function">GetStructureSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> B<span class="token punctuation">.</span><span class="token function">GetStructureSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
                 <span class="token operator">&amp;&amp;</span> B<span class="token punctuation">.</span><span class="token function">GetFName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FastLess</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span><span class="token function">GetFName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后 <strong>Fragment</strong>、<strong>Tag</strong>、<strong>SharedFragment</strong>、<strong>ChunkFragment</strong> 会合并生成该 <strong>Archetype</strong> 的 <strong>Hash</strong> 值。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">FMassArchetypeCompositionDescriptor</span>
<span class="token punctuation">&#123;</span>
    uint32 <span class="token function">CalculateHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> 
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">CalculateHash</span><span class="token punctuation">(</span>Fragments<span class="token punctuation">,</span> Tags<span class="token punctuation">,</span> ChunkFragments<span class="token punctuation">,</span> SharedFragments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> uint32 <span class="token function">CalculateHash</span><span class="token punctuation">(</span><span class="token keyword">const</span> FMassFragmentBitSet<span class="token operator">&amp;</span> InFragments<span class="token punctuation">,</span> 
        <span class="token keyword">const</span> FMassTagBitSet<span class="token operator">&amp;</span> InTags<span class="token punctuation">,</span> 
        <span class="token keyword">const</span> FMassChunkFragmentBitSet<span class="token operator">&amp;</span> InChunkFragments<span class="token punctuation">,</span> 
        <span class="token keyword">const</span> FMassSharedFragmentBitSet<span class="token operator">&amp;</span> InSharedFragmentBitSet<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> uint32 FragmentsHash <span class="token operator">=</span> <span class="token function">GetTypeHash</span><span class="token punctuation">(</span>InFragments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> uint32 TagsHash <span class="token operator">=</span> <span class="token function">GetTypeHash</span><span class="token punctuation">(</span>InTags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> uint32 ChunkFragmentsHash <span class="token operator">=</span> <span class="token function">GetTypeHash</span><span class="token punctuation">(</span>InChunkFragments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> uint32 SharedFragmentsHash <span class="token operator">=</span> <span class="token function">GetTypeHash</span><span class="token punctuation">(</span>InSharedFragmentBitSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">HashCombine</span><span class="token punctuation">(</span><span class="token function">HashCombine</span><span class="token punctuation">(</span><span class="token function">HashCombine</span><span class="token punctuation">(</span>FragmentsHash<span class="token punctuation">,</span> TagsHash<span class="token punctuation">)</span>
            <span class="token punctuation">,</span> ChunkFragmentsHash<span class="token punctuation">)</span><span class="token punctuation">,</span> SharedFragmentsHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后注意，<strong>FMassEntityManager::Initialize</strong> 时就会找到所有类型，并初始化 <strong>FStructTracker</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">FMassEntityManager</span><span class="token double-colon punctuation">::</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 初始化时会创建一个 Index 0 的 Entity 作为无效 Entity</span>
    Entities<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    FMassFragmentBitSet Fragments<span class="token punctuation">;</span>
    FMassTagBitSet Tags<span class="token punctuation">;</span>
    FMassChunkFragmentBitSet ChunkFragments<span class="token punctuation">;</span>
    FMassSharedFragmentBitSet LocalSharedFragments<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>TObjectIterator<span class="token operator">&lt;</span>UScriptStruct<span class="token operator">></span> StructIt<span class="token punctuation">;</span> StructIt<span class="token punctuation">;</span> <span class="token operator">++</span>StructIt<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StructIt<span class="token operator">-></span><span class="token function">IsChildOf</span><span class="token punctuation">(</span><span class="token class-name">FMassFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>StructIt <span class="token operator">!=</span> <span class="token class-name">FMassFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">// TStructTypeBitSet.Add 函数，上面已经提到过了</span>
                Fragments<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>StructIt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>StructIt<span class="token operator">-></span><span class="token function">IsChildOf</span><span class="token punctuation">(</span><span class="token class-name">FMassTag</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>StructIt <span class="token operator">!=</span> <span class="token class-name">FMassTag</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                Tags<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>StructIt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>StructIt<span class="token operator">-></span><span class="token function">IsChildOf</span><span class="token punctuation">(</span><span class="token class-name">FMassChunkFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>StructIt <span class="token operator">!=</span> <span class="token class-name">FMassChunkFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                ChunkFragments<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>StructIt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>StructIt<span class="token operator">-></span><span class="token function">IsChildOf</span><span class="token punctuation">(</span><span class="token class-name">FMassSharedFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>StructIt <span class="token operator">!=</span> <span class="token class-name">FMassSharedFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                LocalSharedFragments<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>StructIt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    bInitialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="fragmentconfigs">FragmentConfigs</h4><p>回到 <strong>FMassArchetypeData</strong> 中的 <strong>FragmentConfigs</strong>，这个主要是存储原型存储时，每个 <strong>chunk</strong> 上每个 <strong>Fragment</strong> 的内存偏移地址。</p><div data-align="center"><p><img data-src="/images/ue5_mass/fragment_config.png" width="50%" height="50%"></p></div><p>内存布局以及计算方式如下：</p><div data-align="center"><p><img data-src="/images/ue5_mass/frag_config.svg" width="60%" height="60%"></p></div><div class="note warning"><p>计算时减去 AlignmentPadding 这里没想明白，还要研究下。</p></div><h4 id="fmassarchetypechunk">FMassArchetypeChunk</h4><p>终于来到 <strong>FMassArchetypeChunk</strong>，这个类型是用来存放 <strong>Entity</strong>。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">namespace</span> UE<span class="token double-colon punctuation">::</span>Mass
<span class="token punctuation">&#123;</span>
    <span class="token keyword">constexpr</span> int32 ChunkSize <span class="token operator">=</span> <span class="token number">128</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token class-name">FMassArchetypeChunk</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">/// 指向内存块的指针</span>
    uint8<span class="token operator">*</span> RawMemory <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token comment">/// Chunk 大小</span>
    int32 AllocSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    int32 NumInstances <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    int32 SerialModificationNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/// 保存 ChunkFragment 数据</span>
    TArray<span class="token operator">&lt;</span>FInstancedStruct<span class="token operator">></span> ChunkFragmentData<span class="token punctuation">;</span>
    <span class="token comment">/// 保存 SharedFragment 数据</span>
    FMassArchetypeSharedFragmentValues SharedFragmentValues<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Mass</strong> 在上一个版本的时候，<strong>Chunk</strong> 的大小还是 <strong>64KB</strong>，UE5.1.1 代码已经改成 <strong>128KB</strong> 了，主要是现在 CPU L2 缓存都是 128 的倍数了。</p><div data-align="center"><p><img data-src="/images/ue5_mass/cpu_z.png" width="50%" height="50%"></p></div><div class="note success"><ol type="1"><li>一级缓存：有数据 Cache 跟 指令 Cache 之分，每个 CPU 各自有一个 32KB 的 Cache</li><li>二级缓存：每个核心内各自有一个 512KB 的 Cache</li><li>三级缓存：上图的三级缓存没有写数量，表示 8 个核心共享一块三级缓存，大小是 16MB（共享的三级缓存，速度会慢很多）。</li></ol></div><p><strong>Chunk</strong> 内存示意图如下：</p><div data-align="center"><p><img data-src="/images/ue5_mass/chunk_data.svg" width="55%" height="55%"></p></div><h3 id="创建实例">创建实例</h3><p>有了原型后，我们就可以通过原型来创建我们需要的实例对象了：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/// 通过 ArchetypeHandle 创建单个 Entity</span>
FMassArchetypeHandle Archetype <span class="token operator">=</span> CropArchetype<span class="token punctuation">;</span>
FMassEntityHandle NewItem <span class="token operator">=</span> EntityManager<span class="token punctuation">.</span><span class="token function">CreateEntity</span><span class="token punctuation">(</span>Archetype<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// 通过 ArchetypeHandle 批量创建 100 个 Entity</span>
TArray<span class="token operator">&lt;</span>FMassEntityHandle<span class="token operator">></span> Entities<span class="token punctuation">;</span>
EntityManager<span class="token operator">-></span><span class="token function">BatchCreateEntities</span><span class="token punctuation">(</span>Archetype<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> Entities<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="note success"><ol type="1"><li><strong>Entity.Index</strong> : <strong>Entity</strong> 在 <strong>MassEntityManager.Entities</strong> 数组中的位置，Entity 移除时，<strong>Index</strong> 会放入 <strong>EntityFreeIndexList</strong> 里，下次创建时优先从 <strong>EntityFreeIndexList</strong> 拿出下一个可分配的 <strong>Index</strong></li><li><strong>Entity.SerialNumber</strong> : <strong>MassEntityManager</strong> 维护的唯一自增 <strong>Id</strong></li></ol></div><p>下图是这几个类的关系：</p><div data-align="center"><p><img data-src="/images/ue5_mass/ue5_mass.svg" width="100%" height="100%"></p></div><h3 id="查询">查询</h3><p>有了实例后，我们后续想更新，修改实例需要通过查询获取到这些 <strong>Entity</strong>，<strong>UE</strong> 提供了 <strong>UMassProcessor</strong>，我们需要查询时，只需要写一个子类继承该类，然后自己实现如下两个函数：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token keyword">class</span> <span class="token class-name">UMyProcessor</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">UFarmProcessorBase</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    FMassEntityQuery MyQuery<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token class-name">UMyProcessor</span><span class="token double-colon punctuation">::</span><span class="token function">UMyProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 设置为 true 后会添加到工程里的 Mass 配置中.</span>
        bAutoRegisterWithProcessingPhases <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 上面设置为 true 后，这里设置更新阶段</span>
        ProcessingPhase <span class="token operator">=</span> EMassProcessingPhase<span class="token double-colon punctuation">::</span>PrePhysics<span class="token punctuation">;</span>

        <span class="token comment">// Using the built-in movement processor group</span>
        ExecutionOrder<span class="token punctuation">.</span>ExecuteInGroup <span class="token operator">=</span> UE<span class="token double-colon punctuation">::</span>Mass<span class="token double-colon punctuation">::</span>ProcessorGroupNames<span class="token double-colon punctuation">::</span>Movement<span class="token punctuation">;</span>
        <span class="token comment">// You can also define other processors that require to run </span>
        <span class="token comment">// before or after this one</span>
        ExecutionOrder<span class="token punctuation">.</span>ExecuteAfter<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"MSMovementProcessor"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// This executes only on Clients and Standalone</span>
        ExecutionFlags <span class="token operator">=</span> <span class="token punctuation">(</span>int32<span class="token punctuation">)</span><span class="token punctuation">(</span>EProcessorExecutionFlags<span class="token double-colon punctuation">::</span>Client <span class="token operator">|</span>
            EProcessorExecutionFlags<span class="token double-colon punctuation">::</span>Standalone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// This processor should not be multithreaded</span>
        bRequiresGameThreadExecution <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div data-align="center"><p><img data-src="/images/ue5_mass/auto_register.png" width="80%" height="80%"></p></div><p>各个更新阶段的配置：</p><table><colgroup><col style="width:33%"><col style="width:33%"><col style="width:33%"></colgroup><thead><tr class="header"><th><code>EMassProcessingPhase</code></th><th>Related <code>ETickingGroup</code></th><th>Description</th></tr></thead><tbody><tr class="odd"><td><code>PrePhysics</code></td><td><code>TG_PrePhysics</code></td><td>Executes before physics simulation starts.</td></tr><tr class="even"><td><code>StartPhysics</code></td><td><code>TG_StartPhysics</code></td><td>Special tick group that starts physics simulation.</td></tr><tr class="odd"><td><code>DuringPhysics</code></td><td><code>TG_DuringPhysics</code></td><td>Executes in parallel with the physics simulation work.</td></tr><tr class="even"><td><code>EndPhysics</code></td><td><code>TG_EndPhysics</code></td><td>Special tick group that ends physics simulation.</td></tr><tr class="odd"><td><code>PostPhysics</code></td><td><code>TG_PostPhysics</code></td><td>Executes after rigid body and cloth simulation.</td></tr><tr class="even"><td><code>FrameEnd</code></td><td><code>TG_LastDemotable</code></td><td>Catchall for anything demoted to the end.</td></tr></tbody></table><p>自定义的 <strong>Processor</strong> 还需要自己实现两个函数，首先是配置查询条件：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">UMyProcessor</span><span class="token double-colon punctuation">::</span><span class="token function">ConfigureQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 增加 Fragment 条件</span>
    MyQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>FHitLocationFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span>EMassFragmentAccess<span class="token double-colon punctuation">::</span>ReadOnly<span class="token punctuation">,</span>
        EMassFragmentPresence<span class="token double-colon punctuation">::</span>Optional<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 增加 Tag 条件</span>
    MyQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddTagRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>FMoverTag<span class="token operator">></span></span></span><span class="token punctuation">(</span>EMassFragmentPresence<span class="token double-colon punctuation">::</span>All<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 增加 subsystem 条件</span>
    MyQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddSubsystemRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>UMassDebuggerSubsystem<span class="token operator">></span></span></span>
        <span class="token punctuation">(</span>EMassFragmentAccess<span class="token double-colon punctuation">::</span>ReadWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 MyQuery 注册到 Processor 的 Query 列表中，用处不明。</span>
    MyQuery<span class="token punctuation">.</span><span class="token function">RegisterWithProcessor</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后是 <strong>Processor</strong> 具体的操作：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">UMyProcessor</span><span class="token double-colon punctuation">::</span><span class="token function">Execute</span><span class="token punctuation">(</span>FMassEntityManager<span class="token operator">&amp;</span> EntityManager<span class="token punctuation">,</span> 
    FMassExecutionContext<span class="token operator">&amp;</span> Context<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    MyQuery<span class="token punctuation">.</span><span class="token function">ForEachEntityChunk</span><span class="token punctuation">(</span>EntityManager<span class="token punctuation">,</span> Context<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>FMassExecutionContext<span class="token operator">&amp;</span> Context<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//Loop over every entity in the current chunk and do stuff!</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>int32 EntityIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> EntityIndex <span class="token operator">&lt;</span> Context<span class="token punctuation">.</span><span class="token function">GetNumEntities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>EntityIndex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="查询权限">查询权限</h4><p>查询器获取 Fragment、Subsystems 权限：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 获取 Fragment 的读写权限</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">EMassFragmentAccess</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">uint8</span></span>
<span class="token punctuation">&#123;</span>
    None<span class="token punctuation">,</span> 
    ReadOnly<span class="token punctuation">,</span> <span class="token comment">// 只读</span>
    ReadWrite<span class="token punctuation">,</span><span class="token comment">// 读写</span>
    MAX
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查询器查询条件：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 获取查询的筛选规则</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">EMassFragmentPresence</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">uint8</span></span>
<span class="token punctuation">&#123;</span>
    All<span class="token punctuation">,</span>      <span class="token comment">/** All of the required fragments must be present */</span>
    Any<span class="token punctuation">,</span>      <span class="token comment">/** One of the required fragments must be present */</span>
    None<span class="token punctuation">,</span>     <span class="token comment">/** None of the required fragments can be present */</span>
    Optional<span class="token punctuation">,</span> <span class="token comment">/** If fragment is present we'll use it, but it 
                  missing stop processing of a given archetype */</span>
    MAX
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="note warning"><ol type="1"><li>All: 全部满足</li><li>Any：包含其中之一</li><li>None：不能包含</li><li>Optional：可有可无？</li></ol></div><p>其他示例（<strong>SharedFragment</strong>、<strong>Subsystem</strong>）：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">UMyProcessor</span><span class="token double-colon punctuation">::</span><span class="token function">ConfigureQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 读写有 FTransformFragment 的实例</span>
    MyQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>FTransformFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span>EMassFragmentAccess<span class="token double-colon punctuation">::</span>ReadWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token comment">// 只读访问有 FMassForceFragment 的实例</span>
    MyQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>FMassForceFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span>EMassFragmentAccess<span class="token double-colon punctuation">::</span>ReadOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读写 SharedFragment </span>
    MyQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddSharedRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>FClockSharedFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span>EMassFragmentAccess<span class="token double-colon punctuation">::</span>ReadWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读写 UMassDebuggerSubsystem</span>
    MyQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddSubsystemRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>UMassDebuggerSubsystem<span class="token operator">></span></span></span><span class="token punctuation">(</span>
        EMassFragmentAccess<span class="token double-colon punctuation">::</span>ReadWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Registering the query with UMyProcessor</span>
    MyQuery<span class="token punctuation">.</span><span class="token function">RegisterWithProcessor</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对应的获取函数如下表：</p><table><thead><tr><th>Type</th><th><code>EMassFragmentAccess</code></th><th>Function</th><th>Description</th></tr></thead><tbody><tr><td rowspan="2">Fragment</td><td><code>ReadOnly</code></td><td><code>GetFragmentView</code></td><td>返回包含 fragment 的只读数组 <code>TConstArrayView</code></td></tr><tr><td><code>ReadWrite</code></td><td><code>GetMutableFragmentView</code></td><td>返回包含 fragment 的可读写数组 <code>TArrayView</code></td></tr><tr><td rowspan="2">Shared Fragment</td><td><code>ReadOnly</code></td><td><code>GetConstSharedFragment</code></td><td>返回常引用 shared fragment.</td></tr><tr><td><code>ReadWrite</code></td><td><code>GetMutableSharedFragment</code></td><td>返回引用 shared fragment.</td></tr><tr><td rowspan="2">Subsystem</td><td><code>ReadOnly</code></td><td><code>GetSubsystemChecked</code></td><td>返回常引用 subsystem.</td></tr><tr><td><code>ReadWrite</code></td><td><code>GetMutableSubsystemChecked</code></td><td>返回引用 subsystem.</td></tr></tbody></table><div class="note danger"><p>查看源码可以得知，<strong>ReadOnly</strong> 跟 <strong>ReadWrite</strong> 其实没有做强限制，定义 <strong>ReadOnly</strong> 的限制，使用时调用 <strong>GetMutableFragmentView</strong>，也可以返回可修改的 <strong>View</strong> 因此使用时，需要开发者自己规范化，下面是源码部分。</p></div><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* Fragments related operations */</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">TFragment</span><span class="token operator">></span>
TArrayView<span class="token operator">&lt;</span>TFragment<span class="token operator">></span> <span class="token function">GetMutableFragmentView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> UScriptStruct<span class="token operator">*</span> FragmentType <span class="token operator">=</span> <span class="token class-name">TFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> FFragmentView<span class="token operator">*</span> View <span class="token operator">=</span> FragmentViews<span class="token punctuation">.</span><span class="token function">FindByPredicate</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>FragmentType<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> FFragmentView<span class="token operator">&amp;</span> Element<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
            <span class="token keyword">return</span> Element<span class="token punctuation">.</span>Requirement<span class="token punctuation">.</span>StructType <span class="token operator">==</span> FragmentType<span class="token punctuation">;</span> 
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 官方把 check 代码注释掉的！！！！</span>

    <span class="token comment">//checkfSlow(View != nullptr, TEXT("Requested fragment type not bound"));</span>
    <span class="token comment">//checkfSlow(View->Requirement.AccessMode == EMassFragmentAccess::ReadWrite, </span>
    <span class="token comment">//    TEXT("Requested fragment has not been bound for writing"));</span>

    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">MakeArrayView</span><span class="token generic class-name"><span class="token operator">&lt;</span>TFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>TFragment<span class="token operator">*</span><span class="token punctuation">)</span>View<span class="token operator">-></span>FragmentView<span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        View<span class="token operator">-></span>FragmentView<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">TFragment</span><span class="token operator">></span>
TConstArrayView<span class="token operator">&lt;</span>TFragment<span class="token operator">></span> <span class="token function">GetFragmentView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> UScriptStruct<span class="token operator">*</span> FragmentType <span class="token operator">=</span> <span class="token class-name">TFragment</span><span class="token double-colon punctuation">::</span><span class="token function">StaticStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> FFragmentView<span class="token operator">*</span> View <span class="token operator">=</span> FragmentViews<span class="token punctuation">.</span><span class="token function">FindByPredicate</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>FragmentType<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> FFragmentView<span class="token operator">&amp;</span> Element<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
            <span class="token keyword">return</span> Element<span class="token punctuation">.</span>Requirement<span class="token punctuation">.</span>StructType <span class="token operator">==</span> FragmentType<span class="token punctuation">;</span> 
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//checkfSlow(View != nullptr, TEXT("Requested fragment type not bound"));</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">TConstArrayView</span><span class="token generic class-name"><span class="token operator">&lt;</span>TFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> TFragment<span class="token operator">*</span><span class="token punctuation">)</span>View<span class="token operator">-></span>FragmentView<span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        View<span class="token operator">-></span>FragmentView<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面的代码是示例中的一个更新 <strong>Water</strong> 的处理代码：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">UFarmWaterProcessor</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">UFarmProcessorBase</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token function">GENERATED_BODY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    FMassEntityQuery EntityQuery<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">UFarmProcessorBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">EntityQuery</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        bAutoRegisterWithProcessingPhases <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/// 配置 Requirement</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">ConfigureQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span>
    <span class="token punctuation">&#123;</span>
        EntityQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>FFarmWaterFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span>EMassFragmentAccess<span class="token double-colon punctuation">::</span>ReadWrite<span class="token punctuation">,</span>
            EMassFragmentPresence<span class="token double-colon punctuation">::</span>All<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/// 执行处理操作</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span>FMassEntityManager<span class="token operator">&amp;</span> EntityManager<span class="token punctuation">,</span> 
        FMassExecutionContext<span class="token operator">&amp;</span> Context<span class="token punctuation">)</span> <span class="token keyword">override</span>
    <span class="token punctuation">&#123;</span>
        EntityQuery<span class="token punctuation">.</span><span class="token function">ForEachEntityChunk</span><span class="token punctuation">(</span>EntityManager<span class="token punctuation">,</span> Context<span class="token punctuation">,</span> 
            <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>FMassExecutionContext<span class="token operator">&amp;</span> Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">const</span> <span class="token keyword">float</span> DeltaTimeSeconds <span class="token operator">=</span> Context<span class="token punctuation">.</span><span class="token function">GetDeltaTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/// 获取读写视图列表</span>
                TArrayView<span class="token operator">&lt;</span>FFarmWaterFragment<span class="token operator">></span> WaterList <span class="token operator">=</span> 
                    Context<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">GetMutableFragmentView</span><span class="token generic class-name"><span class="token operator">&lt;</span>FFarmWaterFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>FFarmWaterFragment<span class="token operator">&amp;</span> WaterFragment <span class="token operator">:</span> WaterList<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token comment">/// 修改 Fragment 数据</span>
                    WaterFragment<span class="token punctuation">.</span>CurrentWater <span class="token operator">=</span> <span class="token class-name">FMath</span><span class="token double-colon punctuation">::</span><span class="token function">Clamp</span><span class="token punctuation">(</span>WaterFragment<span class="token punctuation">.</span>CurrentWater
                        <span class="token operator">+</span> WaterFragment<span class="token punctuation">.</span>DeltaWaterPerSecond <span class="token operator">*</span> DeltaTimeSeconds<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/// 在 Actor BeginPlay 创建 Processor</span>
<span class="token keyword">void</span> <span class="token class-name">AMassEntityTestFarmPlot</span><span class="token double-colon punctuation">::</span><span class="token function">BeginPlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Processor <span class="token operator">=</span> <span class="token generic-function"><span class="token function">NewObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>UFarmWaterProcessor<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// 使用自己的 Ticker 来运行 Processor</span>
<span class="token keyword">void</span> <span class="token class-name">AMassEntityTestFarmPlot</span><span class="token double-colon punctuation">::</span><span class="token function">TickActor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    FMassProcessingContext <span class="token function">Context</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EntityManager<span class="token punctuation">,</span> DeltaTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UE<span class="token double-colon punctuation">::</span>Mass<span class="token double-colon punctuation">::</span><span class="token class-name">Executor</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Processor<span class="token punctuation">,</span> Context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 当然也可以执行一组 Processor</span>
<span class="token comment">// 定义个数组，将所有的 Processor 放到这个数组里</span>
<span class="token comment">// TArray&lt;TObjectPtr&lt;UMassProcessor>> PerFrameSystems;</span>
<span class="token keyword">void</span> <span class="token class-name">AMassEntityTestFarmPlot</span><span class="token double-colon punctuation">::</span><span class="token function">BeginPlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>PerFrameSystems<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">NewObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>UFarmWaterProcessor<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">AMassEntityTestFarmPlot</span><span class="token double-colon punctuation">::</span><span class="token function">TickActor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    FMassProcessingContext <span class="token function">Context</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>EntityManager<span class="token punctuation">,</span> DeltaTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UE<span class="token double-colon punctuation">::</span>Mass<span class="token double-colon punctuation">::</span><span class="token class-name">Executor</span><span class="token double-colon punctuation">::</span><span class="token function">RunProcessorsView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>PerFrameSystems<span class="token punctuation">,</span> Context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="note primary"><p>注意：使用 <strong>Processor</strong> 时我们创建的是 <strong>FMassProcessingContext</strong>，而 <strong>Processor</strong> 执行 <strong>Execute</strong> 时，参数是 <strong>FMassExecutionContext</strong>。</p></div><h4 id="tags-操作">Tags 操作</h4><p>下面是 <strong>Tags</strong> 的使用示例:</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">MyQuery<span class="token punctuation">.</span><span class="token function">ForEachEntityChunk</span><span class="token punctuation">(</span>EntityManager<span class="token punctuation">,</span> Context<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>FMassExecutionContext<span class="token operator">&amp;</span> Context<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/// 判断 Archetype 是否有 Tag</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">DoesArchetypeHaveTag</span><span class="token generic class-name"><span class="token operator">&lt;</span>FOptionalTag<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// I do have the FOptionalTag tag!!</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="修改-entity">修改 Entity</h4><p>当 <strong>Processor</strong> 需要对 <strong>Entity</strong> 进行修改时，要使用 <strong>Defer()</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/// 判断是不是成熟了</span>
<span class="token keyword">void</span> <span class="token class-name">UFarmHarvestTimerExpired</span><span class="token double-colon punctuation">::</span><span class="token function">ConfigureQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    EntityQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>FHarvestTimerFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span>EMassFragmentAccess<span class="token double-colon punctuation">::</span>ReadOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// 已经有 HarvestTag 的 Entity 不需要再次计算</span>
    EntityQuery<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddTagRequirement</span><span class="token generic class-name"><span class="token operator">&lt;</span>FFarmJustBecameReadyToHarvestTag<span class="token operator">></span></span></span><span class="token punctuation">(</span>
        EMassFragmentPresence<span class="token double-colon punctuation">::</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">UFarmHarvestTimerExpired</span><span class="token double-colon punctuation">::</span><span class="token function">Execute</span><span class="token punctuation">(</span>FMassEntityManager<span class="token operator">&amp;</span> EntityManager<span class="token punctuation">,</span> 
    FMassExecutionContext<span class="token operator">&amp;</span> Context<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">QUICK_SCOPE_CYCLE_COUNTER</span><span class="token punctuation">(</span>UFarmHarvestTimerExpired_Run<span class="token punctuation">)</span><span class="token punctuation">;</span>

    EntityQuery<span class="token punctuation">.</span><span class="token function">ForEachEntityChunk</span><span class="token punctuation">(</span>EntityManager<span class="token punctuation">,</span> Context<span class="token punctuation">,</span> 
        <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>FMassExecutionContext<span class="token operator">&amp;</span> Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> int32 NumEntities <span class="token operator">=</span> Context<span class="token punctuation">.</span><span class="token function">GetNumEntities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            TConstArrayView<span class="token operator">&lt;</span>FHarvestTimerFragment<span class="token operator">></span> TimerList <span class="token operator">=</span> 
                Context<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">GetFragmentView</span><span class="token generic class-name"><span class="token operator">&lt;</span>FHarvestTimerFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>int32 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NumEntities<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>TimerList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>NumSecondsLeft <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    FMassEntityHandle Handle <span class="token operator">=</span> Context<span class="token punctuation">.</span><span class="token function">GetEntity</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Context<span class="token punctuation">.</span><span class="token function">Defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddTag</span><span class="token generic class-name"><span class="token operator">&lt;</span>FFarmJustBecameReadyToHarvestTag<span class="token operator">></span></span></span><span class="token punctuation">(</span>Handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// FMassEntityHandle EntityHandle = Context.GetEntity(EntityIndex); 获取单个实例</span>
<span class="token comment">// auto EntityHandleArray = Context.GetEntities(); 获取全部实例</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="note primary"><p>使用 Context.Defer()，其实就是返回 <strong>FMassCommandBuffer</strong> 对象，通过该对象将需要的操作生成对应的操作指令，并压入 <strong>DeferredCommandBuffer</strong> ，类似 <strong>UE</strong> 中渲染管线的实现。</p></div><p>Context 还提供了一些其他的操作：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/// Fragment</span>
Context<span class="token punctuation">.</span><span class="token function">Defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddFragment</span><span class="token generic class-name"><span class="token operator">&lt;</span>FMyFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span>EntityHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
Context<span class="token punctuation">.</span><span class="token function">Defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">RemoveFragment</span><span class="token generic class-name"><span class="token operator">&lt;</span>FMyFragment<span class="token operator">></span></span></span><span class="token punctuation">(</span>EntityHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// Tag</span>
Context<span class="token punctuation">.</span><span class="token function">Defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">AddTag</span><span class="token generic class-name"><span class="token operator">&lt;</span>FMyTag<span class="token operator">></span></span></span><span class="token punctuation">(</span>EntityHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
Context<span class="token punctuation">.</span><span class="token function">Defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">RemoveTag</span><span class="token generic class-name"><span class="token operator">&lt;</span>FMyTag<span class="token operator">></span></span></span><span class="token punctuation">(</span>EntityHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
Context<span class="token punctuation">.</span><span class="token function">Defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">SwapTags</span><span class="token generic class-name"><span class="token operator">&lt;</span>FOldTag<span class="token punctuation">,</span> FNewTag<span class="token operator">></span></span></span><span class="token punctuation">(</span>EntityHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/// Destroying entities:</span>
Context<span class="token punctuation">.</span><span class="token function">Defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DestroyEntity</span><span class="token punctuation">(</span>EntityHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
Context<span class="token punctuation">.</span><span class="token function">Defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DestroyEntities</span><span class="token punctuation">(</span>EntityHandleArray<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="tag-修改">Tag 修改</h4><p>从内存布局来看，<strong>Chunk</strong> 里没有给 <strong>Tag</strong> 预留控件，那要如何实现给某个具体的 <strong>Entity</strong> 修改 <strong>Tag</strong> 的呢？</p><blockquote><p>答案是：创建了新的 <strong>Archetype</strong>。之前说过， <strong>Archetype</strong> 其实是由一组 <strong>Fragment</strong>、<strong>Tag</strong>、<strong>SharedFragment</strong>、<strong>ChunkedFragment</strong> 的组成的，不同的组成规则，得到的是不同的 <strong>Archetype</strong>，因此，<strong>Tag</strong> 的修改，其时是创建了新原型，然后把修改的 <strong>Entity</strong> 从之前的 <strong>ArchetypeData</strong> 中移动到新的原型中。</p></blockquote><h4 id="foreachentitychunk-做了啥">ForEachEntityChunk 做了啥</h4><p><strong>Processor</strong> 中的 <strong>Execute</strong> 都使用到了这个函数，那这个函数具体做了啥呢：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">FMassEntityQuery</span><span class="token double-colon punctuation">::</span><span class="token function">ForEachEntityChunk</span><span class="token punctuation">(</span>FMassEntityManager<span class="token operator">&amp;</span> EntityManager<span class="token punctuation">,</span> 
    FMassExecutionContext<span class="token operator">&amp;</span> ExecutionContext<span class="token punctuation">,</span> <span class="token keyword">const</span> FMassExecuteFunction<span class="token operator">&amp;</span> ExecuteFunction<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 是否设置了具体的 ArchetypeHandle</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ExecutionContext<span class="token punctuation">.</span><span class="token function">GetEntityCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 找到 EntityManager 下符合要求的所有 Archetype，并更新缓存</span>
        <span class="token comment">// 如果缓存不需要修改，则直接使用缓存</span>
        <span class="token function">CacheArchetypes</span><span class="token punctuation">(</span>EntityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// CacheArchetyps 会对 Fragment 排序，因此之后才能调用该函数，</span>
        <span class="token comment">// 将当前 Query 的 Requirement 设置给 Context</span>
        ExecutionContext<span class="token punctuation">.</span><span class="token function">SetFragmentRequirements</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 逐 Archetypes 遍历</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ValidArchetypes<span class="token punctuation">.</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> FMassArchetypeHandle<span class="token operator">&amp;</span> ArchetypeHandle <span class="token operator">=</span> ValidArchetypes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            FMassArchetypeData<span class="token operator">&amp;</span> ArchetypeData <span class="token operator">=</span> 
                <span class="token class-name">FMassArchetypeHelper</span><span class="token double-colon punctuation">::</span><span class="token function">ArchetypeDataFromHandleChecked</span><span class="token punctuation">(</span>ArchetypeHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>

            ArchetypeData<span class="token punctuation">.</span><span class="token function">ExecuteFunction</span><span class="token punctuation">(</span>ExecutionContext<span class="token punctuation">,</span> ExecuteFunction<span class="token punctuation">,</span> 
                ArchetypeFragmentMapping<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> ChunkCondition<span class="token punctuation">)</span><span class="token punctuation">;</span>

            ExecutionContext<span class="token punctuation">.</span><span class="token function">ClearFragmentViews</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    ExecutionContext<span class="token punctuation">.</span><span class="token function">ClearExecutionData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ExecutionContext<span class="token punctuation">.</span><span class="token function">FlushDeferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CacheArchetypes 最重要的功能是根据 Requirement 来获取满足条件的 Archetype</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// BitArray 使用 bit 位加速判断</span>
<span class="token keyword">bool</span> <span class="token function">HasAll</span><span class="token punctuation">(</span><span class="token keyword">const</span> TStructTypeBitSet<span class="token operator">&amp;</span> Other<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> StructTypesBitArray<span class="token punctuation">.</span><span class="token function">HasAll</span><span class="token punctuation">(</span>Other<span class="token punctuation">.</span>StructTypesBitArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">FMassEntityManager</span><span class="token double-colon punctuation">::</span><span class="token function">GetValidArchetypes</span><span class="token punctuation">(</span><span class="token keyword">const</span> FMassEntityQuery<span class="token operator">&amp;</span> Query<span class="token punctuation">,</span>
    TArray<span class="token operator">&lt;</span>FMassArchetypeHandle<span class="token operator">></span><span class="token operator">&amp;</span> OutValidArchetypes<span class="token punctuation">,</span> 
    <span class="token keyword">const</span> uint32 FromArchetypeDataVersion<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
    TSet<span class="token operator">&lt;</span>TSharedPtr<span class="token operator">&lt;</span>FMassArchetypeData<span class="token operator">>></span> AnyArchetypes<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> FMassFragmentRequirementDescription<span class="token operator">&amp;</span> Requirement <span class="token operator">:</span> 
        Query<span class="token punctuation">.</span><span class="token function">GetFragmentRequirements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Requirement<span class="token punctuation">.</span>Presence <span class="token operator">!=</span> EMassFragmentPresence<span class="token double-colon punctuation">::</span>None<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 将含有 Requirement 中的 Fragment、Tag 等类型 Archetype 先找出来</span>

            <span class="token comment">// FragmentTypeToArchetypeMap 加速查找</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">const</span> TArray<span class="token operator">&lt;</span>TSharedPtr<span class="token operator">&lt;</span>FMassArchetypeData<span class="token operator">>></span><span class="token operator">*</span> pData <span class="token operator">=</span>
                FragmentTypeToArchetypeMap<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>Requirement<span class="token punctuation">.</span>StructType<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                AnyArchetypes<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token operator">*</span>pData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>TSharedPtr<span class="token operator">&lt;</span>FMassArchetypeData<span class="token operator">></span><span class="token operator">&amp;</span> ArchetypePtr <span class="token operator">:</span> AnyArchetypes<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        FMassArchetypeData<span class="token operator">&amp;</span> Archetype <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>ArchetypePtr<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// EMassFragmentPresence::All</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Archetype<span class="token punctuation">.</span><span class="token function">GetFragmentBitSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasAll</span><span class="token punctuation">(</span>Query<span class="token punctuation">.</span><span class="token function">GetRequiredAllFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// missing some required fragments, skip.</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// EMassFragmentPresence::None</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Archetype<span class="token punctuation">.</span><span class="token function">GetFragmentBitSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasNone</span><span class="token punctuation">(</span>Query<span class="token punctuation">.</span><span class="token function">GetRequiredNoneFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// has some Fragments required to be absent</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// EMassFragmentPresence::Any</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Query<span class="token punctuation">.</span><span class="token function">GetRequiredAnyFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> 
            <span class="token operator">&amp;&amp;</span> Archetype<span class="token punctuation">.</span><span class="token function">GetFragmentBitSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasAny</span><span class="token punctuation">(</span>Query<span class="token punctuation">.</span><span class="token function">GetRequiredAnyFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// ... 省略 Tag、 SharedFragment、ChunkFragment 的判断</span>

        <span class="token comment">// 返回通过所有 Requirement 的原型</span>
        OutValidArchetypes<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>ArchetypePtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>找到所有符合要求的 <strong>Archetype</strong> 后，会逐个 <strong>Archetype</strong> 遍历，代码如下：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/// Archetype 遍历</span>
<span class="token keyword">void</span> <span class="token class-name">FMassArchetypeData</span><span class="token double-colon punctuation">::</span><span class="token function">ExecuteFunction</span><span class="token punctuation">(</span>FMassExecutionContext<span class="token operator">&amp;</span> RunContext<span class="token punctuation">,</span>
    <span class="token keyword">const</span> FMassExecuteFunction<span class="token operator">&amp;</span> Function<span class="token punctuation">,</span> 
    <span class="token keyword">const</span> FMassQueryRequirementIndicesMapping<span class="token operator">&amp;</span> RequirementMapping<span class="token punctuation">,</span> 
    <span class="token keyword">const</span> FMassChunkConditionFunction<span class="token operator">&amp;</span> ChunkCondition<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetNumEntities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// mz@todo to be removed</span>
    RunContext<span class="token punctuation">.</span><span class="token function">SetCurrentArchetypesTagBitSet</span><span class="token punctuation">(</span><span class="token function">GetTagBitSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// 逐 Chunk 遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>FMassArchetypeChunk<span class="token operator">&amp;</span> Chunk <span class="token operator">:</span> Chunks<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Chunk<span class="token punctuation">.</span><span class="token function">GetNumInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">/// ... </span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ChunkCondition <span class="token operator">||</span> <span class="token function">ChunkCondition</span><span class="token punctuation">(</span>RunContext<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">/// 生成 Fragment 的 ViewList</span>
                <span class="token function">BindEntityRequirements</span><span class="token punctuation">(</span>RunContext<span class="token punctuation">,</span> RequirementMapping<span class="token punctuation">.</span>EntityFragments<span class="token punctuation">,</span> 
                    Chunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Chunk<span class="token punctuation">.</span><span class="token function">GetNumInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">Function</span><span class="token punctuation">(</span>RunContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>BindEntityRequirements</strong> 的作用就是找到当前 <strong>Chunk</strong> 中对应 <strong>Requirement</strong> 中的 Fragment 对应的内存空间，然后开始执行 <strong>Processor::Excute</strong> 后面就可以通过 <strong>GetMutableFragmentView</strong> 获取对应 <strong>Fragment</strong> 数组。</p><div data-align="center"><p><img data-src="/images/ue5_mass/mass_for_chunk1.svg" width="70%" height="70%"></p></div><div class="note success"><p>上图展示了 <strong>Requirement</strong> 为 <strong>FFarmWaterFragment</strong> 执行步骤：</p><ol type="1"><li>首先找到了两个符合要求的 Archetype</li><li>然后遍历 ArchetypeCorp 中所有的 chunk，将 Context 中的是 FragmentView 绑定到对应的内存地址，然后执行 <strong>Processor::Excute</strong></li></ol></div><h2 id="参考">参考</h2><div id="ref-anchor-1"></div><p><a target="_blank" rel="noopener" href="https://www.unrealengine.com/marketplace/zh-CN/product/city-sample">1.城市示例</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/441773595">2.UE5的ECS：MASS 框架</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/561532762">3.《WorkWithUE5》CitySampleZoneGraph剖析</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/512700084">4.UE5 MassEntity简易实践</a></p><p><a target="_blank" rel="noopener" href="https://github.com/Megafunk/MassSample">5.Community Mass Sample</a></p><div><h1>推荐文章<span style="font-size:.45em;color:gray">（由<a target="_blank" rel="noopener" href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）</span></h1><ul><li><a href="https://www.xianlongok.site/post/e4cef16/">UE4 landscape 使用 Texture Array</a></li><li><a href="https://www.xianlongok.site/post/310fc368/">UE4 地形 landscape</a></li><li><a href="https://www.xianlongok.site/post/6605f9f/">UE4 反射系统</a></li><li><a target="_blank" rel="noopener" href="https://chengzhaoxi.xyz/3b10788f.html">参考字符串哈希定义数组哈希（数组的同构）</a></li></ul></div></div><footer class="post-footer"><div class="license"><div class="license-title">ue5 Mass 框架简介</div><div class="license-link"><a href="https://www.xianlongok.site/post/ea92a01c/">https://www.xianlongok.site/post/ea92a01c/</a></div><div class="license-meta"><div class="license-meta-item"><div class="license-meta-title">本文作者</div><div class="license-meta-text">小贤</div></div><div class="license-meta-item"><div class="license-meta-title">发布于</div><div class="license-meta-text">2023-04-28</div></div><div class="license-meta-item"><div class="license-meta-title">更新于</div><div class="license-meta-text">2023-04-28</div></div><div class="license-meta-item"><div class="license-meta-title">许可协议</div><div class="license-meta-text"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank">CC BY-NC-SA 4.0</a></div></div></div><div class="license-statement">转载或引用本文时，请遵守上述许可协议，注明出处、不得用于商业用途！</div></div><div class="post-tags"><a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C++</a> <a href="/tags/UE5/" rel="tag"><i class="fa fa-tag"></i> UE5</a> <a href="/tags/Mass/" rel="tag"><i class="fa fa-tag"></i> Mass</a> <a href="/tags/ECS/" rel="tag"><i class="fa fa-tag"></i> ECS</a></div><div class="post-nav"><div class="post-nav-item"><a href="/post/8dc757ea/" rel="prev" title="controlnet 使用"><i class="fa fa-chevron-left"></i> controlnet 使用</a></div><div class="post-nav-item"><a href="/post/4dab7192/" rel="next" title="物理模拟过程简介">物理模拟过程简介 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fas fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">小贤</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">267k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">4:03</span></span></div><div class="powered"><a href="https://dlzhang.com" rel="noopener" target="_blank">小贤</a>使用 <a href="https://hexo.io" rel="noopener" target="_blank">Hexo</a> <a href="https://theme-next.js.org" rel="noopener" target="_blank">NexT</a> 设计搭建</div></div></footer><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"dkLUcqHORjRdwQiwRPJMs00N-gzGzoHsz","app_key":"EhWnaex3YyY7bQysJ2SFnukE","server_url":null,"security":false}</script><script src="/js/third-party/statistics/lean-analytics.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://www.xianlongok.work","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"libUrl":"https://unpkg.com/@waline/client@v2/dist/waline.js","login":"disable","meta":["nick","mail","link"],"requiredMeta":["nick","mail"],"pageSize":5,"avatar":"mm","dark":"auto","emoji":true,"locale":{"placeholder":"请正确填写邮箱方便查收回复，评论通过审核才会显示。","admin":"站长","nick":"名称*","mail":"邮箱*","link":"网址"},"el":"#waline","comment":true,"path":"/post/ea92a01c/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>document.addEventListener("page:loaded",()=>{NexT.utils.loadComments(CONFIG.waline.el).then(()=>NexT.utils.getScript(CONFIG.waline.libUrl,{condition:window.Waline})).then(()=>Waline.init(Object.assign({},CONFIG.waline,{el:document.querySelector(CONFIG.waline.el)})))})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body></html>